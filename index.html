<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="theme-color" content="#1e293b" id="themeColorMeta">
  <meta name="description" content="MeQRはプライバシー重視のデジタル名刺アプリ。QRコードで連絡先を共有。データは端末内のみ保存。">
  <title>MeQR - デジタル名刺</title>
  <link rel="icon" href="data:,">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MeQR">
  <link rel="apple-touch-icon" href="icons/icon-192.svg">
  <script src="js/i18n.js"></script>

  <style>
    :root {
      color-scheme: light;
    }

    /* Light theme (default) */
    :root,
    [data-theme="light"] {
      --bg: #FFF4E0;
      --bg-elevated: #FFFAF2;
      --accent: #5C7A5F;
      --accent-gradient: linear-gradient(135deg, #5C7A5F 0%, #343936 100%);
      --accent-soft: rgba(92, 122, 95, 0.12);
      --accent-strong: rgba(92, 122, 95, 0.85);
      --step-done: #5C7A5F;
      --border-subtle: #E8DECE;
      --border-medium: #D6CABB;
      --text-main: #343936;
      --text-muted: #7A7060;
      --danger: #B85C38;
      --shadow-sm: 0 1px 2px 0 rgba(52, 57, 54, 0.06);
      --shadow: 0 1px 3px 0 rgba(52, 57, 54, 0.1), 0 1px 2px -1px rgba(52, 57, 54, 0.08);
      --shadow-md: 0 4px 6px -1px rgba(52, 57, 54, 0.1), 0 2px 4px -2px rgba(52, 57, 54, 0.08);
      --shadow-lg: 0 10px 15px -3px rgba(52, 57, 54, 0.12), 0 4px 6px -4px rgba(52, 57, 54, 0.08);
      --qr-dark: #343936;
      --qr-light: #FFF4E0;
    }

    /* Dark theme */
    [data-theme="dark"] {
      color-scheme: dark;
      --bg: #1E2320;
      --bg-elevated: #272D29;
      --accent: #8BAD8E;
      --accent-gradient: linear-gradient(135deg, #8BAD8E 0%, #5C7A5F 100%);
      --accent-soft: rgba(139, 173, 142, 0.15);
      --accent-strong: rgba(139, 173, 142, 0.9);
      --step-done: #8BAD8E;
      --border-subtle: #343936;
      --border-medium: #4A5249;
      --text-main: #F0EBE1;
      --text-muted: #9E9A8E;
      --danger: #E07B55;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.5), 0 1px 2px -1px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.6), 0 4px 6px -4px rgba(0, 0, 0, 0.5);
      --qr-dark: #F0EBE1;
      --qr-light: #1E2320;
    }

    [data-theme="dark"] body {
      background: linear-gradient(to bottom, #1E2320 0%, #0F1210 100%);
    }

    [data-theme="dark"] .card {
      background: #272D29;
      border-color: #343936;
    }

    [data-theme="dark"] .photo-placeholder {
      background: linear-gradient(135deg, #334155 0%, #475569 100%);
      border-color: #475569;
    }

    [data-theme="dark"] .qr-shell {
      background: #0f172a;
      border-color: #475569;
    }

    [data-theme="dark"] .qr-inner {
      background: #1e293b;
    }

    [data-theme="dark"] .brightness-tip {
      background: rgba(30, 41, 59, 0.95);
      border-color: #475569;
    }

    [data-theme="dark"] .chip {
      background: #0f172a;
      border-color: #475569;
    }

    [data-theme="dark"] .chip-strong {
      background: rgba(59, 130, 246, 0.2);
      border-color: #3b82f6;
      color: #93c5fd;
    }

    [data-theme="dark"] .badge-premium {
      background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
      color: #0f172a;
      border-color: rgba(251, 191, 36, 0.5);
    }

    [data-theme="dark"] .mode-toggle {
      background: #1e293b;
      border-color: #475569;
    }

    [data-theme="dark"] .mode-toggle button.active {
      background: #3b82f6;
    }

    [data-theme="dark"] .btn-ghost {
      background: #1e293b;
      border-color: #475569;
    }

    [data-theme="dark"] .btn-ghost:hover {
      background: #334155;
      border-color: #3b82f6;
    }

    [data-theme="dark"] .btn-primary {
      background: var(--accent-gradient);
    }

    [data-theme="dark"] .btn-primary:hover {
      opacity: 0.95;
    }

    [data-theme="dark"] .btn-secondary {
      background: #1e293b;
      border-color: #475569;
    }

    [data-theme="dark"] .btn-secondary:hover {
      background: #7f1d1d;
      border-color: #ef4444;
    }

    [data-theme="dark"] .badge-offline {
      background: #1e293b;
      border-color: #475569;
    }

    [data-theme="dark"] .input-shell input,
    [data-theme="dark"] .input-shell textarea {
      background: #0f172a;
      border-color: #475569;
      color: var(--text-main);
    }

    [data-theme="dark"] .input-shell input:focus,
    [data-theme="dark"] .input-shell textarea:focus {
      background: #1e293b;
      border-color: #3b82f6;
    }

    [data-theme="dark"] .photo-upload-label {
      background: #1e293b;
      border-color: #475569;
    }

    [data-theme="dark"] .photo-upload-label:hover {
      background: #334155;
      border-color: #3b82f6;
    }

    [data-theme="dark"] .brand-mark {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-color: #1e293b;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Noto Sans JP", sans-serif;
      background: linear-gradient(to bottom, #f0f4f8 0%, #e6ecf1 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app-root {
      width: 100%;
      max-width: 520px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: max(env(safe-area-inset-top, 0px), 20px) 20px 0;
      gap: 20px;
    }

    .app-root.has-bottom-nav {
      padding-bottom: 0;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 4px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-mark {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: linear-gradient(135deg, #5C7A5F 0%, #343936 100%);
      border: 2px solid #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-md);
    }

    .brand-mark span {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.02em;
      color: #ffffff;
    }

    .brand-text-main {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: -0.01em;
      color: var(--text-main);
    }

    .brand-text-sub {
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .mode-toggle {
      display: inline-flex;
      border-radius: 10px;
      background: #ffffff;
      padding: 4px;
      gap: 4px;
      border: 1px solid var(--border-medium);
      box-shadow: var(--shadow-sm);
    }

    .mode-toggle button {
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 500;
      padding: 7px 14px;
      border-radius: 7px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .mode-toggle button.active {
      background: var(--accent);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .mode-toggle button span.icon {
      font-size: 14px;
    }

    main {
      flex: 1;
      display: flex;
    }

    .card {
      position: relative;
      flex: 1;
      border-radius: 16px;
      padding: 24px;
      background: #ffffff;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      gap: 20px;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      gap: 16px;
      align-items: flex-start;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border-subtle);
    }

    .photo-area {
      flex-shrink: 0;
    }

    .photo-placeholder {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      background: linear-gradient(135deg, #e0e7ff 0%, #dbeafe 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      border: 2px solid var(--border-subtle);
      box-shadow: var(--shadow-sm);
    }

    #displayPhoto {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      border: 2px solid var(--border-subtle);
      box-shadow: var(--shadow-sm);
      display: none;
    }

    .id-block {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .name-main {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.01em;
      color: var(--text-main);
      line-height: 1.3;
    }

    .name-sub {
      font-size: 13px;
      color: var(--text-muted);
      letter-spacing: 0.01em;
      line-height: 1.4;
    }

    .meta-chips {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .chip {
      font-size: 10px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 6px;
      background: #f3f4f6;
      border: 1px solid var(--border-medium);
      color: var(--text-muted);
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .chip-strong {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-soft);
    }

    .badge-premium {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 6px;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #1f2937;
      border: 1px solid rgba(251, 191, 36, 0.6);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .qr-shell {
      position: relative;
      flex: 1;
      min-height: 280px;
      max-height: 360px;
      border-radius: 12px;
      background: #f9fafb;
      border: 2px dashed var(--border-medium);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: hidden;
    }

    .qr-inner {
      position: relative;
      width: 100%;
      max-width: 280px;
      aspect-ratio: 1 / 1;
      border-radius: 8px;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      box-shadow: var(--shadow);
      transition: max-width 0.3s ease;
    }

    .qr-inner.size-small {
      max-width: 200px;
    }

    .qr-inner.size-medium {
      max-width: 280px;
    }

    .qr-inner.size-large {
      max-width: 340px;
    }

    #qrcode {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .brightness-tip {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      color: var(--text-muted);
      background: rgba(255, 255, 255, 0.95);
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid var(--border-medium);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow-sm);
      max-width: 90%;
      text-align: center;
    }

    .brightness-tip span.icon {
      font-size: 13px;
    }

    .contact-meta {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-top: 16px;
      border-top: 1px solid var(--border-subtle);
    }

    .contact-meta-left {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .contact-meta-left strong {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-main);
      letter-spacing: 0.01em;
    }

    .contact-meta-left .hint {
      font-size: 12px;
      color: var(--text-muted);
    }

    .sync-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .sync-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
    }

    .btn-ghost {
      border-radius: 8px;
      padding: 8px 12px;
      border: 1px solid var(--border-medium);
      background: #ffffff;
      color: var(--text-main);
      font-size: 12px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    .btn-ghost:hover {
      background: #f9fafb;
      border-color: var(--accent);
    }

    .btn-ghost:active {
      background: #f3f4f6;
      border-color: var(--accent);
      transform: scale(0.98);
    }

    .btn-ghost span.icon {
      font-size: 14px;
    }

    /* 編集フォーム */
    .form-section {
      margin-bottom: 20px;
    }

    .form-section-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 12px;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .form-root {
      display: none;
      flex-direction: column;
      gap: 16px;
      margin-top: 8px;
    }

    .form-root.active,
    .view-section#meqr-form-section.active .form-root {
      display: flex;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .field-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-main);
      letter-spacing: 0.01em;
    }

    .field-row {
      display: flex;
      gap: 12px;
    }

    .field-row>div {
      flex: 1;
    }

    .input-shell {
      position: relative;
    }

    .input-shell input,
    .input-shell textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border-medium);
      background: #ffffff;
      color: var(--text-main);
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .input-shell input::placeholder,
    .input-shell textarea::placeholder {
      color: #9ca3af;
    }

    .input-shell input:focus,
    .input-shell textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    .input-shell.has-error input,
    .input-shell.has-error textarea {
      border-color: #dc2626;
      box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.2);
    }

    .input-shell.has-error input:focus,
    .input-shell.has-error textarea:focus {
      border-color: #dc2626;
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.25);
    }

    .field-error {
      display: block;
      font-size: 12px;
      color: #dc2626;
      margin-top: 4px;
      min-height: 1.2em;
    }

    .field-error:empty {
      display: none;
    }

    textarea {
      min-height: 52px;
      resize: vertical;
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
    }

    .footer-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      gap: 12px;
    }

    .btn-primary {
      flex: 1;
      border-radius: 10px;
      padding: 12px 16px;
      border: none;
      background: linear-gradient(135deg, #5C7A5F 0%, #343936 100%);
      color: #FFF4E0;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.01em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      box-shadow: var(--shadow-md);
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #6D8F70 0%, #4A5249 100%);
      box-shadow: var(--shadow-lg);
    }

    .btn-primary:active {
      opacity: 0.88;
      transform: scale(0.99);
    }

    .btn-primary span.icon {
      font-size: 16px;
    }

    .btn-secondary {
      border-radius: 10px;
      padding: 10px 14px;
      border: 1px solid var(--border-medium);
      background: #ffffff;
      color: var(--text-main);
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    .btn-secondary:hover {
      background: #fef2f2;
      border-color: var(--danger);
      color: var(--danger);
    }

    .btn-secondary:active {
      background: #fee2e2;
      transform: scale(0.98);
    }

    .danger-text {
      color: var(--danger);
    }

    .badge-offline {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      padding: 6px 12px;
      border-radius: 8px;
      background: #ffffff;
      border: 1px solid var(--border-medium);
      box-shadow: var(--shadow-sm);
    }

    .badge-offline .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
    }

    .dot-online {
      background: #22c55e;
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
    }

    .dot-offline {
      background: #f97373;
      box-shadow: 0 0 0 2px rgba(248, 113, 113, 0.2);
    }

    .small-print {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
      line-height: 1.5;
    }

    .photo-upload-area {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .photo-upload-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid var(--border-medium);
      background: #ffffff;
      color: var(--text-main);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    .photo-upload-label:hover {
      background: #f9fafb;
      border-color: var(--accent);
    }

    .photo-upload-label input[type="file"] {
      display: none;
    }

    /* Hamburger Menu */
    .hamburger-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: transparent;
      color: var(--text-main);
      font-size: 24px;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.2s ease;
    }

    .hamburger-btn:hover {
      background: var(--accent-soft);
    }

    .menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 2000;
      display: none;
      backdrop-filter: blur(4px);
    }

    .menu-overlay.active {
      display: block;
    }

    .menu-drawer {
      position: fixed;
      top: 0;
      right: -100%;
      width: 320px;
      max-width: 85vw;
      height: 100%;
      background: var(--bg-elevated);
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.3);
      z-index: 2001;
      transition: right 0.3s ease;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .menu-drawer.active {
      right: 0;
    }

    .menu-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .menu-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-main);
    }

    .menu-close-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    .menu-close-btn:hover {
      background: var(--accent-soft);
      color: var(--text-main);
    }

    .menu-content {
      flex: 1;
      padding: 12px 0;
    }

    .menu-item {
      padding: 14px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: background 0.2s ease;
      border-left: 3px solid transparent;
    }

    .menu-item:hover {
      background: var(--accent-soft);
      border-left-color: var(--accent);
    }

    .menu-item-icon {
      font-size: 20px;
      width: 24px;
      text-align: center;
    }

    .menu-item-text {
      flex: 1;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-main);
    }

    .menu-item-arrow {
      font-size: 12px;
      color: var(--text-muted);
    }

    .menu-divider {
      height: 1px;
      background: var(--border-subtle);
      margin: 8px 0;
    }

    .menu-section-title {
      padding: 12px 20px 8px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Mode Toggle (Improved) */
    .mode-toggle-large {
      display: flex;
      gap: 8px;
      padding: 8px;
      background: var(--bg-elevated);
      border-radius: 12px;
      border: 1px solid var(--border-medium);
      box-shadow: var(--shadow-sm);
    }

    .mode-toggle-large button {
      flex: 1;
      padding: 12px 20px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .mode-toggle-large button.active {
      background: var(--accent-gradient);
      color: white;
      box-shadow: var(--shadow-md);
    }

    .mode-toggle-large button:active {
      opacity: 0.9;
      transform: scale(0.98);
    }

    .mode-toggle-large button .icon {
      font-size: 18px;
    }

    /* ステップインジケーター（選ぶ→編集→共有・印刷） */
    .step-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 12px;
      margin: 0 16px 12px;
      background: var(--bg-elevated);
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      font-size: 12px;
    }

    .step-indicator .step-item {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-muted);
      padding: 4px 10px;
      border-radius: 6px;
    }

    .step-indicator .step-item .step-num {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--border-medium);
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 11px;
    }

    .step-indicator .step-item.active .step-num {
      background: var(--accent);
      color: white;
    }

    .step-indicator .step-item.completed .step-num {
      background: var(--step-done);
      color: white;
    }

    .step-indicator .step-item.active {
      color: var(--accent);
      font-weight: 600;
    }

    .step-indicator .step-arrow {
      color: var(--border-medium);
      font-size: 10px;
    }

    @media (max-width: 400px) {
      .step-indicator .step-item .step-label {
        display: none;
      }
    }

    /* Onboarding (swipeable 3 pages) */
    .onboarding-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      backdrop-filter: blur(6px);
    }

    .onboarding-overlay.active {
      display: flex;
    }

    .onboarding-card {
      position: relative;
      background: var(--bg-elevated);
      border-radius: 20px;
      padding: 0;
      max-width: 400px;
      width: 100%;
      max-height: 90vh;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-medium);
      overflow: hidden;
    }

    .onboarding-skip {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 2;
      padding: 8px 14px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      border-radius: 8px;
    }

    .onboarding-skip:hover {
      background: var(--accent-soft);
      color: var(--text-main);
    }

    .onboarding-slides-wrap {
      overflow: hidden;
      touch-action: pan-y pinch-zoom;
    }

    .onboarding-slides {
      display: flex;
      width: 300%;
      transition: transform 0.3s ease;
      will-change: transform;
    }

    .onboarding-slide {
      flex: 0 0 33.333%;
      width: 33.333%;
      padding: 48px 28px 28px;
      text-align: center;
      box-sizing: border-box;
    }

    .onboarding-slide-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      font-size: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--accent-soft);
      border-radius: 20px;
      color: var(--accent);
    }

    .onboarding-slide-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-main);
      margin: 0 0 12px 0;
      line-height: 1.3;
    }

    .onboarding-slide-desc {
      font-size: 14px;
      color: var(--text-muted);
      margin: 0 0 24px 0;
      line-height: 1.6;
    }

    .onboarding-slide .onboarding-btn-primary {
      margin-top: 8px;
    }

    .onboarding-indicators {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 16px 0 20px;
    }

    .onboarding-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border-medium);
      transition: background 0.2s ease;
    }

    .onboarding-dot.active {
      background: var(--accent);
      transform: scale(1.2);
    }

    /* Export modal */
    .export-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9000;
      backdrop-filter: blur(4px);
    }

    .export-modal-overlay.active {
      display: flex;
    }

    .export-modal {
      width: 100%;
      max-width: 360px;
      background: var(--bg-elevated);
      border-radius: 16px;
      padding: 20px 20px 16px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-medium);
    }

    .export-modal-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 8px;
    }

    .export-modal-desc {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .export-modal-usage {
      margin-bottom: 14px;
    }

    .export-modal-usage-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .export-usage-option {
      position: relative;
      background: var(--bg);
      border: 2px solid var(--border-subtle);
      border-radius: 10px;
      padding: 10px 12px 10px 36px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }

    .export-usage-option::before {
      content: "";
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      border: 2px solid var(--border-medium);
      border-radius: 50%;
      background: var(--bg-elevated);
      transition: border-color 0.2s, background 0.2s;
    }

    .export-usage-option:hover {
      border-color: var(--border-medium);
    }

    .export-usage-option.selected {
      border-color: var(--accent);
      background: var(--accent-soft);
    }

    .export-usage-option.selected::before {
      border-color: var(--accent);
      background: var(--accent);
      box-shadow: inset 0 0 0 3px var(--bg-elevated);
    }

    .export-usage-option .usage-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-main);
    }

    .export-usage-option .usage-desc {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .export-usage-option .usage-badge {
      font-size: 10px;
      padding: 2px 6px;
      background: var(--accent);
      color: white;
      border-radius: 4px;
      font-weight: 600;
      margin-left: 6px;
    }

    .freemium-banner {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.12) 0%, rgba(217, 119, 6, 0.08) 100%);
      border: 1px solid rgba(245, 158, 11, 0.4);
      border-radius: 10px;
      padding: 12px 14px;
      margin-bottom: 16px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 13px;
    }

    .freemium-banner .icon {
      font-size: 20px;
    }

    .freemium-banner .text {
      flex: 1;
    }

    .freemium-banner .title {
      font-weight: 600;
      color: #b45309;
    }

    .freemium-banner .desc {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    [data-theme="dark"] .freemium-banner .title {
      color: #fbbf24;
    }

    .export-modal-options {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
      margin-bottom: 12px;
    }

    .export-modal-preview {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 12px;
    }

    .export-modal-preview-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .export-modal-preview-box {
      width: 100%;
      max-width: 260px;
      aspect-ratio: 91 / 55;
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
      background: #f9fafb;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    #exportPreviewCanvas {
      width: 100%;
      height: 100%;
      display: block;
      direction: ltr;
    }

    .export-modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
    }

    .toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.9);
      color: #f9fafb;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 12px;
      display: none;
      align-items: center;
      gap: 6px;
      z-index: 9500;
      box-shadow: var(--shadow-md);
    }

    .toast.active {
      display: inline-flex;
    }

    .onboarding-btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }

    .onboarding-btn-primary {
      background: var(--accent);
      color: white;
      box-shadow: var(--shadow-md);
    }

    .onboarding-btn-primary:hover {
      background: var(--accent-strong);
      box-shadow: var(--shadow-lg);
    }

    .bc-preview {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .bc-preview-header {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .bc-preview-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .bc-preview-note {
      font-size: 11px;
      color: var(--text-muted);
    }

    .bc-preview-canvas-wrapper {
      width: 100%;
      max-width: 100%;
      aspect-ratio: 91 / 55;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: #f9fafb;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    #businessCardCanvas {
      width: 100%;
      height: 100%;
      display: block;
      direction: ltr;
    }

    /* タッチ操作: タップ領域 44px 以上 */
    .btn-ghost,
    .btn-primary,
    .btn-secondary,
    .hamburger-btn,
    .menu-close-btn,
    .onboarding-skip,
    .onboarding-btn {
      min-height: 44px;
      min-width: 44px;
    }

    .btn-ghost {
      padding: 10px 14px;
    }

    .menu-item {
      min-height: 48px;
      padding: 14px 20px;
    }

    .mode-toggle-large button {
      min-height: 44px;
    }

    .photo-upload-label {
      min-height: 44px;
    }

    /* 編集フォーム: モバイルは1カラム */
    .field-row {
      flex-direction: column;
    }

    .field-row>div {
      width: 100%;
    }

    /* モーダル: モバイルでフルスクリーン */
    @media (max-width: 599px) {
      .export-modal-overlay {
        padding: 0;
        align-items: stretch;
      }

      .export-modal {
        max-width: none;
        width: 100%;
        min-height: 100vh;
        border-radius: 0;
        border: none;
        display: flex;
        flex-direction: column;
        justify-content: safe center;
      }

      .onboarding-card {
        max-width: none;
        width: 100%;
        min-height: 100vh;
        max-height: none;
        border-radius: 0;
        border: none;
      }

      .onboarding-slide {
        padding: 56px 24px 32px;
      }
    }

    /* タブレット */
    @media (min-width: 600px) {
      .export-modal {
        max-width: 400px;
      }
    }

    @media (min-width: 768px) {
      .app-root {
        padding-top: 32px;
        padding-bottom: 36px;
      }

      .qr-shell {
        min-height: 320px;
        max-height: 380px;
      }

      /* 名刺プレビュー: タブレットで中央・適度なサイズ */
      .bc-preview-canvas-wrapper {
        max-width: 380px;
        margin-left: auto;
        margin-right: auto;
      }

      /* 編集フォーム: 2カラム */
      .field-row {
        flex-direction: row;
      }

      .field-row>div {
        width: auto;
      }
    }

    /* PC・大画面: 名刺プレビュー実寸に近いサイズ */
    @media (min-width: 1024px) {
      .bc-preview-canvas-wrapper {
        max-width: 420px;
      }

      .app-root {
        max-width: 560px;
        margin-left: auto;
        margin-right: auto;
      }
    }

    /* テンプレート選択: タブレット/PCで横並び（将来用） */
    .template-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    @media (min-width: 768px) {
      .template-list {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
      }
    }

    /* ===== テンプレートスライダー ===== */
    .template-slider-wrap {
      position: relative;
      width: 100%;
      margin-bottom: 12px;
    }

    .template-slider-track {
      display: flex;
      overflow: hidden;
      border-radius: 12px;
      border: 2px solid var(--border-subtle);
      background: var(--bg-elevated);
      aspect-ratio: 91 / 55;
      position: relative;
      cursor: pointer;
    }

    .template-slide {
      flex: 0 0 100%;
      width: 100%;
      height: 100%;
      position: relative;
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .template-slide canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .template-slide-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 20px;
      letter-spacing: 0.04em;
      pointer-events: none;
    }

    .template-slider-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--bg-elevated);
      border: 1.5px solid var(--border-medium);
      color: var(--text-main);
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      box-shadow: var(--shadow-md);
      transition: all 0.15s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .template-slider-nav:hover {
      background: var(--accent);
      color: #FFF4E0;
      border-color: var(--accent);
    }

    .template-slider-nav.prev {
      left: -16px;
    }

    .template-slider-nav.next {
      right: -16px;
    }

    .template-slider-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 4px 0;
      gap: 8px;
    }

    .template-slider-name {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-main);
      letter-spacing: 0.01em;
    }

    .template-slider-desc {
      font-size: 11px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .template-slider-dots {
      display: flex;
      gap: 5px;
      align-items: center;
      flex-shrink: 0;
    }

    .template-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--border-medium);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .template-dot.active {
      width: 18px;
      border-radius: 3px;
      background: var(--accent);
    }

    /* 既存の.template-selectorを非表示に */
    .template-selector {
      display: none !important;
    }

    /* 画面切り替え（SPA） */
    .view-section {
      display: none;
      animation: meqr-fadeIn 0.25s ease;
    }

    .view-section.active {
      display: block;
    }

    @keyframes meqr-fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    /* ボトムナビゲーション（ネイティブアプリ風・透過＋ブラー） */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 56px;
      padding-bottom: env(safe-area-inset-bottom, 0);
      background: rgba(255, 255, 255, 0.72);
      -webkit-backdrop-filter: blur(12px);
      backdrop-filter: blur(12px);
      border-top: 1px solid rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
      z-index: 100;
      box-shadow: 0 -1px 0 0 rgba(0, 0, 0, 0.06);
    }

    [data-theme="dark"] .bottom-nav {
      background: rgba(30, 41, 59, 0.85);
      border-top-color: rgba(255, 255, 255, 0.08);
    }

    .bottom-nav-btn {
      flex: 1;
      max-width: 200px;
      height: 56px;
      min-height: 56px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 11px;
      font-weight: 500;
      transition: color 0.18s ease, background 0.18s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .bottom-nav-btn .icon {
      font-size: 20px;
      line-height: 1;
    }

    .bottom-nav-btn:hover {
      color: var(--text-main);
      background: var(--accent-soft);
    }

    .bottom-nav-btn:active {
      background: rgba(37, 99, 235, 0.25);
      color: var(--accent);
    }

    .bottom-nav-btn.active {
      color: var(--accent);
      font-weight: 600;
    }

    .bottom-nav-btn.active:active {
      background: rgba(37, 99, 235, 0.3);
      opacity: 0.95;
    }

    .app-root.has-bottom-nav main {
      padding-bottom: calc(72px + env(safe-area-inset-bottom, 0px));
    }

    /* 小画面（iPhone SE 等）でボタン群の折り返しを確保 */
    .contact-meta [style*="flex-wrap"] {
      gap: 10px;
    }
  </style>
</head>

<body>
  <div class="app-root has-bottom-nav">
    <header>
      <div class="brand">
        <div class="brand-mark" aria-hidden="true">
          <span>Me</span>
        </div>
        <div>
          <div class="brand-text-main">MeQR</div>
          <div class="brand-text-sub">DIGITAL BUSINESS CARD</div>
        </div>
      </div>
      <button id="btn-hamburger" class="hamburger-btn" type="button" title="メニューを開く">
        ☰
      </button>
    </header>

    <!-- Mode Toggle (Large, Improved) -->
    <div class="mode-toggle-large" role="tablist" aria-label="モード切替">
      <button id="btn-view-mode" class="active" role="tab" aria-selected="true">
        <span class="icon">👁️</span><span>表示モード</span>
      </button>
      <button id="btn-edit-mode" role="tab" aria-selected="false">
        <span class="icon">✏️</span><span>編集モード</span>
      </button>
    </div>

    <!-- ステップフロー（名刺作成コンセプト準拠） -->
    <div class="step-indicator" id="stepIndicator" aria-label="使い方の流れ">
      <span class="step-item completed" id="step-1" data-step="1"><span class="step-num">1</span><span
          class="step-label">名刺を選ぶ</span></span>
      <span class="step-arrow" aria-hidden="true">→</span>
      <span class="step-item" id="step-2" data-step="2"><span class="step-num">2</span><span
          class="step-label">情報を編集</span></span>
      <span class="step-arrow" aria-hidden="true">→</span>
      <span class="step-item active" id="step-3" data-step="3"><span class="step-num">3</span><span
          class="step-label">共有・印刷</span></span>
    </div>

    <main>
      <div class="view-section" id="meqr-display-section" aria-label="表示画面">
        <section class="card" aria-label="デジタル名刺">
          <div class="card-header">
            <div class="photo-area">
              <img id="displayPhoto" alt="プロフィール写真" decoding="async" />
              <div class="photo-placeholder" id="photoPlaceholder">👤</div>
            </div>
            <div class="id-block">
              <div class="name-main" id="displayName">あなたの名前</div>
              <div class="name-sub" id="displayOrgRole">組織 / 役職</div>
              <div class="meta-chips">
                <span class="chip chip-strong">vCard 3.0</span>
                <span class="chip">LOCAL ONLY</span>
              </div>
            </div>
          </div>

          <div class="qr-shell" aria-label="連絡先QRコード">
            <div class="qr-inner">
              <div id="qrcode"></div>
            </div>
            <div class="brightness-tip">
              <span class="icon">🔆</span>
              <span>QRスキャン時は画面輝度を最大にすると読み取り精度が上がります。</span>
            </div>
          </div>

          <div class="contact-meta">
            <div class="contact-meta-left">
              <strong id="displayPhoneEmail">電話 / メール</strong>
              <span id="displayUrl" class="hint">URL（ポートフォリオ・SNSなど）</span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap: wrap;">
              <div class="sync-indicator">
                <span class="sync-dot"></span>
                <span id="syncStatusLabel">ローカル保存済み</span>
              </div>
              <div style="display:flex; gap:8px; flex-wrap: wrap;">
                <button id="btn-share-vcard" class="btn-ghost" type="button" title="連絡先を共有">
                  <span class="icon">📤</span>
                  <span>共有</span>
                </button>
                <button id="btn-download-qr" class="btn-ghost" type="button" title="QRコードをダウンロード">
                  <span class="icon">⬇️</span>
                  <span>QR保存</span>
                </button>
                <button id="btn-export-vcard" class="btn-ghost" type="button" title="vCardファイルをダウンロード">
                  <span class="icon">💾</span>
                  <span>.vcf</span>
                </button>
                <button id="btn-preview-vcard" class="btn-ghost" type="button" title="vCard内容を確認">
                  <span class="icon">🔎</span>
                  <span>確認</span>
                </button>
                <button id="btn-export-card" class="btn-ghost" type="button" title="名刺をPDF/PNGでダウンロード">
                  <span class="icon">📥</span>
                  <span>ダウンロード</span>
                </button>
                <button id="btn-print-png" class="btn-ghost" type="button"
                  title="名刺表示を印刷用高解像度PNGでダウンロード（91×55mm・300dpi）">
                  <span class="icon">🖨️</span>
                  <span>印刷用PNG</span>
                </button>
              </div>
            </div>
          </div>

          <div class="bc-preview" aria-label="名刺デザインプレビュー">
            <div class="bc-preview-header">
              <span class="bc-preview-title">名刺デザインプレビュー（Minimal）</span>
              <span class="bc-preview-note">※ 印刷用レイアウトの縮小イメージです</span>
            </div>
            <!-- テンプレートスライダー -->
            <div class="template-slider-wrap" id="templateSliderWrap">
              <div class="template-slider-track" id="templateSliderTrack">
                <!-- JSで動的生成 -->
              </div>
              <button class="template-slider-nav prev" id="tplPrev" aria-label="前のテンプレート">◀</button>
              <button class="template-slider-nav next" id="tplNext" aria-label="次のテンプレート">▶</button>
            </div>
            <div class="template-slider-info">
              <div>
                <div class="template-slider-name" id="tplName">Minimal</div>
                <div class="template-slider-desc" id="tplDesc">シンプル・白背景</div>
              </div>
              <div class="template-slider-dots" id="tplDots"></div>
            </div>
            <div class="bc-preview-canvas-wrapper">
              <canvas id="businessCardCanvas" aria-label="Business card preview"></canvas>
            </div>
          </div>
      </div>

      <div class="view-section" id="meqr-form-section" aria-label="編集画面">
        <section class="form-root" id="editFormSection" aria-label="連絡先編集フォーム">
          <div class="freemium-banner" id="freemiumBanner" style="display: none;">
            <span class="icon" aria-hidden="true">🔓</span>
            <div class="text">
              <div class="title">無料でプレビューまで作成できます</div>
              <div class="desc">ダウンロード時はウォーターマーク付き。Premium でクリアに。</div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section-title">基本情報</div>
            <div class="field-group photo-upload-area">
              <div class="field-label">プロフィール写真</div>
              <label class="photo-upload-label">
                <span class="icon">📷</span>
                <span>写真を選択（任意）</span>
                <input id="photoUpload" type="file" accept="image/jpeg,image/png,image/webp">
              </label>
              <div class="hint">写真のサイズは200KB以下を推奨（大きいとQRコード生成に影響する場合があります）</div>
            </div>

            <div class="field-group" id="field-group-name">
              <div class="field-row">
                <div>
                  <div class="field-label">姓 / LAST NAME</div>
                  <div class="input-shell" id="input-shell-lastName">
                    <input id="lastName" type="text" autocomplete="family-name" placeholder="山田" maxlength="50">
                  </div>
                </div>
                <div>
                  <div class="field-label">名 / FIRST NAME</div>
                  <div class="input-shell" id="input-shell-firstName">
                    <input id="firstName" type="text" autocomplete="given-name" placeholder="太郎" maxlength="50">
                  </div>
                </div>
              </div>
              <span class="field-error" id="error-name" role="alert" aria-live="polite"></span>
            </div>

            <div class="field-group">
              <div class="field-label">フリガナ（任意）</div>
              <div class="input-shell" id="input-shell-furigana">
                <input id="furigana" type="text" autocomplete="off" placeholder="ヤマダ タロウ" maxlength="50">
              </div>
              <div class="hint">名刺にふりがなとして表示されます</div>
            </div>

            <div class="field-group">
              <div class="field-row">
                <div>
                  <div class="field-label">会社名 / ORGANIZATION</div>
                  <div class="input-shell" id="input-shell-org">
                    <input id="org" type="text" autocomplete="organization" placeholder="株式会社〇〇" maxlength="100">
                  </div>
                  <span class="field-error" id="error-org" role="alert" aria-live="polite"></span>
                </div>
                <div>
                  <div class="field-label">役職 / TITLE</div>
                  <div class="input-shell" id="input-shell-title">
                    <input id="title" type="text" autocomplete="organization-title" placeholder="営業部長" maxlength="100">
                  </div>
                  <span class="field-error" id="error-title" role="alert" aria-live="polite"></span>
                </div>
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section-title">連絡先</div>
            <div class="field-group">
              <div class="field-label">電話番号</div>
              <div class="input-shell" id="input-shell-phone">
                <input id="phone" type="tel" inputmode="tel" autocomplete="tel" placeholder="090-1234-5678"
                  maxlength="20">
              </div>
              <span class="field-error" id="error-phone" role="alert" aria-live="polite"></span>
              <div class="hint">携帯番号（ハイフンありでも可）</div>
            </div>

            <div class="field-group">
              <div class="field-label">メールアドレス</div>
              <div class="input-shell" id="input-shell-email">
                <input id="email" type="email" inputmode="email" autocomplete="email" placeholder="example@example.com"
                  maxlength="60">
              </div>
              <span class="field-error" id="error-email" role="alert" aria-live="polite"></span>
            </div>

            <div class="field-group">
              <div class="field-label">URL / ウェブサイト</div>
              <div class="input-shell" id="input-shell-url">
                <input id="url" type="url" inputmode="url" autocomplete="url" placeholder="https://example.com"
                  maxlength="100">
              </div>
              <span class="field-error" id="error-url" role="alert" aria-live="polite"></span>
              <div class="hint">個人サイト、ポートフォリオなど</div>
            </div>

            <div class="field-group">
              <div class="field-label">住所（任意）</div>
              <div class="input-shell" id="input-shell-address">
                <input id="address" type="text" autocomplete="street-address" placeholder="〒100-0001 東京都千代田区…"
                  maxlength="200">
              </div>
              <span class="field-error" id="error-address" role="alert" aria-live="polite"></span>
              <div class="hint">名刺に表示されます。200文字以内</div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section-title">SNS・ソーシャルメディア（QRに含まれるのはこの3つのみ）</div>
            <div class="field-group">
              <div class="field-label">X / Instagram / LINE</div>
              <div style="display: flex; flex-direction: column; gap: 10px;">
                <div>
                  <div class="input-shell" id="input-shell-twitter"><input id="twitter" type="url" inputmode="url"
                      placeholder="X: https://x.com/yourname" maxlength="100"></div><span class="field-error"
                    id="error-twitter" role="alert" aria-live="polite"></span>
                </div>
                <div>
                  <div class="input-shell" id="input-shell-instagram"><input id="instagram" type="url" inputmode="url"
                      placeholder="Instagram: https://instagram.com/yourname" maxlength="100"></div><span
                    class="field-error" id="error-instagram" role="alert" aria-live="polite"></span>
                </div>
                <div>
                  <div class="input-shell" id="input-shell-line"><input id="line" type="url" inputmode="url"
                      placeholder="LINE: https://line.me/ti/p/〜 または LINE ID" maxlength="100"></div><span
                    class="field-error" id="error-line" role="alert" aria-live="polite"></span>
                </div>
              </div>
              <div class="hint">いずれも任意です。入力したものだけQRに含まれます。</div>
            </div>
          </div>

          <div class="footer-actions">
            <button id="btn-clear" type="button" class="btn-secondary">
              <span class="icon">🧹</span>
              <span>ローカル情報を削除</span>
            </button>
            <button id="btn-save" type="button" class="btn-primary">
              <span class="icon">💾</span>
              <span>保存してQRを更新</span>
            </button>
          </div>

          <div class="small-print">
            このアプリはサーバーに一切データを送信せず、<strong>ブラウザの localStorage のみ</strong>に保存します。
          </div>
        </section>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
        <div class="badge-offline" id="offlineBadge">
          <span class="dot dot-offline" id="offlineDot"></span>
          <span id="offlineText">オフライン未対応（初回読み込み中）</span>
        </div>
      </div>
      </section>
    </main>

    <nav class="bottom-nav" role="tablist" aria-label="画面切り替え">
      <button type="button" class="bottom-nav-btn active" id="btn-bottom-display" role="tab" aria-selected="true">
        <span class="icon">👁️</span>
        <span>表示（名刺）</span>
      </button>
      <button type="button" class="bottom-nav-btn" id="btn-bottom-edit" role="tab" aria-selected="false">
        <span class="icon">✏️</span>
        <span>編集（設定）</span>
      </button>
    </nav>
  </div>

  <!-- Hamburger Menu -->
  <div id="menu-overlay" class="menu-overlay"></div>
  <div id="menu-drawer" class="menu-drawer">
    <div class="menu-header">
      <div class="menu-title">メニュー</div>
      <button id="menu-close-btn" class="menu-close-btn">✕</button>
    </div>
    <div class="menu-content">
      <div class="menu-item" id="menu-profiles">
        <span class="menu-item-icon">📇</span>
        <span class="menu-item-text">名刺を選ぶ</span>
        <span class="menu-item-arrow">›</span>
      </div>
      <div class="menu-divider"></div>
      <div class="menu-item" id="menu-share">
        <span class="menu-item-icon">📤</span>
        <span class="menu-item-text">共有する</span>
        <span class="menu-item-arrow">›</span>
      </div>
      <div class="menu-item" id="menu-sns">
        <span class="menu-item-icon">🔗</span>
        <span class="menu-item-text">SNS・リンク設定</span>
        <span class="menu-item-arrow">›</span>
      </div>
      <div class="menu-divider"></div>
      <div class="menu-item" id="menu-settings">
        <span class="menu-item-icon">⚙️</span>
        <span class="menu-item-text">設定</span>
        <span class="menu-item-arrow">›</span>
      </div>
      <div class="menu-item" id="menu-data">
        <span class="menu-item-icon">💾</span>
        <span class="menu-item-text">データの保存・削除</span>
        <span class="menu-item-arrow">›</span>
      </div>
      <div class="menu-divider"></div>
      <div class="menu-item" id="menu-help">
        <span class="menu-item-icon">❓</span>
        <span class="menu-item-text">ヘルプ・使い方</span>
      </div>
      <div class="menu-item" id="menu-about">
        <span class="menu-item-icon">ℹ️</span>
        <span class="menu-item-text">このアプリについて</span>
      </div>
    </div>
  </div>

  <!-- Export modal -->
  <div id="exportModalOverlay" class="export-modal-overlay" aria-hidden="true">
    <div class="export-modal" role="dialog" aria-modal="true" aria-labelledby="exportModalTitle">
      <div class="export-modal-title" id="exportModalTitle">名刺をダウンロード</div>
      <div class="export-modal-desc">どこで使いますか？形式を選んで書き出します。</div>
      <div class="export-modal-usage">
        <div class="export-modal-usage-title">どこで使いますか？</div>
        <div class="export-usage-option selected" id="export-usage-printshop" data-usage="printshop" role="button"
          tabindex="0">
          <span class="usage-label">印刷会社に発注する</span><span class="usage-badge">推奨</span>
          <div class="usage-desc">ラクスル・プリントパック等に最適。PDFを選んでください。</div>
        </div>
        <div class="export-usage-option" id="export-usage-home" data-usage="home" role="button" tabindex="0">
          <span class="usage-label">自宅プリンターで印刷</span>
          <div class="usage-desc">A4用紙に印刷して切り取り。PDF推奨。</div>
        </div>
        <div class="export-usage-option" id="export-usage-sns" data-usage="sns" role="button" tabindex="0">
          <span class="usage-label">SNS・メール用</span>
          <div class="usage-desc">画像として使う場合はPNGを選んでください。</div>
        </div>
      </div>
      <div class="export-modal-options">
        <label>
          <input type="radio" name="export-format" value="pdf" checked> PDF（推奨・印刷用）
        </label>
        <label>
          <input type="radio" name="export-format" value="png"> PNG（画像ファイル）
        </label>
      </div>
      <div class="export-modal-preview">
        <div class="export-modal-preview-label">プレビュー（Minimal）</div>
        <div class="export-modal-preview-box">
          <canvas id="exportPreviewCanvas" aria-label="Export preview"></canvas>
        </div>
      </div>
      <div class="export-modal-actions">
        <button type="button" class="btn-secondary" onclick="closeExportModal()">キャンセル</button>
        <button type="button" class="btn-primary" onclick="handleExportDownload()">
          <span class="icon">📥</span>
          <span>ダウンロード</span>
        </button>
      </div>
    </div>
  </div>

  <!-- QR Download Modal -->
  <div id="qrDownloadModalOverlay" class="export-modal-overlay" aria-hidden="true">
    <div class="export-modal" role="dialog" aria-modal="true" aria-labelledby="qrDownloadModalTitle">
      <div class="export-modal-title" id="qrDownloadModalTitle">QRコードを保存</div>
      <div class="export-modal-desc">保存する形式を選んでください。</div>
      <div class="export-modal-options">
        <label>
          <input type="radio" name="qr-format" value="png" checked>
          PNG（印刷用・高解像度 1024×1024px）
        </label>
        <label>
          <input type="radio" name="qr-format" value="svg">
          SVG（編集可能・軽量）
        </label>
      </div>
      <div class="export-modal-actions">
        <button type="button" class="btn-secondary" onclick="closeQRDownloadModal()">キャンセル</button>
        <button type="button" class="btn-primary" onclick="handleQRDownload()">
          <span class="icon">⬇️</span>
          <span>保存</span>
        </button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">
    <span class="icon">✅</span>
    <span id="toastText">ダウンロードが完了しました。</span>
  </div>

  <!-- Onboarding Overlay (3-page swipeable) -->
  <div id="onboarding-overlay" class="onboarding-overlay" aria-modal="true" aria-label="ウェルカム">
    <div class="onboarding-card">
      <button type="button" id="btn-onboarding-skip" class="onboarding-skip" aria-label="スキップ">スキップ</button>
      <div id="onboarding-slides-wrap" class="onboarding-slides-wrap">
        <div id="onboarding-slides" class="onboarding-slides">
          <div class="onboarding-slide" data-page="0">
            <div class="onboarding-slide-icon" aria-hidden="true">📇</div>
            <h2 class="onboarding-slide-title">MeQR へようこそ</h2>
            <p class="onboarding-slide-desc">シンプルで安全なデジタル名刺アプリ</p>
          </div>
          <div class="onboarding-slide" data-page="1">
            <div class="onboarding-slide-icon" aria-hidden="true">🔐</div>
            <h2 class="onboarding-slide-title">プライバシー第一</h2>
            <p class="onboarding-slide-desc">あなたのデータは端末内にのみ保存。外部送信は一切なし。</p>
          </div>
          <div class="onboarding-slide" data-page="2">
            <div class="onboarding-slide-icon" aria-hidden="true">📱</div>
            <h2 class="onboarding-slide-title">さあ、始めましょう</h2>
            <p class="onboarding-slide-desc">名前とメールアドレスを入力するだけで、QRコード付き名刺が完成！</p>
            <button type="button" id="btn-onboarding-start" class="onboarding-btn onboarding-btn-primary">使ってみる</button>
          </div>
        </div>
      </div>
      <div id="onboarding-indicators" class="onboarding-indicators" role="tablist" aria-label="ページ">
        <span class="onboarding-dot active" role="tab" aria-selected="true" data-index="0"></span>
        <span class="onboarding-dot" role="tab" aria-selected="false" data-index="1"></span>
        <span class="onboarding-dot" role="tab" aria-selected="false" data-index="2"></span>
      </div>
    </div>
  </div>

  <!-- QRコード生成ライブラリ（qrcode-generator） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"
    referrerpolicy="no-referrer">
    </script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="js/i18n.js"></script>
  <script>
    (function () {
      "use strict";

      const PROFILES_KEY = "meqr_profiles_v3";
      const CURRENT_PROFILE_KEY = "meqr_current_profile";
      const THEME_KEY = "meqr_theme";
      const ONBOARDING_KEY = "meqr_onboarding_completed";
      const PREVIEW_DEBOUNCE_MS = 150;
      const MAX_PHOTO_BASE64_KB = 200;

      var DEMO_PROFILE_DATA = {
        lastName: "山田",
        firstName: "太郎",
        furigana: "ヤマダ タロウ",
        phone: "090-1234-5678",
        email: "yamada.taro@example.com",
        org: "株式会社サンプル",
        title: "営業部 マネージャー",
        url: "https://example.com",
        address: "",
        photo: "",
        twitter: "https://x.com/example",
        instagram: "https://instagram.com/example",
        line: ""
      };

      /** @type {ReturnType<typeof createQRCodeInstance> | null} */
      let qrInstance = null;
      let currentProfileId = null;
      let previewRafId = 0;
      let previewDebounceTimer = null;
      let qrDeferredDone = false;

      function createQRCodeInstance() {
        const qrContainer = document.getElementById("qrcode");
        qrContainer.innerHTML = "";
        // Ensure UTF-8 encoding for non-ASCII names.
        if (globalThis.qrcode && globalThis.qrcode.stringToBytesFuncs && globalThis.qrcode.stringToBytesFuncs["UTF-8"]) {
          globalThis.qrcode.stringToBytes = globalThis.qrcode.stringToBytesFuncs["UTF-8"];
        }

        return {
          clear() {
            qrContainer.innerHTML = "";
          },
          makeCode(text) {
            if (typeof globalThis.qrcode !== "function") {
              throw new Error("QR library (qrcode-generator) is not loaded.");
            }

            const qr = globalThis.qrcode(0, "L");
            qr.addData(String(text || ""), "Byte");
            qr.make();

            // Use CSS variables for QR colors
            const DARK = getComputedStyle(document.documentElement).getPropertyValue('--qr-dark').trim();
            const LIGHT = getComputedStyle(document.documentElement).getPropertyValue('--qr-light').trim();

            let svg = qr.createSvgTag({ cellSize: 4, margin: 1, scalable: true });
            // Replace default black/white colors to match UI.
            svg = svg
              .replace(/fill=\"white\"/g, `fill=\"${LIGHT}\"`)
              .replace(/fill=\"black\"/g, `fill=\"${DARK}\"`);

            qrContainer.innerHTML = svg;
            const svgEl = qrContainer.querySelector("svg");
            if (svgEl) {
              svgEl.setAttribute("width", "100%");
              svgEl.setAttribute("height", "100%");
              svgEl.setAttribute("preserveAspectRatio", "xMidYMid meet");
            }
          }
        };
      }

      function ensureQRReady() {
        if (qrDeferredDone) return;
        qrDeferredDone = true;
        if (!qrInstance) qrInstance = createQRCodeInstance();
        regenerateQR(loadCurrentProfile() || {});
      }

      function schedulePreviewDraw() {
        if (previewDebounceTimer) clearTimeout(previewDebounceTimer);
        previewDebounceTimer = setTimeout(function () {
          previewDebounceTimer = null;
          if (previewRafId) cancelAnimationFrame(previewRafId);
          previewRafId = requestAnimationFrame(function () {
            previewRafId = 0;
            var canvas = document.getElementById("businessCardCanvas");
            if (!canvas) return;
            // ★ 高解像度でCanvasサイズを設定（300dpi相当）
            var size = getBusinessCardPixelSize(300);
            canvas.width = size.width;
            canvas.height = size.height;
            ensureQRReady();
            var data = loadCurrentProfile() || {};
            var cardData = buildBusinessCardDataFromProfile(data);
            cardData.qrCode = getQRCodeDataURL();
            renderCurrentTemplate(canvas, cardData, isPremiumUser());
          });
        }, PREVIEW_DEBOUNCE_MS);
      }

      function setupLazyObservers() {
        var qrShell = document.querySelector(".qr-shell");
        if (qrShell && "IntersectionObserver" in window) {
          var qrObs = new IntersectionObserver(function (entries) {
            if (entries[0].isIntersecting) ensureQRReady();
          }, { rootMargin: "100px", threshold: 0.01 });
          qrObs.observe(qrShell);
        } else if (qrShell) {
          ensureQRReady();
        }
        var previewWrap = document.querySelector(".bc-preview-canvas-wrapper");
        if (previewWrap && "IntersectionObserver" in window) {
          var prevObs = new IntersectionObserver(function (entries) {
            if (entries[0].isIntersecting) schedulePreviewDraw();
          }, { rootMargin: "100px", threshold: 0.01 });
          prevObs.observe(previewWrap);
        } else if (previewWrap) {
          schedulePreviewDraw();
        }
      }

      function normalizePhone(phone) {
        if (!phone) return "";
        return phone.replace(/[^\d+]/g, "");
      }

      function escapeVCardValue(value) {
        if (!value) return "";
        return String(value)
          .replace(/\\/g, "\\\\")
          .replace(/\n/g, "\\n")
          .replace(/,/g, "\\,")
          .replace(/;/g, "\\;");
      }

      function buildVCard(data) {
        const ln = (line) => line + "\r\n";
        const lastName = data.lastName || "";
        const firstName = data.firstName || "";
        const phone = normalizePhone(data.phone || "");
        const email = data.email || "";
        const org = data.org || "";
        const title = data.title || "";
        const url = data.url || "";
        const address = data.address || "";
        const twitter = data.twitter || "";
        const instagram = data.instagram || "";
        const line = data.line || "";

        const fullName = (lastName + " " + firstName).trim() || "My Contact";

        let v = "";
        v += ln("BEGIN:VCARD");
        v += ln("VERSION:3.0");
        v += ln("N:" + escapeVCardValue(lastName) + ";" + escapeVCardValue(firstName) + ";;;");
        v += ln("FN:" + escapeVCardValue(fullName));

        if (org) v += ln("ORG:" + escapeVCardValue(org));
        if (title) v += ln("TITLE:" + escapeVCardValue(title));
        if (phone) v += ln("TEL;TYPE=CELL,VOICE:" + escapeVCardValue(phone));
        if (email) v += ln("EMAIL;TYPE=INTERNET:" + escapeVCardValue(email));
        if (address) v += ln("ADR:;;" + escapeVCardValue(address) + ";;;;");
        if (url) v += ln("URL;TYPE=HOME:" + escapeVCardValue(url));

        if (twitter) v += ln("URL;TYPE=X:" + escapeVCardValue(twitter));
        if (instagram) v += ln("URL;TYPE=INSTAGRAM:" + escapeVCardValue(instagram));
        if (line) v += ln("URL;TYPE=LINE:" + escapeVCardValue(line));

        v += ln("END:VCARD");
        return v;
      }

      // === Business Card Templates (Canvas) ===

      const PREMIUM_KEY = "meqr_premium";
      const TEMPLATE_KEY = "meqr_template";
      const DEV_SHOW_PREMIUM_TOGGLE = false;

      const TEMPLATES = [
        { id: "minimal", label: "Minimal", desc: "シンプル・白背景", icon: "⬜", premium: false, render: function (canvas, cardData, isPremium, onComplete) { renderMinimalTemplate(canvas, cardData, isPremium, onComplete); } },
        { id: "bold", label: "Bold", desc: "ダーク・インパクト重視", icon: "◼", premium: false, render: function (canvas, cardData, isPremium, onComplete) { renderBoldTemplate(canvas, cardData, isPremium, onComplete); } },
        { id: "elegant", label: "Elegant", desc: "グラデーション帯・上品", icon: "▨", premium: false, render: function (canvas, cardData, isPremium, onComplete) { renderElegantTemplate(canvas, cardData, isPremium, onComplete); } },
        { id: "flat", label: "Flat", desc: "右帯カラー・スッキリ", icon: "▐", premium: true, render: function (canvas, cardData, isPremium, onComplete) { renderFlatTemplate(canvas, cardData, isPremium, onComplete); } },
        { id: "photo", label: "Photo", desc: "左に写真・プロ仕様", icon: "🖼", premium: true, render: function (canvas, cardData, isPremium, onComplete) { renderPhotoTemplate(canvas, cardData, isPremium, onComplete); } },
        { id: "corporate", label: "Corporate", desc: "信頼感・ブルー基調", icon: "🏢", premium: true, render: function (c, d, p, cb) { renderCorporateTemplate(c, d, p, cb); } },
        { id: "nordic", label: "Nordic", desc: "北欧風・ナチュラル", icon: "🌲", premium: true, render: function (c, d, p, cb) { renderNordicTemplate(c, d, p, cb); } },
        { id: "botanical", label: "Botanical", desc: "植物・癒やし", icon: "🌿", premium: true, render: function (c, d, p, cb) { renderBotanicalTemplate(c, d, p, cb); } },
        { id: "artist", label: "Artist", desc: "個性的・大胆", icon: "🎨", premium: true, render: function (c, d, p, cb) { renderArtistTemplate(c, d, p, cb); } },
        { id: "washi", label: "Washi", desc: "和紙風・伝統", icon: "🍵", premium: true, render: function (c, d, p, cb) { renderWashiTemplate(c, d, p, cb); } }
      ];

      function getCurrentTemplateId() {
        return localStorage.getItem(TEMPLATE_KEY) || "minimal";
      }
      function setCurrentTemplateId(id) {
        localStorage.setItem(TEMPLATE_KEY, id);
      }
      function getCurrentTemplate() {
        const id = getCurrentTemplateId();
        return TEMPLATES.find(function (t) { return t.id === id; }) || TEMPLATES[0];
      }
      function renderCurrentTemplate(canvas, cardData, isPremium, onComplete) {
        const template = getCurrentTemplate();
        template.render(canvas, cardData, isPremium, onComplete);
      }

      function getPremiumState() {
        try {
          const raw = localStorage.getItem(PREMIUM_KEY);
          if (!raw) return { status: "free", expireAt: null };
          const v = JSON.parse(raw);
          if (v && (v.status === "free" || v.status === "premium")) {
            return { status: v.status, expireAt: v.expireAt || null };
          }
          if (raw === "true") return { status: "premium", expireAt: null };
          if (raw === "false") return { status: "free", expireAt: null };
        } catch (e) { }
        return { status: "free", expireAt: null };
      }

      function setPremiumState(status, expireAt) {
        const payload = { status: status === "premium" ? "premium" : "free", expireAt: expireAt || null };
        try {
          localStorage.setItem(PREMIUM_KEY, JSON.stringify(payload));
        } catch (e) {
          console.warn("MeQR: failed to save premium state", e);
        }
      }

      function isPremiumUser() {
        const state = getPremiumState();
        if (state.status !== "premium") return false;
        if (!state.expireAt) return true;
        const today = new Date().toISOString().slice(0, 10);
        if (state.expireAt >= today) return true;
        setPremiumState("free", null);
        return false;
      }

      function checkAndApplyPremiumExpiry() {
        isPremiumUser();
      }

      async function initBilling() {
        if (!window.CdvPurchase || !window.CdvPurchase.store) {
          console.log("MeQR: Billing plugin not available (web/PWA mode).");
          return;
        }
        const store = window.CdvPurchase.store;
        const PRODUCT_ID = "meqr_premium_monthly";
        try {
          await store.initialize([
            {
              id: PRODUCT_ID,
              type: window.CdvPurchase.ProductType.PAID_SUBSCRIPTION
            }
          ]);

          store.when().approved(purchase => {
            if (purchase && purchase.id === PRODUCT_ID) {
              setPremiumState("premium", null);
              showToast("Premiumが有効になりました。");
              try {
                showSettingsSubmenu();
                const canvas = document.getElementById("businessCardCanvas");
                if (canvas) {
                  const data = loadCurrentProfile() || {};
                  const cardData = buildBusinessCardDataFromProfile(data);
                  renderCurrentTemplate(canvas, cardData, true);
                }
              } catch (e) {
                console.warn("MeQR: failed to refresh UI after premium purchase", e);
              }
            }
            try {
              purchase.finish();
            } catch (e) {
              console.warn("MeQR: failed to finish purchase", e);
            }
          });

          await store.refresh();
          const restored = await restorePurchasesInternal(false);
          if (restored) {
            showToast("Premiumを復元しました");
          }
        } catch (e) {
          console.warn("MeQR: billing initialization failed", e);
        }
      }

      async function restorePurchasesInternal(silent) {
        if (!window.CdvPurchase || !window.CdvPurchase.store) {
          if (!silent) console.log("MeQR: Billing plugin not available, skip restore.");
          return false;
        }
        const store = window.CdvPurchase.store;
        const PRODUCT_ID = "meqr_premium_monthly";
        try {
          await store.refresh();
          let owned = false;
          if (typeof store.get === "function") {
            const product = store.get(PRODUCT_ID);
            owned = product && (product.owned === true || (product.purchases && product.purchases.length > 0));
          }
          if (!owned && store.products && Array.isArray(store.products)) {
            const product = store.products.find(function (p) { return p.id === PRODUCT_ID; });
            owned = product && (product.owned === true || (product.purchases && product.purchases.length > 0));
          }
          if (owned) {
            setPremiumState("premium", null);
            return true;
          }
          return false;
        } catch (e) {
          if (!silent) console.warn("MeQR: restore purchases failed (will retry on next launch)", e);
          return false;
        }
      }

      async function restorePurchases() {
        const restored = await restorePurchasesInternal(false);
        if (restored) {
          showToast("Premiumを復元しました");
          showSettingsSubmenu();
          const canvas = document.getElementById("businessCardCanvas");
          if (canvas) {
            const data = loadCurrentProfile() || {};
            const cardData = buildBusinessCardDataFromProfile(data);
            renderCurrentTemplate(canvas, cardData, true);
          }
        } else {
          const store = window.CdvPurchase && window.CdvPurchase.store;
          if (store) {
            showToast("復元する購入がありません。");
          } else {
            showToast("この環境では購入の復元はできません。");
          }
        }
      }

      async function startPremiumPurchase() {
        const PRODUCT_ID = "meqr_premium_monthly";
        if (window.CdvPurchase && window.CdvPurchase.store) {
          const store = window.CdvPurchase.store;
          try {
            await store.order(PRODUCT_ID);
            return;
          } catch (e) {
            console.warn("MeQR: purchase failed", e);
            alert("購入処理中にエラーが発生しました。しばらくしてから再度お試しください。");
            return;
          }
        }

        // Cordova/Play Billing がない環境（開発用・Web版）
        if (location.hostname === "localhost" || location.hostname === "127.0.0.1") {
          const ok = confirm("この環境では Google Play 課金を利用できません。\n\n開発テスト用として Premium を一時的に有効にしますか？");
          if (!ok) return;
          setPremiumState("premium", null);
          showSettingsSubmenu();
          const canvas = document.getElementById("businessCardCanvas");
          if (canvas) {
            const data = loadCurrentProfile() || {};
            const cardData = buildBusinessCardDataFromProfile(data);
            renderCurrentTemplate(canvas, cardData, true);
          }
          showToast("Premiumを有効化しました（テスト用）。");
        } else {
          // Web Preview Mode (Public)
          alert("Web版（プレビュー）ではPremium機能の購入はできません。\n\nアプリ版（iOS/Android）をダウンロードしてご利用ください。\n\n※Web版は機能確認用のデモ動作となります。");
        }
      }


      function togglePremiumForDev() {
        const premium = isPremiumUser();
        setPremiumState(premium ? "free" : "premium", null);
        showSettingsSubmenu();
        const canvas = document.getElementById("businessCardCanvas");
        if (canvas) {
          const data = loadCurrentProfile() || {};
          const cardData = buildBusinessCardDataFromProfile(data);
          renderCurrentTemplate(canvas, cardData, isPremiumUser());
        }
      }

      // === Freemium Guard Helpers ===

      function canCreateNewCard() {
        if (isPremiumUser()) return true;
        var profiles = getAllProfiles();
        return profiles.length < 1;
      }

      function showPremiumUpgradePrompt(reason) {
        var msg = reason + "\n\nPremiumにアップグレードすると、この機能が利用できます。\n\nアップグレードしますか？";
        if (confirm(msg)) {
          startPremiumPurchase();
        }
      }

      function requirePremiumForDownload() {
        if (isPremiumUser()) return false;
        showPremiumUpgradePrompt("名刺画像のダウンロードはPremium機能です。\n無料版ではプレビューのみご利用いただけます。");
        return true;
      }

      function drawWatermark(ctx, width, height, isPremium) {
        if (isPremium) return;
        const text = "MeQR";
        const fontSize = Math.max(24, Math.min(width, height) * 0.10);
        ctx.save();
        ctx.direction = "ltr";
        ctx.globalAlpha = 0.4;
        ctx.fillStyle = "#6b7280";
        ctx.font = `600 ${fontSize}px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(text, width / 2, height - fontSize * 1.2);
        ctx.restore();
      }

      function getBusinessCardPixelSize(dpi = 300) {
        const mmToInch = 1 / 25.4;
        const widthMm = 91;
        const heightMm = 55;
        let widthPx = Math.round(widthMm * mmToInch * dpi);
        let heightPx = Math.round(heightMm * mmToInch * dpi);
        if (widthPx < heightPx) {
          var t = widthPx; widthPx = heightPx; heightPx = t;
        }
        return { width: widthPx, height: heightPx };
      }

      function buildBusinessCardFilename(ext) {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, "0");
        const d = String(now.getDate()).padStart(2, "0");
        return `meqr_card_${y}${m}${d}.${ext}`;
      }

      // === Design Customization Logic ===
      const COLOR_PALETTE = [
        { id: 'default', color: '#000000', label: '黒' },
        { id: 'blue', color: '#3b82f6', label: '青' },
        { id: 'red', color: '#ef4444', label: '赤' },
        { id: 'green', color: '#22c55e', label: '緑' },
        { id: 'orange', color: '#f97316', label: '橙' },
        { id: 'purple', color: '#a855f7', label: '紫' },
        { id: 'navy', color: '#1e3a8a', label: '紺' },
        { id: 'brown', color: '#78350f', label: '茶' },
      ];

      function initDesignSettings() {
        const container = document.getElementById('colorSelector');
        if (container) {
          container.innerHTML = COLOR_PALETTE.map(c => `
            <button type="button" class="color-btn" data-color="${c.id}" 
              style="width:24px; height:24px; border-radius:50%; border:1px solid #ddd; background:${c.color}; cursor:pointer;"
              title="${c.label}" onclick="updateDesignSetting('colorScheme', '${c.id}')">
            </button>
          `).join('');
        }
      }

      function updateDesignSetting(key, value) {
        const profile = loadCurrentProfile();
        if (!profile) return;
        profile[key] = value;
        saveCurrentProfile(profile); // Use saveCurrentProfile to update the data object
        updateDesignUIState(profile);

        // Redraw canvas
        const canvas = document.getElementById("businessCardCanvas");
        if (canvas) {
          const cardData = buildBusinessCardDataFromProfile(profile);
          renderCurrentTemplate(canvas, cardData, isPremiumUser());
        }
      }

      function updateDesignUIState(profile) {
        // Orientation
        const isVertical = profile.orientation === 'vertical';
        document.getElementById('btn-orient-h').classList.toggle('active', !isVertical);
        document.getElementById('btn-orient-v').classList.toggle('active', isVertical);

        // Font
        const fontSel = document.getElementById('fontSelector');
        if (fontSel) fontSel.value = profile.fontFamily || 'Noto Sans JP';

        // QR Position
        document.querySelectorAll('.segment-btn-qr').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.pos === (profile.qrPosition || 'bottom-right'));
        });

        // Color
        document.querySelectorAll('.color-btn').forEach(btn => {
          const active = btn.dataset.color === (profile.colorScheme || 'default');
          btn.style.outline = active ? '2px solid var(--primary)' : 'none';
          btn.style.outlineOffset = active ? '2px' : '0';
        });
      }

      function setOrientation(val) { updateDesignSetting('orientation', val); }
      function setQrPosition(val) { updateDesignSetting('qrPosition', val); }

      function buildBusinessCardDataFromProfile(profile) {
        if (!profile) return {};
        // Add design properties
        return {
          name: (profile.lastName || "") + " " + (profile.firstName || ""),
          nameKana: profile.furigana || "",
          company: profile.org || "",
          position: profile.title || "",
          phone: profile.phone || "",
          email: profile.email || "",
          website: profile.url || "",
          address: profile.address || "",
          photo: profile.photo || "",
          sns: {
            twitter: profile.twitter || "",
            instagram: profile.instagram || "",
            line: profile.line || ""
          },
          qrCode: null, // This will be filled later by getQRCodeDataURL()
          templateId: getCurrentTemplateId(), // Use the currently selected template
          orientation: profile.orientation || 'horizontal',
          fontFamily: profile.fontFamily || 'Noto Sans JP',
          colorScheme: profile.colorScheme || 'default',
          qrPosition: profile.qrPosition || 'bottom-right'
        };
      }

      function getQRCodeDataURL() {
        var container = document.getElementById("qrcode");
        if (!container) return null;
        var svg = container.querySelector("svg");
        if (!svg) return null;
        var clone = svg.cloneNode(true);
        clone.setAttribute("width", "256");
        clone.setAttribute("height", "256");
        try {
          var s = new XMLSerializer().serializeToString(clone);
          return "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(s)));
        } catch (e) {
          return null;
        }
      }

      function renderMinimalTemplate(canvas, cardData, isPremium, onComplete) {
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        if (!ctx) return;
        if (typeof isPremium !== "boolean") isPremium = isPremiumUser();

        const width = canvas.width;
        const height = canvas.height;
        ctx.direction = "ltr";
        ctx.textBaseline = "top";
        ctx.textAlign = "left";

        try {
          // KANAKO OTA サンプル準拠：数値ルール厳守・左揃え1カラム・基準線ベース
          var DESIGN_W = 360;
          var scale = width / DESIGN_W;

          function px(v) { return Math.round(v * scale); }

          ctx.fillStyle = "#ffffff";
          ctx.fillRect(0, 0, width, height);

          var marginLeft = px(26);
          var marginRight = px(26);
          var marginTop = px(24);
          var marginBottom = px(24);
          var blockGap = px(14);
          var lineGapInBlock = px(7);
          var contactLineHeight = 1.7;
          var fontScale = 1.1;

          var qrSizePct = 0.17;
          var qrSize = Math.min(px(Math.floor(DESIGN_W * qrSizePct)), Math.floor(height * 0.32));

          var qrX, qrY;
          var pos = cardData.qrPosition || "bottom-right";

          if (pos === "bottom-right") {
            qrX = width - marginRight - qrSize;
            qrY = height - marginBottom - qrSize; // Default, will be adjusted for contact alignment later if needed
          } else if (pos === "bottom-left") {
            qrX = marginLeft;
            qrY = height - marginBottom - qrSize;
          } else if (pos === "top-right") {
            qrX = width - marginRight - qrSize;
            qrY = marginTop;
          } else { // top-left
            qrX = marginLeft;
            qrY = marginTop;
          }

          var leftContentMaxWidth = width - marginLeft - marginRight;
          // Avoid overlapping QR if it is on the same side
          if (pos === "bottom-right" || pos === "top-right") {
            leftContentMaxWidth = Math.max(px(100), width - marginRight - qrSize - marginLeft - px(14));
          } else {
            // If QR is on left, we should maybe shift content or just limit width?
            // For minimal template, content is left-aligned. If QR is bottom-left, it might overlap contact info.
            // If QR is top-left, it might overlap company/name.
            // For now, let's just limit width but keep alignment (overlapping risk accepted for custom position)
            // Or shift left margin?
            if (pos === "top-left" || pos === "bottom-left") {
              // If we want to shift text to right:
              // marginLeft += qrSize + px(14);
              // But let's stick to spec "layout choice"
            }
          }

          const font = cardData.fontFamily || "Noto Sans JP";
          const colorObj = COLOR_PALETTE.find(c => c.id === (cardData.colorScheme || 'default')) || COLOR_PALETTE[0];
          const accentColor = colorObj.color;
          const textColor = "#111111";
          const subColor = "#4b5563";

          const name = cardData.name || "";
          const nameKana = cardData.nameKana || "";
          const company = cardData.company || "";
          const position = cardData.position || "";
          const phone = cardData.phone || "";
          const email = cardData.email || "";
          const website = cardData.website || "";
          const address = cardData.address || "";

          var y = marginTop;

          // 1. 社名（最上位）
          if (company) {
            ctx.font = '500 ' + px(12 * fontScale) + 'px "' + font + '", "Noto Sans JP", system-ui, sans-serif';
            ctx.fillStyle = subColor;
            ctx.fillText(company, marginLeft, y, leftContentMaxWidth);
            y += px(15 * fontScale);
          }
          if (position) {
            ctx.font = '400 ' + px(12 * fontScale) + 'px "' + font + '", "Noto Sans JP", system-ui, sans-serif';
            ctx.fillStyle = subColor;
            ctx.fillText(position, marginLeft, y, leftContentMaxWidth);
            y += px(15 * fontScale);
          }
          y += blockGap;

          // 2. 名前（主役）
          if (name) {
            ctx.font = '600 ' + px(21 * fontScale) + 'px "' + font + '", "Noto Sans JP", system-ui, sans-serif';
            ctx.fillStyle = accentColor; // Use accent color for name in this variation, or stick to black? 
            // Original minimal was black #111111. Let's apply accent color to Name or maybe just a decorator? 
            // Spec says "Color Customization". Minimal template usually has little color. 
            // Let's use accent color for the Name to show the change clearly.
            ctx.fillStyle = (cardData.colorScheme && cardData.colorScheme !== 'default') ? accentColor : textColor;
            ctx.fillText(name, marginLeft, y, leftContentMaxWidth);
            y += px(26 * fontScale);
          }
          if (nameKana) {
            ctx.font = '400 ' + px(11 * fontScale) + 'px "' + font + '", "Noto Sans JP", system-ui, sans-serif';
            ctx.fillStyle = "#6b7280";
            ctx.fillText(nameKana, marginLeft, y, leftContentMaxWidth);
            y += px(15 * fontScale);
          }
          y += blockGap;

          // 3. 連絡先ブロック・縦中央を記録してQRと揃える
          var contactStartY = y;
          var contactFs = 12 * fontScale;
          ctx.font = '400 ' + px(contactFs) + 'px "' + font + '", "Noto Sans JP", system-ui, sans-serif';
          ctx.fillStyle = subColor;
          if (phone) {
            ctx.fillText("TEL " + phone, marginLeft, y, leftContentMaxWidth);
            y += Math.round(px(contactFs) * contactLineHeight);
          }
          if (email) {
            ctx.fillStyle = subColor;
            ctx.font = '400 ' + px(11 * fontScale) + 'px "' + font + '", "Noto Sans JP", system-ui, sans-serif';
            ctx.fillText(email, marginLeft, y, leftContentMaxWidth);
            y += Math.round(px(11 * fontScale) * contactLineHeight);
          }
          if (address) {
            ctx.fillStyle = subColor;
            ctx.font = '400 ' + px(contactFs) + 'px "' + font + '", "Noto Sans JP", system-ui, sans-serif';
            ctx.fillText(address, marginLeft, y, leftContentMaxWidth);
            y += Math.round(px(contactFs) * contactLineHeight);
          }
          if (website) {
            ctx.fillStyle = subColor;
            ctx.font = '400 ' + px(11 * fontScale) + 'px "' + font + '", "Noto Sans JP", system-ui, sans-serif';
            ctx.fillText(website, marginLeft, y, leftContentMaxWidth);
            y += Math.round(px(11 * fontScale) * contactLineHeight);
          }
          var contactEndY = y;
          var contactCenterY = (contactStartY + contactEndY) / 2;
          y += blockGap;

          // 4. 補助（SNS）・ブロック内行間 6〜8px
          const sns = cardData.sns || {};
          var snsEntries = [
            ["X", sns.twitter],
            ["Instagram", sns.instagram],
            ["LINE", sns.line]
          ].filter(function (entry) { return !!entry[1]; });
          if (snsEntries.length > 0 && y + px(13) < height - marginBottom) {
            ctx.font = '400 ' + px(10 * fontScale) + 'px "Noto Sans JP", system-ui, sans-serif';
            ctx.fillStyle = "#9ca3af";
            snsEntries.forEach(function (entry) {
              ctx.fillText(entry[0], marginLeft, y, leftContentMaxWidth);
              y += px(9);
            });
          }

          // QR：連絡先ブロックの縦中央に揃える（四隅に孤立させない）
          // The original contactCenterY is calculated before SNS block.
          // If QR is bottom-right, we want to align it with the contact block.
          // For other positions, qrX, qrY are already set based on fixed corners.

          // Adjust QR Y if it's bottom-right (classic position) to match contact center
          // Only if user explicitly chose bottom-right or didn't choose anything
          if (pos === "bottom-right") {
            var autoQrY = contactCenterY - qrSize / 2;
            qrY = Math.max(marginTop, Math.min(autoQrY, height - marginBottom - qrSize));
          } else {
            // For other positions, rely on the calculated qrY from the top switch (top-left, top-right etc)
          }

          if (cardData.qrCode) {
            var img = new Image();
            img.onload = function () {
              ctx.drawImage(img, qrX, qrY, qrSize, qrSize);
              if (typeof onComplete === "function") onComplete();
            };
            img.onerror = function () { if (typeof onComplete === "function") onComplete(); };
            img.src = cardData.qrCode;
          } else {
            if (typeof onComplete === "function") onComplete();
          }

          drawWatermark(ctx, width, height, isPremium);
        } catch (e) {
          console.error("MeQR: canvas render error", e);
          ctx.fillStyle = "#f3f4f6";
          ctx.fillRect(0, 0, width, height);
          ctx.fillStyle = "#6b7280";
          ctx.font = '14px "Noto Sans JP", sans-serif';
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText("プレビューを表示できません", width / 2, height / 2);
        }
      }

      // roundRect のポリフィル（Bold テンプレートのQRパディング描画部分で使う）
      function drawRoundRect(ctx, x, y, w, h, r) {
        ctx.beginPath();
        ctx.moveTo(x + r, y);
        ctx.lineTo(x + w - r, y);
        ctx.quadraticCurveTo(x + w, y, x + w, y + r);
        ctx.lineTo(x + w, y + h - r);
        ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
        ctx.lineTo(x + r, y + h);
        ctx.quadraticCurveTo(x, y + h, x, y + h - r);
        ctx.lineTo(x, y + r);
        ctx.quadraticCurveTo(x, y, x + r, y);
        ctx.closePath();
      }

      function measureAndEllipsis(ctx, text, maxWidth) {
        if (!text) return "";
        if (ctx.measureText(text).width <= maxWidth) return text;
        let t = text;
        while (t.length > 1 && ctx.measureText(t + "…").width > maxWidth) {
          t = t.slice(0, -1);
        }
        return t + "…";
      }

      function drawCoverImage(ctx, img, x, y, w, h) {
        const imgAspect = img.naturalWidth / img.naturalHeight;
        const boxAspect = w / h;
        let sx, sy, sw, sh;
        if (imgAspect > boxAspect) {
          sh = img.naturalHeight;
          sw = sh * boxAspect;
          sx = (img.naturalWidth - sw) / 2;
          sy = 0;
        } else {
          sw = img.naturalWidth;
          sh = sw / boxAspect;
          sx = 0;
          sy = (img.naturalHeight - sh) / 2;
        }
        ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h);
      }

      function renderBoldTemplate(canvas, cardData, isPremium, onComplete) {
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        if (!ctx) return;
        if (typeof isPremium !== "boolean") isPremium = isPremiumUser();
        const width = canvas.width;
        const height = canvas.height;
        canvas.width = width;
        canvas.height = height;
        ctx.direction = "ltr";
        ctx.textBaseline = "top";
        ctx.textAlign = "left";
        const fontStack = '"Noto Sans JP", "Hiragino Sans", "Yu Gothic", system-ui, sans-serif';
        function px(v) { return Math.round(v * (width / 400)); }
        try {
          ctx.fillStyle = "#111827";
          ctx.fillRect(0, 0, width, height);
          ctx.fillStyle = "#667eea";
          ctx.fillRect(0, 0, px(8), height);
          const lineRight = px(8);
          const marginLeft = lineRight + px(20);
          const marginRight = px(24);
          const marginBottom = px(24);
          const company = cardData.company || "";
          const name = cardData.name || "";
          const position = cardData.position || "";
          const phone = cardData.phone || "";
          const email = cardData.email || "";
          const website = cardData.website || "";
          let y = px(28);
          if (company) {
            ctx.font = "500 " + px(11) + "px " + fontStack;
            ctx.fillStyle = "#94a3b8";
            ctx.fillText(measureAndEllipsis(ctx, company, width - marginLeft - marginRight), marginLeft, y);
            y += px(14);
          }
          ctx.font = "600 " + px(28) + "px " + fontStack;
          ctx.fillStyle = "#ffffff";
          ctx.fillText(measureAndEllipsis(ctx, name, width - marginLeft - marginRight), marginLeft, y);
          y += px(32);
          if (position) {
            ctx.font = "500 " + px(14) + "px " + fontStack;
            ctx.fillStyle = "#667eea";
            ctx.fillText(measureAndEllipsis(ctx, position, width - marginLeft - marginRight), marginLeft, y);
            y += px(20);
          }
          y = height - marginBottom - px(80);
          ctx.font = "400 " + px(10) + "px " + fontStack;
          ctx.fillStyle = "#e2e8f0";
          if (phone) { ctx.fillText("TEL " + phone, marginLeft, y); y += px(14); }
          if (email) { ctx.fillText(email, marginLeft, y); y += px(14); }
          if (website) { ctx.fillText(website, marginLeft, y); }
          const qrSize = Math.min(px(120), height * 0.32);
          const qrX = width - marginRight - qrSize;
          const qrY = height - marginBottom - qrSize;
          const pad = px(6);
          ctx.fillStyle = "#ffffff";
          drawRoundRect(ctx, qrX - pad, qrY - pad, qrSize + pad * 2, qrSize + pad * 2, px(4));
          ctx.fill();
          if (cardData.qrCode) {
            const img = new Image();
            img.onload = function () {
              ctx.drawImage(img, qrX, qrY, qrSize, qrSize);
              drawWatermark(ctx, width, height, isPremium);
              if (typeof onComplete === "function") onComplete();
            };
            img.onerror = function () { drawWatermark(ctx, width, height, isPremium); if (typeof onComplete === "function") onComplete(); };
            img.src = cardData.qrCode;
          } else {
            drawWatermark(ctx, width, height, isPremium);
            if (typeof onComplete === "function") onComplete();
          }
        } catch (e) {
          console.error("MeQR: Bold template error", e);
          if (typeof onComplete === "function") onComplete();
        }
      }

      function renderElegantTemplate(canvas, cardData, isPremium, onComplete) {
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        if (!ctx) return;
        if (typeof isPremium !== "boolean") isPremium = isPremiumUser();
        const width = canvas.width;
        const height = canvas.height;
        canvas.width = width;
        canvas.height = height;
        ctx.direction = "ltr";
        ctx.textBaseline = "top";
        ctx.textAlign = "center";
        const fontStack = '"Noto Sans JP", "Hiragino Sans", "Yu Gothic", system-ui, sans-serif';
        function px(v) { return Math.round(v * (width / 400)); }
        try {
          const bandHeight = height * 0.38;
          const grad = ctx.createLinearGradient(0, 0, 0, bandHeight);
          grad.addColorStop(0, "#1e293b");
          grad.addColorStop(1, "#334155");
          ctx.fillStyle = grad;
          ctx.fillRect(0, 0, width, bandHeight);
          ctx.fillStyle = "#ffffff";
          ctx.fillRect(0, bandHeight, width, height - bandHeight);
          const nameKana = cardData.nameKana || "";
          const company = cardData.company || "";
          const name = cardData.name || "";
          let y = px(20);
          if (nameKana) {
            ctx.font = "400 " + px(10) + "px " + fontStack;
            ctx.fillStyle = "rgba(255,255,255,0.9)";
            ctx.fillText(nameKana, width / 2, y);
            y += px(14);
          }
          if (company) {
            ctx.font = "500 " + px(13) + "px " + fontStack;
            ctx.fillStyle = "#ffffff";
            ctx.fillText(measureAndEllipsis(ctx, company, width - px(40)), width / 2, y);
            y += px(18);
          }
          ctx.font = "600 " + px(26) + "px " + fontStack;
          ctx.fillStyle = "#ffffff";
          ctx.fillText(measureAndEllipsis(ctx, name, width - px(40)), width / 2, y);
          ctx.strokeStyle = "#e5e7eb";
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(0, bandHeight);
          ctx.lineTo(width, bandHeight);
          ctx.stroke();
          const leftColX = px(28);
          const rightColX = width / 2 + px(12);
          const rowH = px(22);
          let contactY = bandHeight + px(24);
          ctx.textAlign = "left";
          ctx.font = "400 " + px(11) + "px " + fontStack;
          ctx.fillStyle = "#374151";
          const phone = cardData.phone || "";
          const email = cardData.email || "";
          if (phone) { ctx.fillText("TEL " + phone, leftColX, contactY); contactY += rowH; }
          if (email) { ctx.fillText(email, leftColX, contactY); contactY += rowH; }
          contactY = bandHeight + px(24);
          const website = cardData.website || "";
          const address = cardData.address || "";
          const urlText = measureAndEllipsis(ctx, website, width / 2 - rightColX - px(20));
          ctx.fillText(urlText, rightColX, contactY); contactY += rowH;
          ctx.fillText(measureAndEllipsis(ctx, address, width / 2 - rightColX - px(20)), rightColX, contactY);
          const qrSize = Math.floor(height * 0.28);
          const qrX = width - px(24) - qrSize;
          const qrY = height - px(24) - qrSize;
          if (cardData.qrCode) {
            const img = new Image();
            img.onload = function () {
              ctx.drawImage(img, qrX, qrY, qrSize, qrSize);
              drawWatermark(ctx, width, height, isPremium);
              if (typeof onComplete === "function") onComplete();
            };
            img.onerror = function () { drawWatermark(ctx, width, height, isPremium); if (typeof onComplete === "function") onComplete(); };
            img.src = cardData.qrCode;
          } else {
            drawWatermark(ctx, width, height, isPremium);
            if (typeof onComplete === "function") onComplete();
          }
        } catch (e) {
          console.error("MeQR: Elegant template error", e);
          if (typeof onComplete === "function") onComplete();
        }
      }

      function renderFlatTemplate(canvas, cardData, isPremium, onComplete) {
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        if (!ctx) return;
        if (typeof isPremium !== "boolean") isPremium = isPremiumUser();
        const width = canvas.width;
        const height = canvas.height;
        canvas.width = width;
        canvas.height = height;
        ctx.direction = "ltr";
        ctx.textBaseline = "top";
        ctx.textAlign = "left";
        const fontStack = '"Noto Sans JP", "Hiragino Sans", "Yu Gothic", system-ui, sans-serif';
        function px(v) { return Math.round(v * (width / 400)); }
        try {
          const bandWidth = width * 0.08;
          const contentWidth = width - bandWidth;
          ctx.fillStyle = "#ffffff";
          ctx.fillRect(0, 0, contentWidth, height);
          ctx.fillStyle = "#2563eb";
          ctx.fillRect(contentWidth, 0, bandWidth, height);
          const marginLeft = px(24);
          const marginRight = px(24);
          let y = px(28);
          ctx.font = "600 " + px(24) + "px " + fontStack;
          ctx.fillStyle = "#111827";
          ctx.fillText(measureAndEllipsis(ctx, cardData.name || "", contentWidth - marginLeft - marginRight), marginLeft, y);
          y += px(28);
          const company = cardData.company || "";
          const position = cardData.position || "";
          const subLine = [company, position].filter(Boolean).join(" ／ ");
          if (subLine) {
            ctx.font = "400 " + px(11) + "px " + fontStack;
            ctx.fillStyle = "#6b7280";
            ctx.fillText(measureAndEllipsis(ctx, subLine, contentWidth - marginLeft - marginRight), marginLeft, y);
            y += px(20);
          }
          const dotR = px(3);
          const lineH = px(18);
          ctx.fillStyle = "#2563eb";
          const phone = cardData.phone || "";
          const email = cardData.email || "";
          const website = cardData.website || "";
          if (phone) { ctx.beginPath(); ctx.arc(marginLeft + dotR, y + lineH / 2, dotR, 0, Math.PI * 2); ctx.fill(); ctx.fillStyle = "#374151"; ctx.font = "400 " + px(11) + "px " + fontStack; ctx.fillText(phone, marginLeft + px(14), y); y += lineH; ctx.fillStyle = "#2563eb"; }
          if (email) { ctx.beginPath(); ctx.arc(marginLeft + dotR, y + lineH / 2, dotR, 0, Math.PI * 2); ctx.fill(); ctx.fillStyle = "#374151"; ctx.font = "400 " + px(11) + "px " + fontStack; ctx.fillText(measureAndEllipsis(ctx, email, contentWidth - marginLeft - px(40)), marginLeft + px(14), y); y += lineH; ctx.fillStyle = "#2563eb"; }
          if (website) { ctx.beginPath(); ctx.arc(marginLeft + dotR, y + lineH / 2, dotR, 0, Math.PI * 2); ctx.fill(); ctx.fillStyle = "#374151"; ctx.font = "400 " + px(11) + "px " + fontStack; ctx.fillText(measureAndEllipsis(ctx, website, contentWidth - marginLeft - px(40)), marginLeft + px(14), y); }
          const qrPadding = px(10);
          const qrMaxInBand = Math.max(0, bandWidth - qrPadding * 2);
          let qrSize = Math.min(qrMaxInBand, height * 0.35);
          let qrX = contentWidth - qrSize - qrPadding;
          if (qrSize < px(40)) {
            qrSize = Math.min(px(140), height * 0.28);
            qrX = contentWidth - qrSize - px(10);
          }
          const qrY = (height - qrSize) / 2;
          if (cardData.qrCode) {
            const img = new Image();
            img.onload = function () {
              ctx.drawImage(img, qrX, qrY, qrSize, qrSize);
              drawWatermark(ctx, width, height, isPremium);
              if (typeof onComplete === "function") onComplete();
            };
            img.onerror = function () { drawWatermark(ctx, width, height, isPremium); if (typeof onComplete === "function") onComplete(); };
            img.src = cardData.qrCode;
          } else {
            drawWatermark(ctx, width, height, isPremium);
            if (typeof onComplete === "function") onComplete();
          }
        } catch (e) {
          console.error("MeQR: Flat template error", e);
          if (typeof onComplete === "function") onComplete();
        }
      }

      function renderPhotoTemplate(canvas, cardData, isPremium, onComplete) {
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        if (!ctx) return;
        if (typeof isPremium !== "boolean") isPremium = isPremiumUser();

        // Standard setup from original code
        const width = canvas.width;
        const height = canvas.height;
        canvas.width = width;
        canvas.height = height;
        ctx.direction = "ltr";
        ctx.textBaseline = "top";
        ctx.textAlign = "left";

        const fontStack = '"Noto Sans JP", "Hiragino Sans", "Yu Gothic", system-ui, sans-serif';
        function px(v) { return Math.round(v * (width / 400)); }
        try {
          const photoW = width * 0.35;
          ctx.fillStyle = "#1e293b";
          ctx.fillRect(0, 0, photoW, height);
          const photoImg = cardData.photo;
          if (photoImg) {
            const img = new Image();
            img.onload = function () {
              drawCoverImage(ctx, img, 0, 0, photoW, height);
              ctx.fillStyle = "rgba(0,0,0,0.25)";
              ctx.fillRect(0, 0, photoW, height);
              drawPhotoRightSide();
              if (cardData.qrCode) drawQRPhoto(); else { drawWatermark(ctx, width, height, isPremium); if (typeof onComplete === "function") onComplete(); }
            };
            img.onerror = function () { drawPhotoRightSide(); if (cardData.qrCode) drawQRPhoto(); else { drawWatermark(ctx, width, height, isPremium); if (typeof onComplete === "function") onComplete(); } };
            img.src = photoImg;
          } else {
            ctx.font = "400 " + px(40) + "px " + fontStack;
            ctx.fillStyle = "#ffffff";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("👤", photoW / 2, height / 2);
            ctx.textAlign = "left";
            ctx.textBaseline = "top";
            drawPhotoRightSide();
            if (cardData.qrCode) drawQRPhoto(); else { drawWatermark(ctx, width, height, isPremium); if (typeof onComplete === "function") onComplete(); }
          }
          function drawPhotoRightSide() {
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(photoW, 0, width - photoW, height);
            const left = photoW + px(24);
            const maxW = width - left - px(24);
            let y = px(28);
            ctx.textAlign = "left";
            ctx.textBaseline = "top";
            ctx.font = "600 " + px(22) + "px " + fontStack;
            ctx.fillStyle = "#111827";
            ctx.fillText(measureAndEllipsis(ctx, cardData.name || "", maxW), left, y);
            y += px(26);
            ctx.font = "500 " + px(14) + "px " + fontStack;
            ctx.fillStyle = "#667eea";
            if (cardData.position) { ctx.fillText(measureAndEllipsis(ctx, cardData.position, maxW), left, y); y += px(20); }
            ctx.font = "400 " + px(11) + "px " + fontStack;
            ctx.fillStyle = "#4b5563";
            if (cardData.company) { ctx.fillText(measureAndEllipsis(ctx, cardData.company, maxW), left, y); y += px(18); }
            y += px(8);
            ctx.strokeStyle = "#e5e7eb";
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(left, y);
            ctx.lineTo(width - px(24), y);
            ctx.stroke();
            y += px(16);
            ctx.fillStyle = "#374151";
            ctx.font = "400 " + px(10) + "px " + fontStack;
            if (cardData.phone) { ctx.fillText("TEL " + cardData.phone, left, y); y += px(16); }
            if (cardData.email) { ctx.fillText(measureAndEllipsis(ctx, cardData.email, maxW), left, y); y += px(16); }
            if (cardData.website) { ctx.fillText(measureAndEllipsis(ctx, cardData.website, maxW), left, y); }
          }
          function drawQRPhoto() {
            const qrSize = Math.min(px(100), height * 0.22);
            const qrX = width - px(24) - qrSize;
            const qrY = height - px(24) - qrSize;
            const img = new Image();
            img.onload = function () {
              ctx.drawImage(img, qrX, qrY, qrSize, qrSize);
              drawWatermark(ctx, width, height, isPremium);
              if (typeof onComplete === "function") onComplete();
            };
            img.onerror = function () { drawWatermark(ctx, width, height, isPremium); if (typeof onComplete === "function") onComplete(); };
            img.src = cardData.qrCode;
          }
        } catch (e) {
          console.error("MeQR: Photo template error", e);
          if (typeof onComplete === "function") onComplete();
        }
      }


      // === New Templates ===

      function renderCorporateTemplate(canvas, cardData, isPremium, onComplete) {
        renderBaseTemplate(canvas, cardData, isPremium, onComplete, {
          type: 'corporate',
          drawBg: (ctx, w, h, color) => {
            ctx.fillStyle = "#f8f9fa"; ctx.fillRect(0, 0, w, h);
            ctx.fillStyle = color; ctx.fillRect(0, h * 0.85, w, h * 0.15); // Bottom bar
            ctx.fillRect(0, 0, w, h * 0.02); // Top thin bar
          },
          layout: 'standard'
        });
      }

      function renderNordicTemplate(canvas, cardData, isPremium, onComplete) {
        renderBaseTemplate(canvas, cardData, isPremium, onComplete, {
          type: 'nordic',
          drawBg: (ctx, w, h, color) => {
            ctx.fillStyle = "#faf9f6"; ctx.fillRect(0, 0, w, h); // Off-white
            // Geometric shapes
            ctx.fillStyle = color; ctx.globalAlpha = 0.2;
            ctx.beginPath(); ctx.arc(w * 0.9, h * 0.2, h * 0.4, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = color; ctx.globalAlpha = 0.1;
            ctx.beginPath(); ctx.moveTo(0, h); ctx.lineTo(w * 0.3, h); ctx.lineTo(0, h * 0.6); ctx.fill();
            ctx.globalAlpha = 1.0;
          },
          layout: 'centered'
        });
      }

      function renderBotanicalTemplate(canvas, cardData, isPremium, onComplete) {
        renderBaseTemplate(canvas, cardData, isPremium, onComplete, {
          type: 'botanical',
          drawBg: (ctx, w, h, color) => {
            ctx.fillStyle = "#f0fdf4"; ctx.fillRect(0, 0, w, h);
            // Simple leaf-like shapes
            ctx.fillStyle = "#4ade80"; ctx.globalAlpha = 0.2;
            ctx.beginPath(); ctx.ellipse(w * 0.1, h * 0.1, w * 0.15, h * 0.1, Math.PI / 4, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(w * 0.95, h * 0.9, w * 0.15, h * 0.1, Math.PI / 4, 0, Math.PI * 2); ctx.fill();
            ctx.globalAlpha = 1.0;
          },
          layout: 'standard'
        });
      }

      function renderArtistTemplate(canvas, cardData, isPremium, onComplete) {
        renderBaseTemplate(canvas, cardData, isPremium, onComplete, {
          type: 'artist',
          drawBg: (ctx, w, h, color) => {
            ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, w, h);
            ctx.fillStyle = color;
            // Splash effect
            ctx.beginPath(); ctx.arc(w * 0.5, h * 0.5, h * 0.4, 0, Math.PI * 2); ctx.fill();
            ctx.globalCompositeOperation = 'destination-out';
            ctx.beginPath(); ctx.arc(w * 0.5, h * 0.5, h * 0.35, 0, Math.PI * 2); ctx.fill();
            ctx.globalCompositeOperation = 'source-over';
          },
          layout: 'centered',
          fontStyle: 'bold'
        });
      }

      function renderWashiTemplate(canvas, cardData, isPremium, onComplete) {
        renderBaseTemplate(canvas, cardData, isPremium, onComplete, {
          type: 'washi',
          drawBg: (ctx, w, h, color) => {
            ctx.fillStyle = "#f5f5f4"; ctx.fillRect(0, 0, w, h);
            // Noise texture simulated
            for (let i = 0; i < 500; i++) {
              ctx.fillStyle = Math.random() > 0.5 ? "#e7e5e4" : "#ffffff";
              ctx.fillRect(Math.random() * w, Math.random() * h, 2, 2);
            }
            // Vertical line
            ctx.strokeStyle = color; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(w * 0.8, h * 0.1); ctx.lineTo(w * 0.8, h * 0.9); ctx.stroke();
          },
          layout: 'vertical-text'
        });
      }

      // Helper for new templates
      function renderBaseTemplate(canvas, cardData, isPremium, onComplete, options) {
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        if (!ctx) return;

        const width = canvas.width;
        const height = canvas.height;
        const DESIGN_W = 360;
        const scale = width / DESIGN_W;
        function px(v) { return Math.round(v * scale); }

        // Defaults
        const font = cardData.fontFamily || "Noto Sans JP";
        const colorObj = COLOR_PALETTE.find(c => c.id === (cardData.colorScheme || 'default')) || COLOR_PALETTE[0];
        const accentColor = colorObj.color;

        // 1. Background
        if (options.drawBg) options.drawBg(ctx, width, height, accentColor);
        else { ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, width, height); }

        // 2. Content Layout
        ctx.textBaseline = "top";
        const margin = px(26);
        let y = px(24);
        const leftMaxWidth = width - margin * 2;

        const drawText = (text, size, weight, color, x, y, align = 'left') => {
          if (!text) return 0;
          ctx.font = `${weight} ${px(size)}px "${font}", "Noto Sans JP", sans-serif`;
          ctx.fillStyle = color;
          ctx.textAlign = align;
          ctx.fillText(text, x, y, leftMaxWidth);
          return px(size * 1.5);
        };

        if (options.layout === 'centered') {
          const cx = width / 2;
          y += drawText(cardData.company, 12, 500, "#666", cx, y, 'center');
          y += drawText(cardData.position, 11, 400, "#666", cx, y, 'center');
          y += px(10);
          y += drawText((cardData.name || "") + " " + (cardData.nameKana || ""), 18, 700, "#000", cx, y, 'center');
          y += px(20);
          drawText(cardData.email, 11, 400, "#444", cx, y, 'center'); y += px(14);
          drawText(cardData.phone, 11, 400, "#444", cx, y, 'center'); y += px(14);
          drawText(cardData.address, 10, 400, "#444", cx, y, 'center');
        } else if (options.layout === 'vertical-text') {
          const rx = width - margin - px(40);
          y = margin;
          drawText(cardData.company, 11, 400, "#666", rx, y, 'right'); y += px(14);
          drawText(cardData.position, 10, 400, "#666", rx, y, 'right'); y += px(20);
          drawText(cardData.name, 18, 700, "#000", rx, y, 'right'); y += px(30);
          let ly = height - margin - px(60);
          drawText(cardData.phone, 10, 400, "#444", margin, ly); ly += px(12);
          drawText(cardData.email, 10, 400, "#444", margin, ly); ly += px(12);
          drawText(cardData.address, 9, 400, "#444", margin, ly);
        } else {
          y += drawText(cardData.company, 11, 500, accentColor, margin, y);
          y += drawText(cardData.position, 10, 400, "#666", margin, y);
          y += px(10);
          drawText(cardData.name, 18, 700, "#000", margin, y);
          y += px(25);
          drawText(cardData.phone, 11, 400, "#444", margin, y); y += px(14);
          drawText(cardData.email, 11, 400, "#444", margin, y); y += px(14);
          drawText(cardData.address, 10, 400, "#444", margin, y);
        }

        // QR Code
        if (cardData.qrCode) {
          const qrSize = px(60);
          let qx, qy;
          const pos = cardData.qrPosition || 'bottom-right';
          if (pos === 'bottom-right') { qx = width - margin - qrSize; qy = height - margin - qrSize; }
          else if (pos === 'bottom-left') { qx = margin; qy = height - margin - qrSize; }
          else if (pos === 'top-right') { qx = width - margin - qrSize; qy = margin; }
          else { qx = margin; qy = margin; }

          const img = new Image();
          img.onload = () => {
            ctx.drawImage(img, qx, qy, qrSize, qrSize);
            if (onComplete) onComplete();
          };
          img.onerror = () => { if (onComplete) onComplete(); };
          img.src = cardData.qrCode;
        } else {
          if (onComplete) onComplete();
        }

        drawWatermark(ctx, width, height, isPremium);
      }

      async function exportBusinessCardAsPDF() {
        if (requirePremiumForDownload()) return;
        try {
          if (!window.jspdf || !window.jspdf.jsPDF) {
            alert("PDFライブラリの読み込みに失敗しました。ネットワーク接続を確認してください。");
            return;
          }
          ensureQRReady();
          var canvas = document.createElement("canvas");
          var data = loadCurrentProfile() || {};
          var cardData = buildBusinessCardDataFromProfile(data);
          cardData.qrCode = getQRCodeDataURL();
          renderCurrentTemplate(canvas, cardData, isPremiumUser(), function () {
            var img = canvas.toDataURL("image/png", 1.0);
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF({
              orientation: "landscape",
              unit: "mm",
              format: [91, 55],
              compress: true
            });
            doc.addImage(img, "PNG", 0, 0, 91, 55);
            doc.save(buildBusinessCardFilename("pdf"));
          });
        } catch (e) {
          console.error("MeQR: failed to export business card PDF", e);
          alert("名刺のPDF書き出しに失敗しました。\n\nブラウザや接続環境を確認し、もう一度お試しください。");
        }
      }

      async function exportBusinessCardAsPNG() {
        if (requirePremiumForDownload()) return;
        try {
          ensureQRReady();
          var canvas = document.createElement("canvas");
          var data = loadCurrentProfile() || {};
          var cardData = buildBusinessCardDataFromProfile(data);
          cardData.qrCode = getQRCodeDataURL();
          var filename = buildBusinessCardFilename("png");
          renderCurrentTemplate(canvas, cardData, isPremiumUser(), function () {
            canvas.toBlob(
              function (blob) {
                if (!blob) {
                  alert("名刺のPNG書き出しに失敗しました。もう一度お試しください。");
                  return;
                }
                try {
                  var url = URL.createObjectURL(blob);
                  var a = document.createElement("a");
                  a.href = url;
                  a.download = filename;
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
                  URL.revokeObjectURL(url);
                } catch (err) {
                  console.error("MeQR: PNG download failed", err);
                  alert("ダウンロードの開始に失敗しました。ポップアップがブロックされていないか確認してください。");
                }
              },
              "image/png",
              0.9
            );
          });
        } catch (e) {
          console.error("MeQR: failed to export business card PNG", e);
          alert("名刺のPNG書き出しに失敗しました。\n\nもう一度お試しください。");
        }
      }

      function downloadDisplaySectionAsPrintPNG() {
        if (requirePremiumForDownload()) return;
        var data = loadCurrentProfile();
        if (!data || (!data.lastName && !data.firstName && !data.email && !data.org)) {
          alert("名刺情報がありません。先に編集画面で名前などを入力して保存してください。");
          return;
        }
        ensureQRReady();
        var size = getBusinessCardPixelSize(300);
        var canvas = document.createElement("canvas");
        canvas.width = size.width;
        canvas.height = size.height;
        var cardData = buildBusinessCardDataFromProfile(data);
        cardData.qrCode = getQRCodeDataURL();
        renderCurrentTemplate(canvas, cardData, isPremiumUser(), function () {
          canvas.toBlob(
            function (blob) {
              if (!blob) {
                alert("印刷用PNGの生成に失敗しました。もう一度お試しください。");
                return;
              }
              try {
                var url = URL.createObjectURL(blob);
                var a = document.createElement("a");
                a.href = url;
                a.download = buildBusinessCardFilename("png").replace(".png", "_print.png");
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast("印刷用PNGをダウンロードしました（91×55mm・300dpi）");
              } catch (err) {
                console.error("MeQR: print PNG download failed", err);
                alert("ダウンロードの開始に失敗しました。");
              }
            },
            "image/png",
            1.0
          );
        });
      }

      function openExportModal() {
        const overlay = document.getElementById("exportModalOverlay");
        if (!overlay) return;

        var radios = overlay.querySelectorAll('input[name="export-format"]');
        radios.forEach(function (r) { r.checked = r.value === "pdf"; });

        var opts = overlay.querySelectorAll(".export-usage-option");
        opts.forEach(function (o) {
          o.classList.remove("selected");
          if (o.getAttribute("data-usage") === "printshop") o.classList.add("selected");
        });

        overlay.classList.add("active");
        overlay.setAttribute("aria-hidden", "false");

        var previewCanvas = document.getElementById("exportPreviewCanvas");
        if (previewCanvas && "requestAnimationFrame" in window) {
          ensureQRReady();
          requestAnimationFrame(function () {
            var data = loadCurrentProfile() || {};
            var cardData = buildBusinessCardDataFromProfile(data);
            cardData.qrCode = getQRCodeDataURL();
            var ctx = previewCanvas.getContext("2d");
            if (ctx) {
              var size = getBusinessCardPixelSize(150);
              previewCanvas.width = size.width;
              previewCanvas.height = size.height;
            }
            renderCurrentTemplate(previewCanvas, cardData, isPremiumUser());
          });
        }
      }

      function closeExportModal() {
        const overlay = document.getElementById("exportModalOverlay");
        if (!overlay) return;
        overlay.classList.remove("active");
        overlay.setAttribute("aria-hidden", "true");
      }

      async function handleExportDownload() {
        const overlay = document.getElementById("exportModalOverlay");
        if (!overlay) return;
        const radios = overlay.querySelectorAll('input[name="export-format"]');
        let format = "pdf";
        radios.forEach(r => {
          if (r.checked) format = r.value;
        });

        if (format === "png") {
          await exportBusinessCardAsPNG();
        } else {
          await exportBusinessCardAsPDF();
        }

        closeExportModal();
        showToast("名刺のダウンロードを開始しました。");
      }

      function showToast(message) {
        const toast = document.getElementById("toast");
        const text = document.getElementById("toastText");
        if (!toast || !text) return;
        text.textContent = message;
        toast.classList.add("active");
        setTimeout(() => {
          toast.classList.remove("active");
        }, 2500);
      }

      // === Profile Management Functions ===

      function getAllProfiles() {
        try {
          const raw = localStorage.getItem(PROFILES_KEY);
          if (!raw) return [];
          return JSON.parse(raw);
        } catch (e) {
          console.error("Failed to load profiles", e);
          return [];
        }
      }

      function saveAllProfiles(profiles) {
        try {
          localStorage.setItem(PROFILES_KEY, JSON.stringify(profiles));
        } catch (e) {
          console.error("Failed to save profiles", e);
          if (e && e.name === "QuotaExceededError") {
            alert("保存容量が不足しています。\n\n不要な名刺を削除するか、ブラウザの保存データを整理してから再度お試しください。");
          } else {
            alert("プロファイルの保存に失敗しました。しばらくしてから再度お試しください。");
          }
        }
      }

      function getCurrentProfileId() {
        if (currentProfileId) return currentProfileId;
        const saved = localStorage.getItem(CURRENT_PROFILE_KEY);
        return saved || null;
      }

      function setCurrentProfileId(id) {
        currentProfileId = id;
        localStorage.setItem(CURRENT_PROFILE_KEY, id);
      }

      function createNewProfile(name = "新しい名刺") {
        const profiles = getAllProfiles();
        const newProfile = {
          id: Date.now().toString(),
          name: name,
          data: {
            lastName: "",
            firstName: "",
            phone: "",
            email: "",
            org: "",
            title: "",
            url: "",
            address: "",
            photo: "",
            furigana: "",
            twitter: "",
            instagram: "",
            line: "",
            // Default design settings
            orientation: 'horizontal',
            fontFamily: 'Noto Sans JP',
            colorScheme: 'default',
            qrPosition: 'bottom-right'
          },
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        profiles.push(newProfile);
        saveAllProfiles(profiles);
        return newProfile;
      }

      function loadCurrentProfile() {
        const profiles = getAllProfiles();
        if (profiles.length === 0) {
          // Create default profile
          const defaultProfile = createNewProfile("メイン名刺");
          setCurrentProfileId(defaultProfile.id);
          setSyncStatus("empty");
          return defaultProfile.data;
        }

        let profileId = getCurrentProfileId();
        let profile = profiles.find(p => p.id === profileId);

        if (!profile) {
          profile = profiles[0];
          setCurrentProfileId(profile.id);
        }

        setSyncStatus("saved");
        return profile.data;
      }

      function saveCurrentProfile(data) {
        const profiles = getAllProfiles();
        const profileId = getCurrentProfileId();

        const profileIndex = profiles.findIndex(p => p.id === profileId);
        if (profileIndex === -1) {
          console.error("Current profile not found");
          return;
        }

        profiles[profileIndex].data = data;
        profiles[profileIndex].updatedAt = new Date().toISOString();
        saveAllProfiles(profiles);
        setSyncStatus("saved");
      }

      function switchProfile(profileId) {
        const profiles = getAllProfiles();
        const profile = profiles.find(p => p.id === profileId);
        if (!profile) {
          alert("名刺が見つかりません。");
          return;
        }

        setCurrentProfileId(profileId);
        fillDisplay(profile.data);
        fillForm(profile.data);
        regenerateQR(profile.data);
        schedulePreviewDraw();
        updateProfileSelector();
      }

      function loadDemoDataForScreenshots() {
        var profiles = getAllProfiles();
        var profileId = getCurrentProfileId();
        var profile = profiles.find(function (p) { return p.id === profileId; });
        if (!profile) {
          profile = profiles[0];
          if (!profile) return;
        }
        profile.data = Object.assign({}, profile.data || {}, DEMO_PROFILE_DATA);
        profile.updatedAt = new Date().toISOString();
        saveAllProfiles(profiles);
        fillDisplay(profile.data);
        fillForm(profile.data);
        ensureQRReady();
        regenerateQR(profile.data);
        schedulePreviewDraw();
        updateProfileSelector();
        closeMenu();
        switchMode("view");
        if (typeof showToast === "function") showToast("スクリーンショット用のデモデータを読み込みました。");
      }

      function deleteProfile(profileId) {
        const profiles = getAllProfiles();
        if (profiles.length <= 1) {
          alert("最後の名刺は削除できません。");
          return;
        }

        const index = profiles.findIndex(p => p.id === profileId);
        if (index === -1) return;

        const confirmDelete = confirm(`「${profiles[index].name}」を削除しますか？この操作は取り消せません。`);
        if (!confirmDelete) return;

        profiles.splice(index, 1);
        saveAllProfiles(profiles);

        // Switch to first profile if current was deleted
        if (profileId === getCurrentProfileId()) {
          switchProfile(profiles[0].id);
        }

        updateProfileSelector();
      }

      function renameProfile(profileId, newName) {
        const profiles = getAllProfiles();
        const profile = profiles.find(p => p.id === profileId);
        if (!profile) return;

        profile.name = newName;
        profile.updatedAt = new Date().toISOString();
        saveAllProfiles(profiles);
        updateProfileSelector();
      }

      // Legacy compatibility: migrate old data
      function migrateOldData() {
        const OLD_KEY = "meqr_contact_v2";
        const oldData = localStorage.getItem(OLD_KEY);
        if (!oldData) return;

        try {
          const parsed = JSON.parse(oldData);
          const profiles = getAllProfiles();
          if (profiles.length === 0) {
            const migratedProfile = createNewProfile("メインプロファイル");
            migratedProfile.data = parsed;
            saveAllProfiles([migratedProfile]);
            setCurrentProfileId(migratedProfile.id);
          }
          localStorage.removeItem(OLD_KEY);
        } catch (e) {
          console.error("Migration failed", e);
        }
      }

      function cleanupLocalStorage() {
        try {
          var obsolete = ["meqr_contact_v2", "meqr_contact_v1"];
          obsolete.forEach(function (key) {
            try { localStorage.removeItem(key); } catch (e) { }
          });
        } catch (e) { }
      }

      var tplCurrentIndex = 0;
      // オフスクリーンcanvasキャッシュ
      var tplCanvasCache = {};

      function initTemplateSlider() {
        const track = document.getElementById('templateSliderTrack');
        const dots = document.getElementById('tplDots');
        if (!track || !dots) return;

        // 現在のテンプレートIDからインデックスを設定
        const currentId = getCurrentTemplateId();
        tplCurrentIndex = Math.max(0, TEMPLATES.findIndex(t => t.id === currentId));

        // スライドを生成
        track.innerHTML = '';
        dots.innerHTML = '';

        TEMPLATES.forEach(function (template, i) {
          // スライド
          const slide = document.createElement('div');
          slide.className = 'template-slide';
          slide.dataset.index = i;

          const canvas = document.createElement('canvas');
          canvas.style.width = '100%';
          canvas.style.height = '100%';
          slide.appendChild(canvas);
          tplCanvasCache[template.id] = canvas;

          if (template.premium) {
            const badge = document.createElement('div');
            badge.className = 'template-slide-badge';
            badge.textContent = 'PRO';
            slide.appendChild(badge);
          }

          slide.addEventListener('click', function () {
            onTemplateSelect(template.id);
          });

          track.appendChild(slide);

          // ドット
          const dot = document.createElement('div');
          dot.className = 'template-dot' + (i === tplCurrentIndex ? ' active' : '');
          dot.dataset.index = i;
          dot.addEventListener('click', function () {
            goToSlide(parseInt(this.dataset.index));
          });
          dots.appendChild(dot);
        });

        // ナビボタン
        const prevBtn = document.getElementById('tplPrev');
        const nextBtn = document.getElementById('tplNext');
        if (prevBtn) prevBtn.onclick = function () { goToSlide(tplCurrentIndex - 1); };
        if (nextBtn) nextBtn.onclick = function () { goToSlide(tplCurrentIndex + 1); };

        // タッチスワイプ
        let touchStartX = 0;
        track.addEventListener('touchstart', function (e) {
          touchStartX = e.touches[0].clientX;
        }, { passive: true });
        track.addEventListener('touchend', function (e) {
          const dx = e.changedTouches[0].clientX - touchStartX;
          if (Math.abs(dx) > 40) {
            goToSlide(tplCurrentIndex + (dx < 0 ? 1 : -1));
          }
        }, { passive: true });

        goToSlide(tplCurrentIndex, false);
        renderAllTemplateSlides();
      }

      function goToSlide(index, animate) {
        const n = TEMPLATES.length;
        index = Math.max(0, Math.min(n - 1, index));
        tplCurrentIndex = index;

        const track = document.getElementById('templateSliderTrack');
        if (track) {
          const slides = track.querySelectorAll('.template-slide');
          slides.forEach(function (slide, i) {
            slide.style.transform = 'translateX(' + ((i - index) * 100) + '%)';
            slide.style.transition = animate === false ? 'none' : 'transform 0.35s cubic-bezier(0.4, 0, 0.2, 1)';
          });
        }

        // ドット更新
        const dots = document.querySelectorAll('.template-dot');
        dots.forEach(function (dot, i) {
          dot.classList.toggle('active', i === index);
        });

        // 名前・説明更新
        const tpl = TEMPLATES[index];
        var nameEl = document.getElementById('tplName');
        var descEl = document.getElementById('tplDesc');
        if (nameEl) nameEl.textContent = tpl.label + (tpl.premium ? ' ✦' : '');
        if (descEl) descEl.textContent = tpl.desc;

        // bc-preview-titleも更新
        var titleEl = document.querySelector('.bc-preview-title');
        if (titleEl) titleEl.textContent = '名刺デザインプレビュー（' + tpl.label + '）';
      }

      function renderAllTemplateSlides() {
        // すべてのテンプレートをオフスクリーンでプレビュー描画
        var profileData = loadCurrentProfile() || {};
        var cardData = buildBusinessCardDataFromProfile(profileData);
        cardData.qrCode = getQRCodeDataURL();

        TEMPLATES.forEach(function (template) {
          var canvas = tplCanvasCache[template.id];
          if (!canvas) return;
          var size = getBusinessCardPixelSize(300);
          canvas.width = size.width;
          canvas.height = size.height;
          try {
            template.render(canvas, cardData, isPremiumUser(), null);
          } catch (e) {
            console.warn('Template render failed:', template.id, e);
          }
        });
      }

      function onTemplateSelect(templateId) {
        const template = TEMPLATES.find(function (t) { return t.id === templateId; });
        if (!template) return;

        if (template.premium && !isPremiumUser()) {
          showToast('「' + template.label + '」はPremiumテンプレートです。ダウンロード時はウォーターマーク付きになります。');
        }

        setCurrentTemplateId(templateId);

        // メインプレビューCanvasを更新
        var canvas = document.getElementById('businessCardCanvas');
        if (canvas) {
          var size = getBusinessCardPixelSize(300);
          canvas.width = size.width;
          canvas.height = size.height;
          ensureQRReady();
          var data = loadCurrentProfile() || {};
          var cardData = buildBusinessCardDataFromProfile(data);
          cardData.qrCode = getQRCodeDataURL();
          renderCurrentTemplate(canvas, cardData, isPremiumUser());
        }
      }

      function setSyncStatus(state) {
        const label = document.getElementById("syncStatusLabel");
        if (!label) return;
        switch (state) {
          case "saved":
            label.textContent = "ローカル保存済み";
            break;
          case "empty":
            label.textContent = "未設定（編集から登録）";
            break;
          case "error":
            label.textContent = "保存エラー";
            break;
          default:
            label.textContent = "";
        }
      }

      function fillDisplay(data) {
        const displayName = document.getElementById("displayName");
        const displayOrgRole = document.getElementById("displayOrgRole");
        const displayPhoneEmail = document.getElementById("displayPhoneEmail");
        const displayUrl = document.getElementById("displayUrl");
        const displayPhoto = document.getElementById("displayPhoto");
        const photoPlaceholder = document.getElementById("photoPlaceholder");

        const lastName = data.lastName || "";
        const firstName = data.firstName || "";
        const phone = data.phone || "";
        const email = data.email || "";
        const org = data.org || "";
        const title = data.title || "";
        const url = data.url || "";
        const photo = data.photo || "";

        displayName.textContent = (lastName + " " + firstName).trim() || "あなたの名前";

        const orgRoleParts = [];
        if (org) orgRoleParts.push(org);
        if (title) orgRoleParts.push(title);
        displayOrgRole.textContent = orgRoleParts.join(" / ") || "組織 / 役職";

        const contactParts = [];
        if (phone) contactParts.push(phone);
        if (email) contactParts.push(email);
        displayPhoneEmail.textContent = contactParts.join(" / ") || "電話 / メール";

        displayUrl.textContent = url || "URL（ポートフォリオ・SNSなど）";

        // Display photo
        if (photo && displayPhoto && photoPlaceholder) {
          displayPhoto.src = photo;
          displayPhoto.style.display = "block";
          photoPlaceholder.style.display = "none";
        } else if (displayPhoto && photoPlaceholder) {
          displayPhoto.src = "";
          displayPhoto.style.display = "none";
          photoPlaceholder.style.display = "flex";
        }
      }

      function fillForm(data) {
        document.getElementById("lastName").value = data.lastName || "";
        document.getElementById("firstName").value = data.firstName || "";
        var furiganaEl = document.getElementById("furigana");
        if (furiganaEl) furiganaEl.value = data.furigana || "";
        document.getElementById("phone").value = data.phone || "";
        document.getElementById("email").value = data.email || "";
        document.getElementById("org").value = data.org || "";
        document.getElementById("title").value = data.title || "";
        document.getElementById("url").value = data.url || "";
        var addressEl = document.getElementById("address");
        if (addressEl) addressEl.value = data.address || "";

        // SNS fields (if they exist in DOM)
        const twitterInput = document.getElementById("twitter");
        const instagramInput = document.getElementById("instagram");
        const lineInput = document.getElementById("line");
        if (twitterInput) twitterInput.value = data.twitter || "";
        if (instagramInput) instagramInput.value = data.instagram || "";
        if (lineInput) lineInput.value = data.line || "";

        // Design settings are handled by updateDesignUIState called from loadProfileForm
      }

      // === バリデーション・エラー表示 ===
      const LIMIT = { name: 50, orgTitle: 100, address: 200, url: 100 };
      const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const PHONE_REGEX = /^[0-9\-+\s()]*$/;
      const URL_PREFIX = /^https?:\/\//i;

      function validateEmail(v) {
        if (!v) return { valid: true };
        if (!EMAIL_REGEX.test(v)) return { valid: false, message: "メールアドレスの形式が正しくありません。" };
        return { valid: true };
      }

      function validatePhone(v) {
        if (!v) return { valid: true };
        if (!PHONE_REGEX.test(v)) return { valid: false, message: "電話番号は数字とハイフンのみ入力できます。" };
        return { valid: true };
      }

      function validateUrl(v, fieldLabel) {
        if (!v) return { valid: true };
        if (!URL_PREFIX.test(v)) return { valid: false, message: "URLは http:// または https:// で始めてください。" };
        if (v.length > LIMIT.url) return { valid: false, message: "URLは" + LIMIT.url + "文字以内で入力してください。" };
        return { valid: true };
      }

      function validateForm(data) {
        const errors = [];
        const lastName = (data.lastName || "").trim();
        const firstName = (data.firstName || "").trim();
        const fullNameLen = (lastName + " " + firstName).trim().length;

        if (!lastName && !firstName) {
          errors.push({ field: "name", message: "名前を入力してください。（姓または名のどちらか必須）" });
        } else if (fullNameLen > LIMIT.name) {
          errors.push({ field: "name", message: "名前は合計" + LIMIT.name + "文字以内で入力してください。" });
        }

        const phone = (data.phone || "").trim();
        const email = (data.email || "").trim();
        if (!phone && !email) {
          var contactMsg = "メールアドレスまたは電話番号の少なくとも1つを入力してください。";
          errors.push({ field: "phone", message: contactMsg });
          errors.push({ field: "email", message: contactMsg });
        } else {
          var r = validatePhone(phone);
          if (!r.valid) errors.push({ field: "phone", message: r.message });
          r = validateEmail(email);
          if (!r.valid) errors.push({ field: "email", message: r.message });
        }

        var r = validateUrl(data.url || "", "URL");
        if (!r.valid) errors.push({ field: "url", message: r.message });

        const org = (data.org || "").trim();
        if (org.length > LIMIT.orgTitle) errors.push({ field: "org", message: "会社名は" + LIMIT.orgTitle + "文字以内で入力してください。" });
        const title = (data.title || "").trim();
        if (title.length > LIMIT.orgTitle) errors.push({ field: "title", message: "役職は" + LIMIT.orgTitle + "文字以内で入力してください。" });

        var addressStr = (data.address || "").trim();
        if (addressStr.length > LIMIT.address) errors.push({ field: "address", message: "住所は" + LIMIT.address + "文字以内で入力してください。" });

        ["twitter", "instagram", "line"].forEach(function (key) {
          var res = validateUrl(data[key] || "", key);
          if (!res.valid) errors.push({ field: key, message: res.message });
        });

        return { valid: errors.length === 0, errors: errors };
      }

      function showFieldError(fieldId, message) {
        var el = document.getElementById("error-" + fieldId);
        var shell = document.getElementById("input-shell-" + fieldId);
        if (el) el.textContent = message || "";
        if (shell) shell.classList.toggle("has-error", !!message);
        if (fieldId === "name") {
          var shellL = document.getElementById("input-shell-lastName");
          var shellF = document.getElementById("input-shell-firstName");
          if (shellL) shellL.classList.toggle("has-error", !!message);
          if (shellF) shellF.classList.toggle("has-error", !!message);
        }
      }

      function clearAllErrors() {
        var ids = ["name", "phone", "email", "org", "title", "url", "furigana", "address", "twitter", "instagram", "line"];
        ids.forEach(function (id) {
          showFieldError(id, "");
        });
      }

      function runRealtimeValidation() {
        var data = readForm();
        var result = validateForm(data);
        result.errors.forEach(function (e) {
          if (e.message) showFieldError(e.field, e.message);
        });
        var shown = {};
        result.errors.forEach(function (e) {
          if (e.message && !shown[e.field]) { shown[e.field] = true; }
        });
        ["name", "phone", "email", "org", "title", "url", "furigana", "address", "twitter", "instagram", "line"].forEach(function (id) {
          if (!shown[id]) showFieldError(id, "");
        });
      }

      function readForm() {
        const currentData = loadCurrentProfile() || {};

        const twitterInput = document.getElementById("twitter");
        const instagramInput = document.getElementById("instagram");
        const lineInput = document.getElementById("line");
        var furiganaEl = document.getElementById("furigana");
        var addressEl = document.getElementById("address");
        return {
          lastName: document.getElementById("lastName").value.trim(),
          firstName: document.getElementById("firstName").value.trim(),
          furigana: furiganaEl ? furiganaEl.value.trim() : "",
          phone: document.getElementById("phone").value.trim(),
          email: document.getElementById("email").value.trim(),
          org: document.getElementById("org").value.trim(),
          title: document.getElementById("title").value.trim(),
          url: document.getElementById("url").value.trim(),
          address: addressEl ? addressEl.value.trim() : "",
          photo: currentData.photo || "",
          twitter: twitterInput ? twitterInput.value.trim() : "",
          instagram: instagramInput ? instagramInput.value.trim() : "",
          line: lineInput ? lineInput.value.trim() : ""
        };
      }

      function regenerateQR(data) {
        if (!qrInstance) {
          qrInstance = createQRCodeInstance();
        }
        const vcardText = buildVCard(data);
        qrInstance.clear();
        try {
          // Primary: try vCard
          qrInstance.makeCode(vcardText);
        } catch (err) {
          console.warn("vCard QR generation failed, attempting MECARD fallback:", err);
          // Fallback: use MECARD (shorter) to reduce data size
          try {
            const mecard = buildMECARD(data);
            qrInstance.makeCode(mecard);
            alert("vCard が大きすぎたため、短縮形式（MECARD）で QR を生成しました。表示やインポート時に一部情報が異なる場合があります。");
          } catch (err2) {
            console.error("MECARD fallback also failed:", err2);
            alert("QR を生成できませんでした。入力内容を短くしてください。");
          }
        }
      }

      function buildMECARD(data) {
        // MECARD is more compact than full vCard and widely supported by scanners
        const escape = (s) => (s || "").replace(/[:;\\,]/g, "\\$&");
        const fullName = ((data.lastName || "") + " " + (data.firstName || "")).trim();
        const parts = [];
        if (fullName) parts.push("N:" + escape(fullName));
        if (data.org) parts.push("ORG:" + escape(data.org));
        if (data.phone) parts.push("TEL:" + escape(normalizePhone(data.phone)));
        if (data.email) parts.push("EMAIL:" + escape(data.email));
        if (data.url) parts.push("URL:" + escape(data.url));
        // MECARD format: MECARD:...;;
        return "MECARD:" + parts.join(";") + ";;";
      }

      function updateStepIndicator(mode) {
        var s1 = document.getElementById("step-1");
        var s2 = document.getElementById("step-2");
        var s3 = document.getElementById("step-3");
        if (!s1 || !s2 || !s3) return;
        [s1, s2, s3].forEach(function (el) {
          el.classList.remove("active", "completed");
          el.querySelector(".step-num").textContent = el.getAttribute("data-step");
        });
        s1.classList.add("completed");
        s1.querySelector(".step-num").textContent = "✓";
        if (mode === "edit") {
          s2.classList.add("active");
        } else {
          s3.classList.add("active");
        }
      }

      function switchView(viewName) {
        const isDisplay = viewName === "display";
        const displaySection = document.getElementById("meqr-display-section");
        const formSection = document.getElementById("meqr-form-section");
        const viewBtn = document.getElementById("btn-view-mode");
        const editBtn = document.getElementById("btn-edit-mode");
        const bottomDisplay = document.getElementById("btn-bottom-display");
        const bottomEdit = document.getElementById("btn-bottom-edit");

        if (displaySection) displaySection.classList.toggle("active", isDisplay);
        if (formSection) formSection.classList.toggle("active", !isDisplay);

        function setActive(btn, active) {
          if (!btn) return;
          btn.classList.toggle("active", active);
          btn.setAttribute("aria-selected", active ? "true" : "false");
        }
        setActive(viewBtn, isDisplay);
        setActive(editBtn, !isDisplay);
        setActive(bottomDisplay, isDisplay);
        setActive(bottomEdit, !isDisplay);

        if (isDisplay) {
          ensureQRReady();
          schedulePreviewDraw();
          var banner = document.getElementById("freemiumBanner");
          if (banner) banner.style.display = "none";
        } else {
          var banner = document.getElementById("freemiumBanner");
          if (banner) banner.style.display = isPremiumUser() ? "none" : "flex";
        }
        updateStepIndicator(isDisplay ? "view" : "edit");
      }

      function switchMode(mode) {
        switchView(mode === "view" ? "display" : "form");
      }

      function setupOfflineBadge() {
        const offlineBadge = document.getElementById("offlineBadge");
        const offlineDot = document.getElementById("offlineDot");
        const offlineText = document.getElementById("offlineText");

        function setStatus(ready) {
          if (ready) {
            offlineDot.classList.remove("dot-offline");
            offlineDot.classList.add("dot-online");
            offlineText.textContent = "オフライン起動対応済み";
          } else {
            offlineDot.classList.remove("dot-online");
            offlineDot.classList.add("dot-offline");
            offlineText.textContent = "オフライン未対応（初回読み込み中）";
          }
        }

        if (!("serviceWorker" in navigator)) {
          offlineText.textContent = "このブラウザはオフライン PWA に未対応です";
          return;
        }

        setStatus(false);

        navigator.serviceWorker.ready
          .then(() => setStatus(true))
          .catch(() => setStatus(false));
      }

      function previewVCard(data) {
        const vcard = buildVCard(data);
        const pretty = vcard.replace(/\r\n/g, "\n");
        alert("現在の vCard 文字列（UTF-8）:\n\n" + pretty);
      }

      function exportVCard(data) {
        const vcard = buildVCard(data);
        const blob = new Blob([vcard], { type: "text/vcard;charset=utf-8" });
        const url = URL.createObjectURL(blob);

        const lastName = data.lastName || "contact";
        const firstName = data.firstName || "";
        const filename = `${lastName}_${firstName}`.trim().replace(/\s+/g, "_") + ".vcf";

        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      async function shareVCard(data) {
        const vcard = buildVCard(data);
        const blob = new Blob([vcard], { type: "text/vcard;charset=utf-8" });
        const lastName = data.lastName || "contact";
        const firstName = data.firstName || "";
        const fullName = (lastName + " " + firstName).trim() || "連絡先";
        const filename = fullName.replace(/\s+/g, "_") + ".vcf";
        const file = new File([blob], filename, { type: "text/vcard" });

        if (!navigator.share) {
          exportVCard(data);
          alert('この環境では共有ダイアログが出ません。vCardファイルをダウンロードしました。メールやチャットに添付して送れます。');
          return;
        }

        try {
          if (navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({
              title: '連絡先を共有',
              text: fullName + 'の連絡先',
              files: [file]
            });
          } else {
            await navigator.share({
              title: '連絡先を共有',
              text: fullName + 'の連絡先です。vCardファイルはアプリ内「💾 .vcf」またはメニュー「ファイルで保存」からダウンロードできます。'
            });
            exportVCard(data);
          }
        } catch (err) {
          if (err.name !== 'AbortError') {
            console.error('Share failed:', err);
            alert('共有に失敗しました。代わりにダウンロードします。');
            exportVCard(data);
          }
        }
      }

      function downloadQRCodeAsSVG(data) {
        const qrSvg = document.querySelector('#qrcode svg');
        if (!qrSvg) {
          alert('QRコードが生成されていません。');
          return;
        }

        // Clone SVG to avoid modifying the displayed one
        const svgClone = qrSvg.cloneNode(true);

        // Set explicit dimensions for better compatibility
        svgClone.setAttribute('width', '512');
        svgClone.setAttribute('height', '512');

        const svgData = new XMLSerializer().serializeToString(svgClone);
        const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(blob);

        const lastName = data.lastName || "contact";
        const firstName = data.firstName || "";
        const filename = `${lastName}_${firstName}_QR`.trim().replace(/\s+/g, "_") + ".svg";

        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function downloadQRCodeAsPNG(data) {
        const qrSvg = document.querySelector('#qrcode svg');
        if (!qrSvg) {
          alert('QRコードが生成されていません。');
          return;
        }

        // Create a canvas to convert SVG to PNG
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const size = 1024; // High resolution for printing
        canvas.width = size;
        canvas.height = size;

        // Create an image from SVG
        const svgClone = qrSvg.cloneNode(true);
        svgClone.setAttribute('width', size);
        svgClone.setAttribute('height', size);

        const svgData = new XMLSerializer().serializeToString(svgClone);
        const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(svgBlob);

        const img = new Image();
        img.onload = function () {
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, size, size);
          ctx.drawImage(img, 0, 0, size, size);

          canvas.toBlob(function (blob) {
            const pngUrl = URL.createObjectURL(blob);

            const lastName = data.lastName || "contact";
            const firstName = data.firstName || "";
            const filename = `${lastName}_${firstName}_QR`.trim().replace(/\s+/g, "_") + ".png";

            const a = document.createElement('a');
            a.href = pngUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(pngUrl);
            URL.revokeObjectURL(url);
          }, 'image/png');
        };
        img.onerror = function () {
          alert('QRコードの画像変換に失敗しました。');
          URL.revokeObjectURL(url);
        };
        img.src = url;
      }

      // QRダウンロードモーダルを開く
      function openQRDownloadModal() {
        const overlay = document.getElementById("qrDownloadModalOverlay");
        if (!overlay) return;
        overlay.classList.add("active");
        overlay.setAttribute("aria-hidden", "false");
      }

      // QRダウンロードモーダルを閉じる
      window.closeQRDownloadModal = function () {
        const overlay = document.getElementById("qrDownloadModalOverlay");
        if (!overlay) return;
        overlay.classList.remove("active");
        overlay.setAttribute("aria-hidden", "true");
      };

      // QRダウンロード実行
      window.handleQRDownload = function () {
        const overlay = document.getElementById("qrDownloadModalOverlay");
        if (!overlay) return;
        const selected = overlay.querySelector('input[name="qr-format"]:checked');
        const format = selected ? selected.value : "png";
        const data = loadCurrentProfile();
        if (!data) return;
        if (format === "svg") {
          downloadQRCodeAsSVG(data);
        } else {
          downloadQRCodeAsPNG(data);
        }
        closeQRDownloadModal();
        showToast("QRコードを保存しました。");
      };

      function downloadQRCode(data) {
        openQRDownloadModal();
      }

      function initTheme() {
        const savedTheme = localStorage.getItem(THEME_KEY) || "dark";
        applyTheme(savedTheme);
      }

      function applyTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem(THEME_KEY, theme);

        const themeIcon = document.getElementById("themeIcon");
        const themeColorMeta = document.getElementById("themeColorMeta");

        if (themeIcon) {
          themeIcon.textContent = theme === "dark" ? "☀️" : "🌙";
        }

        if (themeColorMeta) {
          themeColorMeta.setAttribute("content", theme === "dark" ? "#1e293b" : "#2563eb");
        }

        // Regenerate QR code with new colors
        const saved = loadCurrentProfile();
        if (saved && qrInstance) {
          regenerateQR(saved);
        }
      }

      function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute("data-theme") || "light";
        const newTheme = currentTheme === "light" ? "dark" : "light";
        applyTheme(newTheme);
      }

      // === Profile UI Functions ===

      function updateProfileSelector() {
        const profiles = getAllProfiles();
        const currentId = getCurrentProfileId();
        const currentProfile = profiles.find(p => p.id === currentId);

        // Update button text
        const profileNameElement = document.getElementById("current-profile-name");
        if (profileNameElement && currentProfile) {
          profileNameElement.textContent = currentProfile.name;
        }

        // Update dropdown menu
        const menu = document.getElementById("profile-menu");
        if (!menu) return;

        menu.innerHTML = '';

        profiles.forEach(profile => {
          const item = document.createElement('div');
          item.className = 'profile-menu-item' + (profile.id === currentId ? ' active' : '');

          const name = document.createElement('span');
          name.className = 'profile-name';
          name.textContent = profile.name;
          name.onclick = (e) => {
            e.stopPropagation();
            switchProfile(profile.id);
            toggleProfileMenu(false);
          };

          const actions = document.createElement('div');
          actions.className = 'profile-actions';

          const renameBtn = document.createElement('button');
          renameBtn.className = 'profile-action-btn';
          renameBtn.textContent = '✏️';
          renameBtn.title = '名前を変更';
          renameBtn.onclick = (e) => {
            e.stopPropagation();
            const newName = prompt('名刺の名前を変更:', profile.name);
            if (newName && newName.trim()) {
              renameProfile(profile.id, newName.trim());
            }
          };

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'profile-action-btn';
          deleteBtn.textContent = '🗑️';
          deleteBtn.title = '削除';
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deleteProfile(profile.id);
          };

          actions.appendChild(renameBtn);
          actions.appendChild(deleteBtn);

          item.appendChild(name);
          item.appendChild(actions);
          menu.appendChild(item);
        });

        // Add divider
        const divider = document.createElement('div');
        divider.className = 'profile-menu-divider';
        menu.appendChild(divider);

        // Add "New Profile" button
        const newItem = document.createElement('div');
        newItem.className = 'profile-menu-item';
        newItem.innerHTML = '<span class="profile-name">➕ 新しい名刺を作成</span>';
        newItem.onclick = (e) => {
          e.stopPropagation();
          if (!canCreateNewCard()) {
            showPremiumUpgradePrompt("無料版では名刺は1枚までです。");
            toggleProfileMenu(false);
            return;
          }
          const name = prompt('名刺の名前を入力してください:', '新しい名刺');
          if (name && name.trim()) {
            const newProfile = createNewProfile(name.trim());
            switchProfile(newProfile.id);
          }
          toggleProfileMenu(false);
        };
        menu.appendChild(newItem);
      }

      function toggleProfileMenu(show) {
        const menu = document.getElementById("profile-menu");
        if (!menu) return;

        if (show === undefined) {
          menu.classList.toggle('active');
        } else {
          menu.classList.toggle('active', show);
        }
      }

      // === Onboarding Functions ===

      let onboardingCurrentPage = 0;
      const ONBOARDING_PAGE_COUNT = 3;

      function updateOnboardingSlide(page) {
        page = Math.max(0, Math.min(page, ONBOARDING_PAGE_COUNT - 1));
        onboardingCurrentPage = page;
        const slidesEl = document.getElementById("onboarding-slides");
        if (slidesEl) {
          const pct = (page / ONBOARDING_PAGE_COUNT) * 100;
          slidesEl.style.transform = "translateX(-" + pct + "%)";
        }
        const dots = document.querySelectorAll("#onboarding-indicators .onboarding-dot");
        dots.forEach(function (dot, i) {
          const isActive = i === page;
          dot.classList.toggle("active", isActive);
          dot.setAttribute("aria-selected", isActive ? "true" : "false");
        });
      }

      function setupOnboardingSwipe() {
        const wrap = document.getElementById("onboarding-slides-wrap");
        if (!wrap) return;
        let startX = 0;
        let currentX = 0;
        function onStart(e) {
          startX = ("touches" in e ? e.touches[0] : e).clientX;
          currentX = startX;
        }
        function onMove(e) {
          currentX = ("touches" in e ? e.touches[0] : e).clientX;
        }
        function onEnd() {
          const delta = startX - currentX;
          if (Math.abs(delta) > 50) {
            if (delta > 0) {
              updateOnboardingSlide(onboardingCurrentPage + 1);
            } else {
              updateOnboardingSlide(onboardingCurrentPage - 1);
            }
          }
        }
        wrap.addEventListener("touchstart", onStart, { passive: true });
        wrap.addEventListener("touchmove", onMove, { passive: true });
        wrap.addEventListener("touchend", onEnd);
        wrap.addEventListener("mousedown", function (e) {
          if (e.button !== 0) return;
          onStart(e);
          const up = function (e2) {
            onEnd();
            document.removeEventListener("mousemove", onMove);
            document.removeEventListener("mouseup", up);
          };
          document.addEventListener("mousemove", onMove);
          document.addEventListener("mouseup", up);
        });
        document.querySelectorAll("#onboarding-indicators .onboarding-dot").forEach(function (dot) {
          dot.addEventListener("click", function () {
            const i = parseInt(dot.getAttribute("data-index"), 10);
            if (!isNaN(i)) updateOnboardingSlide(i);
          });
        });
      }

      function showOnboarding() {
        const overlay = document.getElementById("onboarding-overlay");
        if (overlay) {
          onboardingCurrentPage = 0;
          updateOnboardingSlide(0);
          overlay.classList.add("active");
        }
      }

      function hideOnboarding() {
        const overlay = document.getElementById("onboarding-overlay");
        if (overlay) {
          overlay.classList.remove("active");
        }
        localStorage.setItem(ONBOARDING_KEY, "true");
      }

      function shouldShowOnboarding() {
        return !localStorage.getItem(ONBOARDING_KEY);
      }

      function resetOnboarding() {
        localStorage.removeItem(ONBOARDING_KEY);
        showOnboarding();
      }

      // === Hamburger Menu Functions ===

      function openMenu() {
        showMainMenu();
        document.getElementById("menu-overlay").classList.add("active");
        document.getElementById("menu-drawer").classList.add("active");
      }

      function closeMenu() {
        document.getElementById("menu-overlay").classList.remove("active");
        document.getElementById("menu-drawer").classList.remove("active");
      }

      function showMainMenu() {
        const drawer = document.getElementById("menu-drawer");
        let html = `
          <div class="menu-header">
            <div class="menu-title">メニュー</div>
            <button id="menu-close-btn-main" class="menu-close-btn">✕</button>
          </div>
          <div class="menu-content">
            <div class="menu-item" id="menu-profiles-main">
              <span class="menu-item-icon">📇</span>
              <span class="menu-item-text">名刺を選ぶ</span>
              <span class="menu-item-arrow">›</span>
            </div>
            <div class="menu-divider"></div>
            <div class="menu-item" id="menu-share-main">
              <span class="menu-item-icon">📤</span>
              <span class="menu-item-text">共有する</span>
              <span class="menu-item-arrow">›</span>
            </div>
            <div class="menu-item" id="menu-sns-main">
              <span class="menu-item-icon">🔗</span>
              <span class="menu-item-text">SNS・リンク設定</span>
              <span class="menu-item-arrow">›</span>
            </div>
            <div class="menu-divider"></div>
            <div class="menu-item" id="menu-settings-main">
              <span class="menu-item-icon">⚙️</span>
              <span class="menu-item-text">設定</span>
              <span class="menu-item-arrow">›</span>
            </div>
            <div class="menu-item" id="menu-data-main">
              <span class="menu-item-icon">💾</span>
              <span class="menu-item-text">データの保存・削除</span>
              <span class="menu-item-arrow">›</span>
            </div>
            <div class="menu-divider"></div>
            <div class="menu-item" id="menu-help-main">
              <span class="menu-item-icon">❓</span>
              <span class="menu-item-text">ヘルプ・使い方</span>
            </div>
            <div class="menu-item" id="menu-about-main">
              <span class="menu-item-icon">ℹ️</span>
              <span class="menu-item-text">このアプリについて</span>
            </div>
          </div>
        `;
        drawer.innerHTML = html;

        // Re-attach event listeners
        attachMainMenuListeners();
      }

      function attachMainMenuListeners() {
        const closeBtn = document.getElementById("menu-close-btn-main");
        if (closeBtn) {
          closeBtn.addEventListener("click", closeMenu);
        }

        const items = {
          "menu-profiles-main": showProfilesSubmenu,
          "menu-share-main": showShareSubmenu,
          "menu-sns-main": () => {
            closeMenu();
            switchMode("edit");
            setTimeout(() => {
              const lineInput = document.getElementById("line");
              if (lineInput) {
                lineInput.scrollIntoView({ behavior: "smooth", block: "center" });
              }
            }, 100);
          },
          "menu-settings-main": showSettingsSubmenu,
          "menu-data-main": showDataSubmenu,
          "menu-help-main": () => {
            closeMenu();
            showOnboarding();
          },
          "menu-about-main": showAboutSubmenu
        };

        Object.keys(items).forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener("click", items[id]);
          }
        });
      }

      function showProfilesSubmenu() {
        const profiles = getAllProfiles();
        const currentId = getCurrentProfileId();

        let html = '<div class="menu-header"><div class="menu-title">名刺を選ぶ</div><button class="menu-close-btn" onclick="showMainMenu()">←</button></div><div class="menu-content">';

        profiles.forEach(profile => {
          const active = profile.id === currentId ? ' (使用中)' : '';
          html += `
            <div class="menu-item" onclick="switchProfileAndClose('${profile.id}')">
              <span class="menu-item-icon">${profile.id === currentId ? '✓' : '📇'}</span>
              <span class="menu-item-text">${profile.name}${active}</span>
            </div>
          `;
        });

        html += '<div class="menu-divider"></div>';
        html += `
          <div class="menu-item" onclick="createNewProfilePrompt()">
            <span class="menu-item-icon">➕</span>
            <span class="menu-item-text">新しい名刺を作成</span>
          </div>
        `;
        html += '</div>';

        const drawer = document.getElementById("menu-drawer");
        drawer.innerHTML = html;
      }

      function showShareSubmenu() {
        const data = loadCurrentProfile();

        let html = '<div class="menu-header"><div class="menu-title">共有する</div><button class="menu-close-btn" onclick="showMainMenu()">←</button></div><div class="menu-content">';

        html += `
          <div class="menu-item" onclick="closeMenuOnly()">
            <span class="menu-item-icon">📱</span>
            <span class="menu-item-text">QRコードを見せる</span>
          </div>
          <div class="menu-item" onclick="shareVCardFromMenu()">
            <span class="menu-item-icon">💬</span>
            <span class="menu-item-text">LINEなどで送る</span>
          </div>
          <div class="menu-item" onclick="downloadQRFromMenu()">
            <span class="menu-item-icon">🖼️</span>
            <span class="menu-item-text">QR画像を保存</span>
          </div>
          <div class="menu-item" onclick="exportVCardFromMenu()">
            <span class="menu-item-icon">📄</span>
            <span class="menu-item-text">ファイルで保存 (.vcf)</span>
          </div>
        `;

        html += '</div>';

        const drawer = document.getElementById("menu-drawer");
        drawer.innerHTML = html;
      }

      function showSettingsSubmenu() {
        checkAndApplyPremiumExpiry();
        const premium = isPremiumUser();
        const planLabel = premium ? '<span class="badge-premium">★ Premium</span>' : '<span style="font-size:13px; color: var(--text-muted);">無料版</span>';
        let html = '<div class="menu-header"><div class="menu-title" data-i18n="menu.settingsTitle">設定</div><button class="menu-close-btn" onclick="showMainMenu()">←</button></div><div class="menu-content">';
        html += '<div class="menu-section-title">現在のプラン</div>';
        html += '<div class="menu-item" style="padding-top:8px; padding-bottom:8px;">' + planLabel + '</div>';
        if (!premium) {
          html += '<div class="menu-item" onclick="startPremiumPurchase()" style="cursor:pointer;"><span class="menu-item-icon">👑</span><span class="menu-item-text" style="font-size:13px;">Premiumにアップグレード（ウォーターマークなし・全テンプレート）</span></div>';
          html += '<div class="menu-item" onclick="restorePurchases()" style="cursor:pointer;"><span class="menu-item-icon">🔄</span><span class="menu-item-text" style="font-size:13px;">購入を復元</span></div>';
        }
        if (DEV_SHOW_PREMIUM_TOGGLE) {
          html += '<div class="menu-item" onclick="togglePremiumForDev()" style="cursor:pointer;"><span class="menu-item-icon">🔄</span><span class="menu-item-text" style="font-size:12px; color: var(--text-muted);">Premium状態を切り替え（開発用）</span></div>';
        }
        html += '<div class="menu-divider"></div>';
        html += `
          <div class="menu-section-title" data-i18n="menu.settingsQrSizeSection">QRコードサイズ</div>
          <div class="menu-item" onclick="setQRSize('large')">
            <span class="menu-item-icon">📐</span>
            <span class="menu-item-text" data-i18n="menu.settingsQrSizeLarge">大（読み取りやすい）</span>
          </div>
          <div class="menu-item" onclick="setQRSize('medium')">
            <span class="menu-item-icon">📐</span>
            <span class="menu-item-text" data-i18n="menu.settingsQrSizeMedium">中（標準・推奨）</span>
          </div>
          <div class="menu-item" onclick="setQRSize('small')">
            <span class="menu-item-icon">📐</span>
            <span class="menu-item-text" data-i18n="menu.settingsQrSizeSmall">小（コンパクト）</span>
          </div>
          <div class="menu-divider"></div>
          <div class="menu-section-title" data-i18n="menu.settingsPrivacySection">プライバシー</div>
          <div class="menu-item">
            <span class="menu-item-icon">🔐</span>
            <span class="menu-item-text" data-i18n="menu.settingsPasswordComingSoon">パスワード保護（準備中）</span>
          </div>
          <div class="menu-divider"></div>
          <div class="menu-section-title" data-i18n="language.label">言語 / Language</div>
          <div class="menu-item">
            <span class="menu-item-icon">🌐</span>
            <span class="menu-item-text">
              <div id="meqr-lang-options" style="display:flex; flex-direction:column; gap:4px; font-size:13px;">
                <label>
                  <input type="radio" name="meqr-lang" id="meqr-lang-auto" value="auto">
                  <span data-i18n="language.auto">自動（ブラウザ設定）</span>
                </label>
                <label>
                  <input type="radio" name="meqr-lang" id="meqr-lang-ja" value="ja">
                  🇯🇵 <span data-i18n="language.ja">日本語</span>
                </label>
                <label>
                  <input type="radio" name="meqr-lang" id="meqr-lang-en" value="en">
                  🇬🇧 <span data-i18n="language.en">English</span>
                </label>
              </div>
            </span>
          </div>
          <div class="menu-divider"></div>
          <div class="menu-section-title">ストア公開用</div>
          <div class="menu-item" onclick="loadDemoDataForScreenshots()" style="cursor:pointer;">
            <span class="menu-item-icon">📸</span>
            <span class="menu-item-text" style="font-size:13px;">スクリーンショット用デモを読み込む</span>
          </div>
        `;

        html += '</div>';

        const drawer = document.getElementById("menu-drawer");
        drawer.innerHTML = html;

        if (window.MeQRI18n && typeof window.MeQRI18n.attachLanguageControlHandlers === "function") {
          window.MeQRI18n.attachLanguageControlHandlers();
          window.MeQRI18n.applyTranslations();
        }
      }

      function showDataSubmenu() {
        let html = '<div class="menu-header"><div class="menu-title">データの保存・削除</div><button class="menu-close-btn" onclick="showMainMenu()">←</button></div><div class="menu-content">';

        html += `
          <div class="menu-item" onclick="loadTestData()">
            <span class="menu-item-icon">🧪</span>
            <span class="menu-item-text">テストデータを読み込む</span>
          </div>
          <div class="menu-item" onclick="showStorageInfo()">
            <span class="menu-item-icon">📊</span>
            <span class="menu-item-text">保存容量を確認</span>
          </div>
          <div class="menu-divider"></div>
          <div class="menu-item" onclick="deleteAllData()">
            <span class="menu-item-icon">🗑️</span>
            <span class="menu-item-text" style="color: var(--danger);">すべて削除</span>
          </div>
        `;

        html += '</div>';

        const drawer = document.getElementById("menu-drawer");
        drawer.innerHTML = html;
      }

      function showAboutSubmenu() {
        let html = '<div class="menu-header"><div class="menu-title">このアプリについて</div><button class="menu-close-btn" onclick="showMainMenu()">←</button></div><div class="menu-content" style="padding: 20px;">';

        html += `
          <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 48px; margin-bottom: 8px;">📇</div>
            <div style="font-size: 20px; font-weight: 700; margin-bottom: 4px;">MeQR</div>
            <div style="font-size: 13px; color: var(--text-muted);">バージョン 1.0.0</div>
          </div>
          <div style="font-size: 13px; line-height: 1.6; color: var(--text-muted); margin-bottom: 16px;">
            ローカル完結型のプライバシー重視デジタル名刺アプリ。サーバーにデータを一切送信せず、ブラウザのみで動作します。
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <div style="padding: 8px; background: var(--accent-soft); border-radius: 8px; font-size: 12px;">
              ✅ 完全プライバシー保護
            </div>
            <div style="padding: 8px; background: var(--accent-soft); border-radius: 8px; font-size: 12px;">
              ✅ 完全無料・広告なし
            </div>
            <div style="padding: 8px; background: var(--accent-soft); border-radius: 8px; font-size: 12px;">
              ✅ オープンソース
            </div>
          </div>
          <div style="margin-top: 20px;">
            <div style="font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px;">名刺作成コンセプト（統合ドキュメント）</div>
            <div style="display: flex; flex-direction: column; gap: 6px;">
              <a href="docs/specification.html" target="_blank" rel="noopener" style="color: var(--accent); text-decoration: none; font-size: 13px;">📋 仕様書（確定仕様書）</a>
              <a href="docs/wireframe-v2.html" target="_blank" rel="noopener" style="color: var(--accent); text-decoration: none; font-size: 13px;">🎨 ワイヤーフレーム v2</a>
            </div>
          </div>
          <div style="margin-top: 20px; text-align: center;">
            <a href="https://github.com/YumaKakuya/meqr" target="_blank" rel="noopener" style="color: var(--accent); text-decoration: none; font-size: 13px;">
              📂 GitHubリポジトリ
            </a>
          </div>
        `;

        html += '</div>';

        const drawer = document.getElementById("menu-drawer");
        drawer.innerHTML = html;
      }

      // Menu helper functions (called from onclick)
      // Menu helper functions (called from onclick in dynamic HTML)
      window.showMainMenu = showMainMenu;
      window.togglePremiumForDev = togglePremiumForDev;
      window.exportBusinessCardAsPDF = exportBusinessCardAsPDF;
      window.exportBusinessCardAsPNG = exportBusinessCardAsPNG;
      window.openExportModal = openExportModal;
      window.closeExportModal = closeExportModal;
      window.handleExportDownload = handleExportDownload;
      window.startPremiumPurchase = startPremiumPurchase;
      window.restorePurchases = restorePurchases;
      window.loadDemoDataForScreenshots = loadDemoDataForScreenshots;

      window.switchProfileAndClose = function (profileId) {
        switchProfile(profileId);
        closeMenu();
      };

      window.createNewProfilePrompt = function () {
        if (!canCreateNewCard()) {
          showPremiumUpgradePrompt("無料版では名刺は1枚までです。");
          closeMenu();
          return;
        }
        const name = prompt('名刺の名前を入力してください:', '新しい名刺');
        if (name && name.trim()) {
          const newProfile = createNewProfile(name.trim());
          switchProfile(newProfile.id);
        }
        closeMenu();
      };

      window.closeMenuOnly = function () {
        closeMenu();
      };

      window.shareVCardFromMenu = async function () {
        const data = loadCurrentProfile();
        if (!data || (!data.lastName && !data.firstName)) {
          alert("共有する連絡先情報がありません。");
          return;
        }
        closeMenu();
        await shareVCard(data);
      };

      window.downloadQRFromMenu = function () {
        const data = loadCurrentProfile();
        if (!data || (!data.lastName && !data.firstName)) {
          alert("QRコードを保存する前に、連絡先情報を入力してください。");
          return;
        }
        closeMenu();
        downloadQRCode(data);
      };

      window.exportVCardFromMenu = function () {
        const data = loadCurrentProfile();
        if (!data || (!data.lastName && !data.firstName)) {
          alert("エクスポートする連絡先情報がありません。");
          return;
        }
        closeMenu();
        exportVCard(data);
      };

      window.setQRSize = function (size) {
        localStorage.setItem('meqr_qr_size', size);

        const qrInner = document.querySelector('.qr-inner');
        if (qrInner) {
          qrInner.classList.remove('size-small', 'size-medium', 'size-large');
          qrInner.classList.add('size-' + size);
        }

        const sizeText = size === 'large' ? '大' : size === 'medium' ? '中' : '小';
        alert(`QRコードサイズを「${sizeText}」に設定しました。`);
        closeMenu();
      };

      function applyQRSize() {
        const size = localStorage.getItem('meqr_qr_size') || 'medium';
        const qrInner = document.querySelector('.qr-inner');
        if (qrInner) {
          qrInner.classList.add('size-' + size);
        }
      }

      window.showStorageInfo = function () {
        const profiles = getAllProfiles();
        const dataStr = JSON.stringify(profiles);
        const bytes = new Blob([dataStr]).size;
        const kb = (bytes / 1024).toFixed(2);
        alert(`保存データ容量:\n\n${kb} KB\n名刺数: ${profiles.length}個\n\n※ ブラウザの制限: 約5-10MB`);
      };

      // テスト用サンプルデータ
      function getTestProfiles() {
        const now = new Date().toISOString();
        return [
          {
            id: "test-business-" + Date.now(),
            name: "ビジネス名刺（テスト）",
            data: {
              lastName: "山田",
              firstName: "太郎",
              furigana: "ヤマダ タロウ",
              phone: "090-1234-5678",
              email: "yamada.taro@example.co.jp",
              org: "株式会社サンプル",
              title: "営業部長",
              url: "https://example.co.jp",
              address: "〒100-0001 東京都千代田区千代田1-1",
              photo: "",
              twitter: "https://x.com/yamada_taro",
              instagram: "https://instagram.com/yamada.taro",
              line: ""
            },
            createdAt: now,
            updatedAt: now
          },
          {
            id: "test-private-" + (Date.now() + 1),
            name: "プライベート名刺（テスト）",
            data: {
              lastName: "山田",
              firstName: "太郎",
              furigana: "",
              phone: "080-9876-5432",
              email: "taro.yamada@gmail.com",
              org: "",
              title: "",
              url: "https://taro-yamada.blog",
              address: "",
              photo: "",
              twitter: "https://x.com/taro_private",
              instagram: "https://instagram.com/taro_private",
              line: ""
            },
            createdAt: now,
            updatedAt: now
          }
        ];
      }

      window.loadTestData = function () {
        const ok = confirm("テスト用のサンプルデータを読み込みます。\n\n現在のデータは上書きされます。よろしいですか？");
        if (!ok) return;

        const testProfiles = getTestProfiles();
        saveAllProfiles(testProfiles);
        setCurrentProfileId(testProfiles[0].id);

        fillDisplay(testProfiles[0].data);
        fillForm(testProfiles[0].data);
        regenerateQR(testProfiles[0].data);
        showMainMenu();
        closeMenu();
        setSyncStatus("saved");

        alert("テストデータを読み込みました。\n\n・ビジネス名刺（テスト）\n・プライベート名刺（テスト）\n\nメニュー「名刺を選ぶ」で切り替えられます。");
      };

      window.deleteAllData = function () {
        const confirm1 = confirm("⚠️ すべての名刺データを削除します。\n\nこの操作は取り消せません。本当に削除しますか？");
        if (!confirm1) return;

        const confirm2 = confirm("最終確認:\n\n本当にすべてのデータを削除しますか？");
        if (!confirm2) return;

        localStorage.removeItem(PROFILES_KEY);
        localStorage.removeItem(CURRENT_PROFILE_KEY);
        localStorage.removeItem(ONBOARDING_KEY);

        alert("すべてのデータを削除しました。ページをリロードします。");
        location.reload();
      };

      async function onDOMContentLoaded() {
        try {
          // Initialize language first
          if (window.MeQRI18n && typeof window.MeQRI18n.initI18n === "function") {
            await window.MeQRI18n.initI18n();
          }

          // Initialize theme first
          initTheme();

          // Check Premium expiry and downgrade if needed
          checkAndApplyPremiumExpiry();
          // Initialize billing (if running under Cordova/Android)
          initBilling();

          // Migrate old data if exists
          migrateOldData();
          cleanupLocalStorage();

          // Load current profile (QR and canvas are deferred via Intersection Observer)
          const initialData = loadCurrentProfile();

          fillDisplay(initialData);
          fillForm(initialData);
          updateProfileSelector();
          applyQRSize();
          setupLazyObservers();
          initTemplateSlider();
          var hasData = initialData && (initialData.lastName || initialData.firstName || initialData.email || initialData.phone || initialData.org);
          switchView(hasData ? "display" : "form");
        } catch (err) {
          console.error("MeQR: Initialization error", err);
          alert("初期化エラーが発生しました: " + err.message);
        }

        // Show onboarding if first time
        if (shouldShowOnboarding()) {
          showOnboarding();
        }

        // Onboarding handlers
        const btnOnboardingStart = document.getElementById("btn-onboarding-start");
        const btnOnboardingSkip = document.getElementById("btn-onboarding-skip");

        if (btnOnboardingStart) {
          btnOnboardingStart.addEventListener("click", () => {
            hideOnboarding();
            switchMode("edit");
          });
        }

        if (btnOnboardingSkip) {
          btnOnboardingSkip.addEventListener("click", () => {
            hideOnboarding();
          });
        }

        setupOnboardingSwipe();

        // Hamburger menu
        document.getElementById("btn-hamburger").addEventListener("click", () => {
          openMenu();
        });

        document.getElementById("menu-overlay").addEventListener("click", () => {
          closeMenu();
        });

        document.getElementById("btn-view-mode").addEventListener("click", () => {
          switchView("display");
        });
        document.getElementById("btn-edit-mode").addEventListener("click", () => {
          switchView("form");
        });
        var btnBottomDisplay = document.getElementById("btn-bottom-display");
        var btnBottomEdit = document.getElementById("btn-bottom-edit");
        if (btnBottomDisplay) btnBottomDisplay.addEventListener("click", function () { switchView("display"); });
        if (btnBottomEdit) btnBottomEdit.addEventListener("click", function () { switchView("form"); });

        (function attachSaveHandler() {
          const btnSave = document.getElementById("btn-save");
          if (!btnSave) return;
          btnSave.addEventListener("click", () => {
            const data = readForm();
            clearAllErrors();
            const result = validateForm(data);
            if (!result.valid) {
              result.errors.forEach(function (e) {
                if (e.message) showFieldError(e.field, e.message);
              });
              var first = result.errors[0];
              if (first && first.field === "name") {
                var el = document.getElementById("lastName");
                if (el) el.focus();
              } else if (first) {
                var input = document.getElementById(first.field);
                if (input) input.focus();
              }
              return;
            }
            saveCurrentProfile(data);
            fillDisplay(data);
            regenerateQR(data);
            renderAllTemplateSlides();
            schedulePreviewDraw();
            switchMode("view");
          });
        })();

        (function setupValidationListeners() {
          var fields = ["lastName", "firstName", "furigana", "phone", "email", "org", "title", "url", "address", "twitter", "instagram", "line"];
          var timer = null;
          function runSoon() {
            if (timer) clearTimeout(timer);
            timer = setTimeout(runRealtimeValidation, 300);
          }
          fields.forEach(function (id) {
            var el = document.getElementById(id);
            if (!el) return;
            el.addEventListener("input", runSoon);
            el.addEventListener("blur", runRealtimeValidation);
          });
        })();

        document.getElementById("btn-clear").addEventListener("click", () => {
          const ok = confirm("現在の名刺の情報をクリアします。よろしいですか？");
          if (!ok) return;
          clearAllErrors();
          const emptyData = {
            lastName: "",
            firstName: "",
            furigana: "",
            phone: "",
            email: "",
            org: "",
            title: "",
            url: "",
            address: "",
            photo: "",
            twitter: "",
            instagram: "",
            line: ""
          };
          saveCurrentProfile(emptyData);
          fillDisplay(emptyData);
          fillForm(emptyData);
          regenerateQR(emptyData);
          renderAllTemplateSlides();
          setSyncStatus("empty");
        });

        document.getElementById("btn-preview-vcard").addEventListener("click", () => {
          const data = loadCurrentProfile() || readForm();
          previewVCard(data);
        });

        document.getElementById("btn-export-vcard").addEventListener("click", () => {
          const data = loadCurrentProfile();
          if (!data || (!data.lastName && !data.firstName)) {
            alert("エクスポートする連絡先情報がありません。先に名前を入力して保存してください。");
            return;
          }
          exportVCard(data);
        });

        document.getElementById("btn-export-card").addEventListener("click", () => {
          const data = loadCurrentProfile();
          if (!data || (!data.lastName && !data.firstName)) {
            alert("ダウンロードする名刺情報がありません。先に名前を入力して保存してください。");
            return;
          }
          openExportModal();
        });

        document.getElementById("btn-print-png").addEventListener("click", () => {
          downloadDisplaySectionAsPrintPNG();
        });

        (function setupExportUsageOptions() {
          var overlay = document.getElementById("exportModalOverlay");
          if (!overlay) return;
          overlay.querySelectorAll(".export-usage-option").forEach(function (el) {
            el.addEventListener("click", function () {
              overlay.querySelectorAll(".export-usage-option").forEach(function (o) { o.classList.remove("selected"); });
              el.classList.add("selected");
              var usage = el.getAttribute("data-usage");
              var pdfRadio = overlay.querySelector('input[name="export-format"][value="pdf"]');
              var pngRadio = overlay.querySelector('input[name="export-format"][value="png"]');
              if (usage === "sns" && pngRadio) pngRadio.checked = true;
              else if (pdfRadio) pdfRadio.checked = true;
            });
            el.addEventListener("keydown", function (e) {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                el.click();
              }
            });
          });
        })();

        const qrModalOverlay = document.getElementById("qrDownloadModalOverlay");
        if (qrModalOverlay) {
          qrModalOverlay.addEventListener("click", function (e) {
            if (e.target === qrModalOverlay) closeQRDownloadModal();
          });
        }

        document.getElementById("btn-share-vcard").addEventListener("click", async () => {
          const data = loadCurrentProfile();
          if (!data || (!data.lastName && !data.firstName)) {
            alert("共有する連絡先情報がありません。先に名前を入力して保存してください。");
            return;
          }
          await shareVCard(data);
        });

        document.getElementById("btn-download-qr").addEventListener("click", () => {
          const data = loadCurrentProfile();
          if (!data || (!data.lastName && !data.firstName)) {
            alert("QRコードを保存する前に、連絡先情報を入力して保存してください。");
            return;
          }
          downloadQRCode(data);
        });

        // Photo upload handler
        document.getElementById("photoUpload").addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (!file) return;

          // Validate file size (max 500KB)
          if (file.size > 500 * 1024) {
            alert("写真のサイズが大きすぎます。500KB以下の画像を選択してください。");
            e.target.value = "";
            return;
          }

          // Validate file type
          if (!file.type.match(/^image\/(jpeg|png|webp)$/)) {
            alert("対応している画像形式はJPEG、PNG、WebPです。");
            e.target.value = "";
            return;
          }

          const reader = new FileReader();
          reader.onload = function (event) {
            const currentData = loadCurrentProfile() || readForm();
            currentData.photo = event.target.result;
            saveCurrentProfile(currentData);
            fillDisplay(currentData);
            renderAllTemplateSlides();
          };
          reader.onerror = function () {
            alert("画像の読み込みに失敗しました。");
            e.target.value = "";
          };
          reader.readAsDataURL(file);
        });

        if ("serviceWorker" in navigator) {
          // sw.js の挙動を変更したので、URLにバージョンを付けて更新を確実化する。
          navigator.serviceWorker.register("sw.js?v=5")
            .then(reg => {
              console.log("ServiceWorker registered", reg);
              try {
                reg.update();
              } catch (_) {
                // ignore
              }
              setupOfflineBadge();
            })
            .catch(err => {
              console.warn("ServiceWorker registration failed", err);
              setupOfflineBadge();
            });
        } else {
          console.log("ServiceWorker not supported");
          setupOfflineBadge();
        }

        // テスト用: URL に ?demo=1 がある場合はテストデータを読み込む（確認ダイアログあり）
        if (location.search.includes("demo=1")) {
          setTimeout(function () {
            if (typeof loadTestData === "function") loadTestData();
          }, 800);
        }
      }

      document.addEventListener("DOMContentLoaded", onDOMContentLoaded);
    })();
  </script>
</body>

</html>