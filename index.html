<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="theme-color" content="#2563eb" id="themeColorMeta">
  <title>MeQR - ãƒ‡ã‚¸ã‚¿ãƒ«ååˆº</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MeQR">
  <link rel="apple-touch-icon" href="icons/icon-192.svg">

  <style>
    :root {
      color-scheme: light;
    }

    /* Light theme (default) */
    :root,
    [data-theme="light"] {
      --bg: #f8f9fa;
      --bg-elevated: #ffffff;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.1);
      --accent-strong: rgba(37, 99, 235, 0.85);
      --border-subtle: #e5e7eb;
      --border-medium: #d1d5db;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --danger: #dc2626;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --qr-dark: #020617;
      --qr-light: #f9fafb;
    }

    /* Dark theme */
    [data-theme="dark"] {
      color-scheme: dark;
      --bg: #0f172a;
      --bg-elevated: #1e293b;
      --accent: #3b82f6;
      --accent-soft: rgba(59, 130, 246, 0.15);
      --accent-strong: rgba(59, 130, 246, 0.9);
      --border-subtle: #334155;
      --border-medium: #475569;
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
      --danger: #ef4444;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.5), 0 1px 2px -1px rgb(0 0 0 / 0.4);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.5), 0 2px 4px -2px rgb(0 0 0 / 0.4);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.6), 0 4px 6px -4px rgb(0 0 0 / 0.5);
      --qr-dark: #020617;
      --qr-light: #f9fafb;
    }

    [data-theme="dark"] body {
      background: linear-gradient(to bottom, #0f172a 0%, #020617 100%);
    }

    [data-theme="dark"] .card {
      background: #1e293b;
      border-color: #334155;
    }

    [data-theme="dark"] .photo-placeholder {
      background: linear-gradient(135deg, #334155 0%, #475569 100%);
      border-color: #475569;
    }

    [data-theme="dark"] .qr-shell {
      background: #0f172a;
      border-color: #475569;
    }

    [data-theme="dark"] .qr-inner {
      background: #1e293b;
    }

    [data-theme="dark"] .brightness-tip {
      background: rgba(30, 41, 59, 0.95);
      border-color: #475569;
    }

    [data-theme="dark"] .chip {
      background: #0f172a;
      border-color: #475569;
    }

    [data-theme="dark"] .chip-strong {
      background: rgba(59, 130, 246, 0.2);
      border-color: #3b82f6;
      color: #93c5fd;
    }

    [data-theme="dark"] .mode-toggle {
      background: #1e293b;
      border-color: #475569;
    }

    [data-theme="dark"] .mode-toggle button.active {
      background: #3b82f6;
    }

    [data-theme="dark"] .btn-ghost {
      background: #1e293b;
      border-color: #475569;
    }

    [data-theme="dark"] .btn-ghost:hover {
      background: #334155;
      border-color: #3b82f6;
    }

    [data-theme="dark"] .btn-primary {
      background: #3b82f6;
    }

    [data-theme="dark"] .btn-primary:hover {
      background: #2563eb;
    }

    [data-theme="dark"] .btn-secondary {
      background: #1e293b;
      border-color: #475569;
    }

    [data-theme="dark"] .btn-secondary:hover {
      background: #7f1d1d;
      border-color: #ef4444;
    }

    [data-theme="dark"] .badge-offline {
      background: #1e293b;
      border-color: #475569;
    }

    [data-theme="dark"] .input-shell input,
    [data-theme="dark"] .input-shell textarea {
      background: #0f172a;
      border-color: #475569;
      color: var(--text-main);
    }

    [data-theme="dark"] .input-shell input:focus,
    [data-theme="dark"] .input-shell textarea:focus {
      background: #1e293b;
      border-color: #3b82f6;
    }

    [data-theme="dark"] .photo-upload-label {
      background: #1e293b;
      border-color: #475569;
    }

    [data-theme="dark"] .photo-upload-label:hover {
      background: #334155;
      border-color: #3b82f6;
    }

    [data-theme="dark"] .brand-mark {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-color: #1e293b;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Noto Sans JP", sans-serif;
      background: linear-gradient(to bottom, #f0f4f8 0%, #e6ecf1 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app-root {
      width: 100%;
      max-width: 520px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: env(safe-area-inset-top, 20px) 20px env(safe-area-inset-bottom, 24px);
      gap: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 4px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-mark {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      border: 2px solid #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-md);
    }

    .brand-mark span {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.02em;
      color: #ffffff;
    }

    .brand-text-main {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: -0.01em;
      color: var(--text-main);
    }

    .brand-text-sub {
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .mode-toggle {
      display: inline-flex;
      border-radius: 10px;
      background: #ffffff;
      padding: 4px;
      gap: 4px;
      border: 1px solid var(--border-medium);
      box-shadow: var(--shadow-sm);
    }

    .mode-toggle button {
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 500;
      padding: 7px 14px;
      border-radius: 7px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .mode-toggle button.active {
      background: var(--accent);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .mode-toggle button span.icon {
      font-size: 14px;
    }

    main {
      flex: 1;
      display: flex;
    }

    .card {
      position: relative;
      flex: 1;
      border-radius: 16px;
      padding: 24px;
      background: #ffffff;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      gap: 20px;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      gap: 16px;
      align-items: flex-start;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border-subtle);
    }

    .photo-area {
      flex-shrink: 0;
    }

    .photo-placeholder {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      background: linear-gradient(135deg, #e0e7ff 0%, #dbeafe 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      border: 2px solid var(--border-subtle);
      box-shadow: var(--shadow-sm);
    }

    #displayPhoto {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      border: 2px solid var(--border-subtle);
      box-shadow: var(--shadow-sm);
      display: none;
    }

    .id-block {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .name-main {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.01em;
      color: var(--text-main);
      line-height: 1.3;
    }

    .name-sub {
      font-size: 13px;
      color: var(--text-muted);
      letter-spacing: 0.01em;
      line-height: 1.4;
    }

    .meta-chips {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .chip {
      font-size: 10px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 6px;
      background: #f3f4f6;
      border: 1px solid var(--border-medium);
      color: var(--text-muted);
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .chip-strong {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-soft);
    }

    .qr-shell {
      position: relative;
      flex: 1;
      min-height: 280px;
      max-height: 360px;
      border-radius: 12px;
      background: #f9fafb;
      border: 2px dashed var(--border-medium);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: hidden;
    }

    .qr-inner {
      position: relative;
      width: 100%;
      max-width: 280px;
      aspect-ratio: 1 / 1;
      border-radius: 8px;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      box-shadow: var(--shadow);
    }

    #qrcode {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .brightness-tip {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      color: var(--text-muted);
      background: rgba(255, 255, 255, 0.95);
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid var(--border-medium);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow-sm);
      max-width: 90%;
      text-align: center;
    }

    .brightness-tip span.icon {
      font-size: 13px;
    }

    .contact-meta {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-top: 16px;
      border-top: 1px solid var(--border-subtle);
    }

    .contact-meta-left {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .contact-meta-left strong {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-main);
      letter-spacing: 0.01em;
    }

    .contact-meta-left .hint {
      font-size: 12px;
      color: var(--text-muted);
    }

    .sync-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .sync-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
    }

    .btn-ghost {
      border-radius: 8px;
      padding: 8px 12px;
      border: 1px solid var(--border-medium);
      background: #ffffff;
      color: var(--text-main);
      font-size: 12px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    .btn-ghost:hover {
      background: #f9fafb;
      border-color: var(--accent);
    }

    .btn-ghost span.icon {
      font-size: 14px;
    }

    /* ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  */
    .form-root {
      display: none;
      flex-direction: column;
      gap: 16px;
      margin-top: 8px;
    }

    .form-root.active {
      display: flex;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .field-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-main);
      letter-spacing: 0.01em;
    }

    .field-row {
      display: flex;
      gap: 12px;
    }

    .field-row > div {
      flex: 1;
    }

    .input-shell {
      position: relative;
    }

    .input-shell input,
    .input-shell textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border-medium);
      background: #ffffff;
      color: var(--text-main);
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .input-shell input::placeholder,
    .input-shell textarea::placeholder {
      color: #9ca3af;
    }

    .input-shell input:focus,
    .input-shell textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    textarea {
      min-height: 52px;
      resize: vertical;
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
    }

    .footer-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      gap: 12px;
    }

    .btn-primary {
      flex: 1;
      border-radius: 10px;
      padding: 12px 16px;
      border: none;
      background: var(--accent);
      color: white;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.01em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      box-shadow: var(--shadow-md);
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      background: #1d4ed8;
      box-shadow: var(--shadow-lg);
    }

    .btn-primary span.icon {
      font-size: 16px;
    }

    .btn-secondary {
      border-radius: 10px;
      padding: 10px 14px;
      border: 1px solid var(--border-medium);
      background: #ffffff;
      color: var(--text-main);
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    .btn-secondary:hover {
      background: #fef2f2;
      border-color: var(--danger);
      color: var(--danger);
    }

    .danger-text {
      color: var(--danger);
    }

    .badge-offline {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      padding: 6px 12px;
      border-radius: 8px;
      background: #ffffff;
      border: 1px solid var(--border-medium);
      box-shadow: var(--shadow-sm);
    }

    .badge-offline .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
    }

    .dot-online {
      background: #22c55e;
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
    }

    .dot-offline {
      background: #f97373;
      box-shadow: 0 0 0 2px rgba(248, 113, 113, 0.2);
    }

    .small-print {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
      line-height: 1.5;
    }

    .photo-upload-area {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .photo-upload-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid var(--border-medium);
      background: #ffffff;
      color: var(--text-main);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    .photo-upload-label:hover {
      background: #f9fafb;
      border-color: var(--accent);
    }

    .photo-upload-label input[type="file"] {
      display: none;
    }

    /* Profile Selector */
    .profile-selector {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .profile-dropdown {
      position: relative;
    }

    .profile-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 12px;
      border-radius: 8px;
      border: 1px solid var(--border-medium);
      background: var(--bg-elevated);
      color: var(--text-main);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    .profile-btn:hover {
      background: var(--accent-soft);
      border-color: var(--accent);
    }

    .profile-menu {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      min-width: 220px;
      max-height: 300px;
      overflow-y: auto;
      background: var(--bg-elevated);
      border: 1px solid var(--border-medium);
      border-radius: 10px;
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      display: none;
    }

    .profile-menu.active {
      display: block;
    }

    .profile-menu-item {
      padding: 10px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s ease;
      border-bottom: 1px solid var(--border-subtle);
    }

    .profile-menu-item:last-child {
      border-bottom: none;
    }

    .profile-menu-item:hover {
      background: var(--accent-soft);
    }

    .profile-menu-item.active {
      background: var(--accent-soft);
      font-weight: 600;
    }

    .profile-menu-item .profile-name {
      flex: 1;
      font-size: 13px;
    }

    .profile-menu-item .profile-actions {
      display: flex;
      gap: 4px;
    }

    .profile-action-btn {
      padding: 2px 6px;
      font-size: 11px;
      border: none;
      background: transparent;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s ease;
    }

    .profile-action-btn:hover {
      background: var(--border-medium);
    }

    .profile-menu-divider {
      height: 1px;
      background: var(--border-medium);
      margin: 4px 0;
    }

    /* Onboarding */
    .onboarding-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      backdrop-filter: blur(4px);
    }

    .onboarding-overlay.active {
      display: flex;
    }

    .onboarding-card {
      background: var(--bg-elevated);
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      width: 100%;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-medium);
    }

    .onboarding-header {
      text-align: center;
      margin-bottom: 24px;
    }

    .onboarding-header h2 {
      font-size: 24px;
      margin: 0 0 8px 0;
      color: var(--text-main);
    }

    .onboarding-header p {
      font-size: 14px;
      color: var(--text-muted);
      margin: 0;
    }

    .onboarding-steps {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 24px;
    }

    .onboarding-step {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .onboarding-step-number {
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--accent);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }

    .onboarding-step-content h3 {
      margin: 0 0 4px 0;
      font-size: 15px;
      color: var(--text-main);
    }

    .onboarding-step-content p {
      margin: 0;
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .onboarding-footer {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .onboarding-btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }

    .onboarding-btn-primary {
      background: var(--accent);
      color: white;
      box-shadow: var(--shadow-md);
    }

    .onboarding-btn-primary:hover {
      background: var(--accent-strong);
      box-shadow: var(--shadow-lg);
    }

    .onboarding-btn-secondary {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border-medium);
    }

    .onboarding-btn-secondary:hover {
      background: var(--accent-soft);
      color: var(--text-main);
    }

    @media (min-width: 768px) {
      .app-root {
        padding-top: 32px;
        padding-bottom: 36px;
      }

      .qr-shell {
        min-height: 320px;
        max-height: 380px;
      }
    }
  </style>
</head>
<body>
  <div class="app-root">
    <header>
      <div class="brand">
        <div class="brand-mark" aria-hidden="true">
          <span>Me</span>
        </div>
        <div>
          <div class="brand-text-main">MeQR</div>
          <div class="brand-text-sub">DIGITAL BUSINESS CARD</div>
        </div>
      </div>
      <div style="display: flex; gap: 8px; align-items: center;">
        <div class="profile-selector">
          <div class="profile-dropdown">
            <button id="btn-profile-toggle" class="profile-btn" type="button" title="ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åˆ‡ã‚Šæ›¿ãˆ">
              <span>ğŸ“‹</span>
              <span id="current-profile-name">ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«</span>
              <span>â–¾</span>
            </button>
            <div id="profile-menu" class="profile-menu">
              <!-- Profiles will be dynamically inserted here -->
            </div>
          </div>
        </div>
        <button id="btn-theme-toggle" class="btn-ghost" type="button" title="ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ">
          <span class="icon" id="themeIcon">ğŸŒ™</span>
        </button>
        <div class="mode-toggle" role="tablist" aria-label="ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">
          <button id="btn-view-mode" class="active" role="tab" aria-selected="true">
            <span class="icon">ğŸ“‡</span><span>è¡¨ç¤º</span>
          </button>
          <button id="btn-edit-mode" role="tab" aria-selected="false">
            <span class="icon">âš™ï¸</span><span>ç·¨é›†</span>
          </button>
        </div>
      </div>
    </header>

    <main>
      <section class="card" aria-label="ãƒ‡ã‚¸ã‚¿ãƒ«ååˆº">
        <div class="card-header">
          <div class="photo-area">
            <img id="displayPhoto" alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸ" />
            <div class="photo-placeholder" id="photoPlaceholder">ğŸ‘¤</div>
          </div>
          <div class="id-block">
            <div class="name-main" id="displayName">ã‚ãªãŸã®åå‰</div>
            <div class="name-sub" id="displayOrgRole">çµ„ç¹” / å½¹è·</div>
            <div class="meta-chips">
              <span class="chip chip-strong">vCard 3.0</span>
              <span class="chip">LOCAL ONLY</span>
            </div>
          </div>
        </div>

        <div class="qr-shell" aria-label="é€£çµ¡å…ˆQRã‚³ãƒ¼ãƒ‰">
          <div class="qr-inner">
            <div id="qrcode"></div>
          </div>
          <div class="brightness-tip">
            <span class="icon">ğŸ”†</span>
            <span>QRã‚¹ã‚­ãƒ£ãƒ³æ™‚ã¯ç”»é¢è¼åº¦ã‚’æœ€å¤§ã«ã™ã‚‹ã¨èª­ã¿å–ã‚Šç²¾åº¦ãŒä¸ŠãŒã‚Šã¾ã™ã€‚</span>
          </div>
        </div>

        <div class="contact-meta">
          <div class="contact-meta-left">
            <strong id="displayPhoneEmail">é›»è©± / ãƒ¡ãƒ¼ãƒ«</strong>
            <span id="displayUrl" class="hint">URLï¼ˆãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ»SNSãªã©ï¼‰</span>
          </div>
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap: wrap;">
            <div class="sync-indicator">
              <span class="sync-dot"></span>
              <span id="syncStatusLabel">ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜æ¸ˆã¿</span>
            </div>
            <div style="display:flex; gap:8px; flex-wrap: wrap;">
              <button id="btn-share-vcard" class="btn-ghost" type="button" title="é€£çµ¡å…ˆã‚’å…±æœ‰">
                <span class="icon">ğŸ“¤</span>
                <span>å…±æœ‰</span>
              </button>
              <button id="btn-download-qr" class="btn-ghost" type="button" title="QRã‚³ãƒ¼ãƒ‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
                <span class="icon">â¬‡ï¸</span>
                <span>QRä¿å­˜</span>
              </button>
              <button id="btn-export-vcard" class="btn-ghost" type="button" title="vCardãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
                <span class="icon">ğŸ’¾</span>
                <span>.vcf</span>
              </button>
              <button id="btn-preview-vcard" class="btn-ghost" type="button" title="vCardå†…å®¹ã‚’ç¢ºèª">
                <span class="icon">ğŸ”</span>
                <span>ç¢ºèª</span>
              </button>
            </div>
          </div>
        </div>

        <section class="form-root" id="editFormSection" aria-label="é€£çµ¡å…ˆç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ">
          <div class="field-group photo-upload-area">
            <div class="field-label">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸ</div>
            <label class="photo-upload-label">
              <span class="icon">ğŸ“·</span>
              <span>å†™çœŸã‚’é¸æŠï¼ˆä»»æ„ï¼‰</span>
              <input id="photoUpload" type="file" accept="image/jpeg,image/png,image/webp">
            </label>
            <div class="hint">å†™çœŸã®ã‚µã‚¤ã‚ºã¯200KBä»¥ä¸‹ã‚’æ¨å¥¨ï¼ˆå¤§ãã„ã¨QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã«å½±éŸ¿ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰</div>
          </div>

          <div class="field-group">
            <div class="field-row">
              <div>
                <div class="field-label">å§“ / LAST NAME</div>
                <div class="input-shell">
                  <input id="lastName" type="text" autocomplete="family-name" placeholder="å±±ç”°" maxlength="20">
                </div>
              </div>
              <div>
                <div class="field-label">å / FIRST NAME</div>
                <div class="input-shell">
                  <input id="firstName" type="text" autocomplete="given-name" placeholder="å¤ªéƒ" maxlength="20">
                </div>
              </div>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">é€£çµ¡å…ˆ / CONTACT</div>
            <div class="input-shell">
              <input id="phone" type="tel" inputmode="tel" autocomplete="tel" placeholder="090-1234-5678" maxlength="20">
            </div>
            <div class="hint">æºå¸¯ç•ªå·ï¼ˆãƒã‚¤ãƒ•ãƒ³ã‚ã‚Šã§ã‚‚å¯ï¼‰</div>
          </div>

          <div class="field-group">
            <div class="field-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ / EMAIL</div>
            <div class="input-shell">
              <input id="email" type="email" inputmode="email" autocomplete="email" placeholder="example@example.com" maxlength="60">
            </div>
          </div>

          <div class="field-group">
            <div class="field-row">
              <div>
                <div class="field-label">ä¼šç¤¾å / ORGANIZATION</div>
                <div class="input-shell">
                  <input id="org" type="text" autocomplete="organization" placeholder="æ ªå¼ä¼šç¤¾ã€‡ã€‡" maxlength="40">
                </div>
              </div>
              <div>
                <div class="field-label">å½¹è· / TITLE</div>
                <div class="input-shell">
                  <input id="title" type="text" autocomplete="organization-title" placeholder="å–¶æ¥­éƒ¨é•·" maxlength="30">
                </div>
              </div>
            </div>
          </div>

          <div class="field-group">
            <div class="field-label">URL / WEBSITE</div>
            <div class="input-shell">
              <input id="url" type="url" inputmode="url" autocomplete="url" placeholder="https://example.com" maxlength="80">
            </div>
            <div class="hint">ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã€SNSã€ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãªã©</div>
          </div>

          <div class="footer-actions">
            <button id="btn-clear" type="button" class="btn-secondary">
              <span class="icon">ğŸ§¹</span>
              <span>ãƒ­ãƒ¼ã‚«ãƒ«æƒ…å ±ã‚’å‰Šé™¤</span>
            </button>
            <button id="btn-save" type="button" class="btn-primary">
              <span class="icon">ğŸ’¾</span>
              <span>ä¿å­˜ã—ã¦QRã‚’æ›´æ–°</span>
            </button>
          </div>

          <div class="small-print">
            ã“ã®ã‚¢ãƒ—ãƒªã¯ã‚µãƒ¼ãƒãƒ¼ã«ä¸€åˆ‡ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã›ãšã€<strong>ãƒ–ãƒ©ã‚¦ã‚¶ã® localStorage ã®ã¿</strong>ã«ä¿å­˜ã—ã¾ã™ã€‚
          </div>
        </section>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
          <div class="badge-offline" id="offlineBadge">
            <span class="dot dot-offline" id="offlineDot"></span>
            <span id="offlineText">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æœªå¯¾å¿œï¼ˆåˆå›èª­ã¿è¾¼ã¿ä¸­ï¼‰</span>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Onboarding Overlay -->
  <div id="onboarding-overlay" class="onboarding-overlay">
    <div class="onboarding-card">
      <div class="onboarding-header">
        <h2>MeQRã¸ã‚ˆã†ã“ãï¼ğŸ‘‹</h2>
        <p>ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼é‡è¦–ã®ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‡ã‚¸ã‚¿ãƒ«ååˆºã‚¢ãƒ—ãƒª</p>
      </div>
      <div class="onboarding-steps">
        <div class="onboarding-step">
          <div class="onboarding-step-number">1</div>
          <div class="onboarding-step-content">
            <h3>é€£çµ¡å…ˆã‚’å…¥åŠ›</h3>
            <p>ã€Œç·¨é›†ã€ã‚¿ãƒ–ã§åå‰ãƒ»é›»è©±ãƒ»ãƒ¡ãƒ¼ãƒ«ãªã©ã‚’å…¥åŠ›ã—ã¦ä¿å­˜</p>
          </div>
        </div>
        <div class="onboarding-step">
          <div class="onboarding-step-number">2</div>
          <div class="onboarding-step-content">
            <h3>QRã‚³ãƒ¼ãƒ‰ã§å…±æœ‰</h3>
            <p>ç›¸æ‰‹ã«QRã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã›ã¦ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã‚‚ã‚‰ã†ã ã‘ï¼</p>
          </div>
        </div>
        <div class="onboarding-step">
          <div class="onboarding-step-number">3</div>
          <div class="onboarding-step-content">
            <h3>è¤‡æ•°ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«</h3>
            <p>ãƒ“ã‚¸ãƒã‚¹ç”¨ãƒ»ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆç”¨ãªã©ã€ç”¨é€”ã«å¿œã˜ã¦ä½¿ã„åˆ†ã‘å¯èƒ½</p>
          </div>
        </div>
        <div class="onboarding-step">
          <div class="onboarding-step-number">4</div>
          <div class="onboarding-step-content">
            <h3>å®Œå…¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·</h3>
            <p>ãƒ‡ãƒ¼ã‚¿ã¯å…¨ã¦ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã€‚ã‚µãƒ¼ãƒãƒ¼ã«ã¯ä¸€åˆ‡é€ä¿¡ã•ã‚Œã¾ã›ã‚“</p>
          </div>
        </div>
      </div>
      <div class="onboarding-footer">
        <button id="btn-onboarding-skip" class="onboarding-btn onboarding-btn-secondary">ã‚¹ã‚­ãƒƒãƒ—</button>
        <button id="btn-onboarding-start" class="onboarding-btn onboarding-btn-primary">ä½¿ã£ã¦ã¿ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆqrcode-generatorï¼‰ -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"
    referrerpolicy="no-referrer">
  </script>
  <script>
    (function () {
      "use strict";

      const PROFILES_KEY = "meqr_profiles_v3";
      const CURRENT_PROFILE_KEY = "meqr_current_profile";
      const THEME_KEY = "meqr_theme";
      const ONBOARDING_KEY = "meqr_onboarding_completed";

      /** @type {ReturnType<typeof createQRCodeInstance> | null} */
      let qrInstance = null;
      let currentProfileId = null;

      function createQRCodeInstance() {
        const qrContainer = document.getElementById("qrcode");
        qrContainer.innerHTML = "";
        // Ensure UTF-8 encoding for non-ASCII names.
        if (globalThis.qrcode && globalThis.qrcode.stringToBytesFuncs && globalThis.qrcode.stringToBytesFuncs["UTF-8"]) {
          globalThis.qrcode.stringToBytes = globalThis.qrcode.stringToBytesFuncs["UTF-8"];
        }

        return {
          clear() {
            qrContainer.innerHTML = "";
          },
          makeCode(text) {
            if (typeof globalThis.qrcode !== "function") {
              throw new Error("QR library (qrcode-generator) is not loaded.");
            }

            const qr = globalThis.qrcode(0, "L");
            qr.addData(String(text || ""), "Byte");
            qr.make();

            // Use CSS variables for QR colors
            const DARK = getComputedStyle(document.documentElement).getPropertyValue('--qr-dark').trim();
            const LIGHT = getComputedStyle(document.documentElement).getPropertyValue('--qr-light').trim();

            let svg = qr.createSvgTag({ cellSize: 4, margin: 1, scalable: true });
            // Replace default black/white colors to match UI.
            svg = svg
              .replace(/fill=\"white\"/g, `fill=\"${LIGHT}\"`)
              .replace(/fill=\"black\"/g, `fill=\"${DARK}\"`);

            qrContainer.innerHTML = svg;
            const svgEl = qrContainer.querySelector("svg");
            if (svgEl) {
              svgEl.setAttribute("width", "100%");
              svgEl.setAttribute("height", "100%");
              svgEl.setAttribute("preserveAspectRatio", "xMidYMid meet");
            }
          }
        };
      }

      function normalizePhone(phone) {
        if (!phone) return "";
        return phone.replace(/[^\d+]/g, "");
      }

      function escapeVCardValue(value) {
        if (!value) return "";
        return String(value)
          .replace(/\\/g, "\\\\")
          .replace(/\n/g, "\\n")
          .replace(/,/g, "\\,")
          .replace(/;/g, "\\;");
      }

      function buildVCard(data) {
        const ln = (line) => line + "\r\n";
        const lastName = data.lastName || "";
        const firstName = data.firstName || "";
        const phone = normalizePhone(data.phone || "");
        const email = data.email || "";
        const org = data.org || "";
        const title = data.title || "";
        const url = data.url || "";

        const fullName = (lastName + " " + firstName).trim() || "My Contact";

        let v = "";
        v += ln("BEGIN:VCARD");
        v += ln("VERSION:3.0");
        v += ln("N:" + escapeVCardValue(lastName) + ";" + escapeVCardValue(firstName) + ";;;");
        v += ln("FN:" + escapeVCardValue(fullName));

        if (org) {
          v += ln("ORG:" + escapeVCardValue(org));
        }

        if (title) {
          v += ln("TITLE:" + escapeVCardValue(title));
        }

        if (phone) {
          v += ln("TEL;TYPE=CELL,VOICE:" + escapeVCardValue(phone));
        }

        if (email) {
          v += ln("EMAIL;TYPE=INTERNET:" + escapeVCardValue(email));
        }

        if (url) {
          v += ln("URL:" + escapeVCardValue(url));
        }

        v += ln("END:VCARD");
        return v;
      }

      // === Profile Management Functions ===
      
      function getAllProfiles() {
        try {
          const raw = localStorage.getItem(PROFILES_KEY);
          if (!raw) return [];
          return JSON.parse(raw);
        } catch (e) {
          console.error("Failed to load profiles", e);
          return [];
        }
      }

      function saveAllProfiles(profiles) {
        try {
          localStorage.setItem(PROFILES_KEY, JSON.stringify(profiles));
        } catch (e) {
          console.error("Failed to save profiles", e);
          alert("ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
      }

      function getCurrentProfileId() {
        if (currentProfileId) return currentProfileId;
        const saved = localStorage.getItem(CURRENT_PROFILE_KEY);
        return saved || null;
      }

      function setCurrentProfileId(id) {
        currentProfileId = id;
        localStorage.setItem(CURRENT_PROFILE_KEY, id);
      }

      function createNewProfile(name = "æ–°ã—ã„ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«") {
        const profiles = getAllProfiles();
        const newProfile = {
          id: Date.now().toString(),
          name: name,
          data: {
            lastName: "",
            firstName: "",
            phone: "",
            email: "",
            org: "",
            title: "",
            url: "",
            photo: ""
          },
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        profiles.push(newProfile);
        saveAllProfiles(profiles);
        return newProfile;
      }

      function loadCurrentProfile() {
        const profiles = getAllProfiles();
        if (profiles.length === 0) {
          // Create default profile
          const defaultProfile = createNewProfile("ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«");
          setCurrentProfileId(defaultProfile.id);
          setSyncStatus("empty");
          return defaultProfile.data;
        }

        let profileId = getCurrentProfileId();
        let profile = profiles.find(p => p.id === profileId);
        
        if (!profile) {
          profile = profiles[0];
          setCurrentProfileId(profile.id);
        }

        setSyncStatus("saved");
        return profile.data;
      }

      function saveCurrentProfile(data) {
        const profiles = getAllProfiles();
        const profileId = getCurrentProfileId();
        
        const profileIndex = profiles.findIndex(p => p.id === profileId);
        if (profileIndex === -1) {
          console.error("Current profile not found");
          return;
        }

        profiles[profileIndex].data = data;
        profiles[profileIndex].updatedAt = new Date().toISOString();
        saveAllProfiles(profiles);
        setSyncStatus("saved");
      }

      function switchProfile(profileId) {
        const profiles = getAllProfiles();
        const profile = profiles.find(p => p.id === profileId);
        if (!profile) {
          alert("ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
          return;
        }

        setCurrentProfileId(profileId);
        fillDisplay(profile.data);
        fillForm(profile.data);
        regenerateQR(profile.data);
        updateProfileSelector();
      }

      function deleteProfile(profileId) {
        const profiles = getAllProfiles();
        if (profiles.length <= 1) {
          alert("æœ€å¾Œã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚");
          return;
        }

        const index = profiles.findIndex(p => p.id === profileId);
        if (index === -1) return;

        const confirmDelete = confirm(`ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${profiles[index].name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`);
        if (!confirmDelete) return;

        profiles.splice(index, 1);
        saveAllProfiles(profiles);

        // Switch to first profile if current was deleted
        if (profileId === getCurrentProfileId()) {
          switchProfile(profiles[0].id);
        }

        updateProfileSelector();
      }

      function renameProfile(profileId, newName) {
        const profiles = getAllProfiles();
        const profile = profiles.find(p => p.id === profileId);
        if (!profile) return;

        profile.name = newName;
        profile.updatedAt = new Date().toISOString();
        saveAllProfiles(profiles);
        updateProfileSelector();
      }

      // Legacy compatibility: migrate old data
      function migrateOldData() {
        const OLD_KEY = "meqr_contact_v2";
        const oldData = localStorage.getItem(OLD_KEY);
        if (!oldData) return;

        try {
          const parsed = JSON.parse(oldData);
          const profiles = getAllProfiles();
          if (profiles.length === 0) {
            const migratedProfile = createNewProfile("ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«");
            migratedProfile.data = parsed;
            saveAllProfiles([migratedProfile]);
            setCurrentProfileId(migratedProfile.id);
          }
          localStorage.removeItem(OLD_KEY);
        } catch (e) {
          console.error("Migration failed", e);
        }
      }

      function setSyncStatus(state) {
        const label = document.getElementById("syncStatusLabel");
        if (!label) return;
        switch (state) {
          case "saved":
            label.textContent = "ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜æ¸ˆã¿";
            break;
          case "empty":
            label.textContent = "æœªè¨­å®šï¼ˆç·¨é›†ã‹ã‚‰ç™»éŒ²ï¼‰";
            break;
          case "error":
            label.textContent = "ä¿å­˜ã‚¨ãƒ©ãƒ¼";
            break;
          default:
            label.textContent = "";
        }
      }

      function fillDisplay(data) {
        const displayName = document.getElementById("displayName");
        const displayOrgRole = document.getElementById("displayOrgRole");
        const displayPhoneEmail = document.getElementById("displayPhoneEmail");
        const displayUrl = document.getElementById("displayUrl");
        const displayPhoto = document.getElementById("displayPhoto");
        const photoPlaceholder = document.getElementById("photoPlaceholder");
        
        const lastName = data.lastName || "";
        const firstName = data.firstName || "";
        const phone = data.phone || "";
        const email = data.email || "";
        const org = data.org || "";
        const title = data.title || "";
        const url = data.url || "";
        const photo = data.photo || "";

        displayName.textContent = (lastName + " " + firstName).trim() || "ã‚ãªãŸã®åå‰";

        const orgRoleParts = [];
        if (org) orgRoleParts.push(org);
        if (title) orgRoleParts.push(title);
        displayOrgRole.textContent = orgRoleParts.join(" / ") || "çµ„ç¹” / å½¹è·";

        const contactParts = [];
        if (phone) contactParts.push(phone);
        if (email) contactParts.push(email);
        displayPhoneEmail.textContent = contactParts.join(" / ") || "é›»è©± / ãƒ¡ãƒ¼ãƒ«";

        displayUrl.textContent = url || "URLï¼ˆãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒ»SNSãªã©ï¼‰";

        // Display photo
        if (photo && displayPhoto && photoPlaceholder) {
          displayPhoto.src = photo;
          displayPhoto.style.display = "block";
          photoPlaceholder.style.display = "none";
        } else if (displayPhoto && photoPlaceholder) {
          displayPhoto.src = "";
          displayPhoto.style.display = "none";
          photoPlaceholder.style.display = "flex";
        }
      }

      function fillForm(data) {
        document.getElementById("lastName").value = data.lastName || "";
        document.getElementById("firstName").value = data.firstName || "";
        document.getElementById("phone").value = data.phone || "";
        document.getElementById("email").value = data.email || "";
        document.getElementById("org").value = data.org || "";
        document.getElementById("title").value = data.title || "";
        document.getElementById("url").value = data.url || "";
      }

      function readForm() {
        const photoFile = document.getElementById("photoUpload").files[0];
        const currentData = loadFromLocalStorage() || {};
        
        return {
          lastName: document.getElementById("lastName").value.trim(),
          firstName: document.getElementById("firstName").value.trim(),
          phone: document.getElementById("phone").value.trim(),
          email: document.getElementById("email").value.trim(),
          org: document.getElementById("org").value.trim(),
          title: document.getElementById("title").value.trim(),
          url: document.getElementById("url").value.trim(),
          photo: currentData.photo || ""
        };
      }

      function regenerateQR(data) {
        if (!qrInstance) {
          qrInstance = createQRCodeInstance();
        }
        const vcardText = buildVCard(data);
        qrInstance.clear();
        try {
          // Primary: try vCard
          qrInstance.makeCode(vcardText);
        } catch (err) {
          console.warn("vCard QR generation failed, attempting MECARD fallback:", err);
          // Fallback: use MECARD (shorter) to reduce data size
          try {
              const mecard = buildMECARD(data);
              qrInstance.makeCode(mecard);
            alert("vCard ãŒå¤§ãã™ããŸãŸã‚ã€çŸ­ç¸®å½¢å¼ï¼ˆMECARDï¼‰ã§ QR ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚è¡¨ç¤ºã‚„ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã«ä¸€éƒ¨æƒ…å ±ãŒç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚");
          } catch (err2) {
            console.error("MECARD fallback also failed:", err2);
            alert("QR ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚å…¥åŠ›å†…å®¹ã‚’çŸ­ãã—ã¦ãã ã•ã„ã€‚");
          }
        }
      }

      function buildMECARD(data) {
        // MECARD is more compact than full vCard and widely supported by scanners
        const escape = (s) => (s || "").replace(/[:;\\,]/g, "\\$&");
        const fullName = ((data.lastName || "") + " " + (data.firstName || "")).trim();
        const parts = [];
        if (fullName) parts.push("N:" + escape(fullName));
        if (data.org) parts.push("ORG:" + escape(data.org));
        if (data.phone) parts.push("TEL:" + escape(normalizePhone(data.phone)));
        if (data.email) parts.push("EMAIL:" + escape(data.email));
        if (data.url) parts.push("URL:" + escape(data.url));
        // MECARD format: MECARD:...;;
        return "MECARD:" + parts.join(";") + ";;";
      }

      function switchMode(mode) {
        const isView = mode === "view";
        const viewBtn = document.getElementById("btn-view-mode");
        const editBtn = document.getElementById("btn-edit-mode");
        const formSection = document.getElementById("editFormSection");

        if (isView) {
          viewBtn.classList.add("active");
          viewBtn.setAttribute("aria-selected", "true");
          editBtn.classList.remove("active");
          editBtn.setAttribute("aria-selected", "false");
          formSection.classList.remove("active");
        } else {
          viewBtn.classList.remove("active");
          viewBtn.setAttribute("aria-selected", "false");
          editBtn.classList.add("active");
          editBtn.setAttribute("aria-selected", "true");
          formSection.classList.add("active");
        }
      }

      function setupOfflineBadge() {
        const offlineBadge = document.getElementById("offlineBadge");
        const offlineDot = document.getElementById("offlineDot");
        const offlineText = document.getElementById("offlineText");

        function setStatus(ready) {
          if (ready) {
            offlineDot.classList.remove("dot-offline");
            offlineDot.classList.add("dot-online");
            offlineText.textContent = "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³èµ·å‹•å¯¾å¿œæ¸ˆã¿";
          } else {
            offlineDot.classList.remove("dot-online");
            offlineDot.classList.add("dot-offline");
            offlineText.textContent = "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æœªå¯¾å¿œï¼ˆåˆå›èª­ã¿è¾¼ã¿ä¸­ï¼‰";
          }
        }

        if (!("serviceWorker" in navigator)) {
          offlineText.textContent = "ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ PWA ã«æœªå¯¾å¿œã§ã™";
          return;
        }

        setStatus(false);

        navigator.serviceWorker.ready
          .then(() => setStatus(true))
          .catch(() => setStatus(false));
      }

      function previewVCard(data) {
        const vcard = buildVCard(data);
        const pretty = vcard.replace(/\r\n/g, "\n");
        alert("ç¾åœ¨ã® vCard æ–‡å­—åˆ—ï¼ˆUTF-8ï¼‰:\n\n" + pretty);
      }

      function exportVCard(data) {
        const vcard = buildVCard(data);
        const blob = new Blob([vcard], { type: "text/vcard;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        
        const lastName = data.lastName || "contact";
        const firstName = data.firstName || "";
        const filename = `${lastName}_${firstName}`.trim().replace(/\s+/g, "_") + ".vcf";
        
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      async function shareVCard(data) {
        const vcard = buildVCard(data);
        const blob = new Blob([vcard], { type: "text/vcard;charset=utf-8" });
        
        const lastName = data.lastName || "contact";
        const firstName = data.firstName || "";
        const filename = `${lastName}_${firstName}`.trim().replace(/\s+/g, "_") + ".vcf";
        
        const file = new File([blob], filename, { type: "text/vcard" });

        // Check if Web Share API is supported
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          try {
            await navigator.share({
              title: 'é€£çµ¡å…ˆã‚’å…±æœ‰',
              text: `${lastName} ${firstName}ã®é€£çµ¡å…ˆ`,
              files: [file]
            });
          } catch (err) {
            if (err.name !== 'AbortError') {
              console.error('Share failed:', err);
              alert('å…±æœ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä»£ã‚ã‚Šã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚');
              exportVCard(data);
            }
          }
        } else {
          // Fallback: download the file
          alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å…±æœ‰æ©Ÿèƒ½ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚');
          exportVCard(data);
        }
      }

      function downloadQRCodeAsSVG(data) {
        const qrSvg = document.querySelector('#qrcode svg');
        if (!qrSvg) {
          alert('QRã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
          return;
        }

        // Clone SVG to avoid modifying the displayed one
        const svgClone = qrSvg.cloneNode(true);
        
        // Set explicit dimensions for better compatibility
        svgClone.setAttribute('width', '512');
        svgClone.setAttribute('height', '512');
        
        const svgData = new XMLSerializer().serializeToString(svgClone);
        const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        const lastName = data.lastName || "contact";
        const firstName = data.firstName || "";
        const filename = `${lastName}_${firstName}_QR`.trim().replace(/\s+/g, "_") + ".svg";
        
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function downloadQRCodeAsPNG(data) {
        const qrSvg = document.querySelector('#qrcode svg');
        if (!qrSvg) {
          alert('QRã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
          return;
        }

        // Create a canvas to convert SVG to PNG
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const size = 1024; // High resolution for printing
        canvas.width = size;
        canvas.height = size;

        // Create an image from SVG
        const svgClone = qrSvg.cloneNode(true);
        svgClone.setAttribute('width', size);
        svgClone.setAttribute('height', size);
        
        const svgData = new XMLSerializer().serializeToString(svgClone);
        const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(svgBlob);
        
        const img = new Image();
        img.onload = function() {
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, size, size);
          ctx.drawImage(img, 0, 0, size, size);
          
          canvas.toBlob(function(blob) {
            const pngUrl = URL.createObjectURL(blob);
            
            const lastName = data.lastName || "contact";
            const firstName = data.firstName || "";
            const filename = `${lastName}_${firstName}_QR`.trim().replace(/\s+/g, "_") + ".png";
            
            const a = document.createElement('a');
            a.href = pngUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(pngUrl);
            URL.revokeObjectURL(url);
          }, 'image/png');
        };
        img.onerror = function() {
          alert('QRã‚³ãƒ¼ãƒ‰ã®ç”»åƒå¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          URL.revokeObjectURL(url);
        };
        img.src = url;
      }

      function downloadQRCode(data) {
        // Show format selection
        const format = confirm('QRã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜ã—ã¾ã™ã€‚\n\nOK = PNGå½¢å¼ï¼ˆå°åˆ·ç”¨ãƒ»é«˜è§£åƒåº¦ï¼‰\nã‚­ãƒ£ãƒ³ã‚»ãƒ« = SVGå½¢å¼ï¼ˆç·¨é›†å¯èƒ½ãƒ»è»½é‡ï¼‰');
        
        if (format) {
          downloadQRCodeAsPNG(data);
        } else {
          downloadQRCodeAsSVG(data);
        }
      }

      function initTheme() {
        const savedTheme = localStorage.getItem(THEME_KEY) || "light";
        applyTheme(savedTheme);
      }

      function applyTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem(THEME_KEY, theme);
        
        const themeIcon = document.getElementById("themeIcon");
        const themeColorMeta = document.getElementById("themeColorMeta");
        
        if (themeIcon) {
          themeIcon.textContent = theme === "dark" ? "â˜€ï¸" : "ğŸŒ™";
        }
        
        if (themeColorMeta) {
          themeColorMeta.setAttribute("content", theme === "dark" ? "#1e293b" : "#2563eb");
        }
        
        // Regenerate QR code with new colors
        const saved = loadFromLocalStorage();
        if (saved && qrInstance) {
          regenerateQR(saved);
        }
      }

      function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute("data-theme") || "light";
        const newTheme = currentTheme === "light" ? "dark" : "light";
        applyTheme(newTheme);
      }

      // === Profile UI Functions ===

      function updateProfileSelector() {
        const profiles = getAllProfiles();
        const currentId = getCurrentProfileId();
        const currentProfile = profiles.find(p => p.id === currentId);
        
        // Update button text
        const profileNameElement = document.getElementById("current-profile-name");
        if (profileNameElement && currentProfile) {
          profileNameElement.textContent = currentProfile.name;
        }

        // Update dropdown menu
        const menu = document.getElementById("profile-menu");
        if (!menu) return;

        menu.innerHTML = '';

        profiles.forEach(profile => {
          const item = document.createElement('div');
          item.className = 'profile-menu-item' + (profile.id === currentId ? ' active' : '');
          
          const name = document.createElement('span');
          name.className = 'profile-name';
          name.textContent = profile.name;
          name.onclick = () => {
            switchProfile(profile.id);
            toggleProfileMenu(false);
          };
          
          const actions = document.createElement('div');
          actions.className = 'profile-actions';
          
          const renameBtn = document.createElement('button');
          renameBtn.className = 'profile-action-btn';
          renameBtn.textContent = 'âœï¸';
          renameBtn.title = 'åå‰ã‚’å¤‰æ›´';
          renameBtn.onclick = (e) => {
            e.stopPropagation();
            const newName = prompt('æ–°ã—ã„ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›:', profile.name);
            if (newName && newName.trim()) {
              renameProfile(profile.id, newName.trim());
            }
          };
          
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'profile-action-btn';
          deleteBtn.textContent = 'ğŸ—‘ï¸';
          deleteBtn.title = 'å‰Šé™¤';
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deleteProfile(profile.id);
          };
          
          actions.appendChild(renameBtn);
          actions.appendChild(deleteBtn);
          
          item.appendChild(name);
          item.appendChild(actions);
          menu.appendChild(item);
        });

        // Add divider
        const divider = document.createElement('div');
        divider.className = 'profile-menu-divider';
        menu.appendChild(divider);

        // Add "New Profile" button
        const newItem = document.createElement('div');
        newItem.className = 'profile-menu-item';
        newItem.innerHTML = '<span class="profile-name">â• æ–°ã—ã„ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«</span>';
        newItem.onclick = () => {
          const name = prompt('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›:', 'æ–°ã—ã„ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«');
          if (name && name.trim()) {
            const newProfile = createNewProfile(name.trim());
            switchProfile(newProfile.id);
          }
          toggleProfileMenu(false);
        };
        menu.appendChild(newItem);
      }

      function toggleProfileMenu(show) {
        const menu = document.getElementById("profile-menu");
        if (!menu) return;
        
        if (show === undefined) {
          menu.classList.toggle('active');
        } else {
          menu.classList.toggle('active', show);
        }
      }

      // === Onboarding Functions ===

      function showOnboarding() {
        const overlay = document.getElementById("onboarding-overlay");
        if (overlay) {
          overlay.classList.add('active');
        }
      }

      function hideOnboarding() {
        const overlay = document.getElementById("onboarding-overlay");
        if (overlay) {
          overlay.classList.remove('active');
        }
        localStorage.setItem(ONBOARDING_KEY, 'true');
      }

      function shouldShowOnboarding() {
        return !localStorage.getItem(ONBOARDING_KEY);
      }

      function onDOMContentLoaded() {
        // Initialize theme first
        initTheme();
        
        // Migrate old data if exists
        migrateOldData();
        
        qrInstance = createQRCodeInstance();

        // Load current profile
        const initialData = loadCurrentProfile();

        fillDisplay(initialData);
        fillForm(initialData);
        regenerateQR(initialData);
        updateProfileSelector();

        // Show onboarding if first time
        if (shouldShowOnboarding()) {
          showOnboarding();
        }

        // Onboarding handlers
        document.getElementById("btn-onboarding-start").addEventListener("click", () => {
          hideOnboarding();
          switchMode("edit");
        });

        document.getElementById("btn-onboarding-skip").addEventListener("click", () => {
          hideOnboarding();
        });

        // Profile selector
        document.getElementById("btn-profile-toggle").addEventListener("click", () => {
          toggleProfileMenu();
        });

        // Close profile menu when clicking outside
        document.addEventListener("click", (e) => {
          const dropdown = document.querySelector(".profile-dropdown");
          if (dropdown && !dropdown.contains(e.target)) {
            toggleProfileMenu(false);
          }
        });

        // Theme toggle
        document.getElementById("btn-theme-toggle").addEventListener("click", () => {
          toggleTheme();
        });

        document.getElementById("btn-view-mode").addEventListener("click", () => {
          switchMode("view");
        });
        document.getElementById("btn-edit-mode").addEventListener("click", () => {
          switchMode("edit");
        });

        (function attachSaveHandler(){
          const btnSave = document.getElementById("btn-save");
          if (!btnSave) {
            console.error("btn-save element not found. Save handler not attached.");
            return;
          }
          console.log("btn-save found, attaching click handler.");
          btnSave.addEventListener("click", () => {
            console.log("btn-save clicked");
            const data = readForm();
            console.log("form data:", data);
            if (!data.lastName && !data.firstName) {
              if (!confirm("å§“ãƒ»åãŒæœªå…¥åŠ›ã§ã™ã€‚ã“ã®ã¾ã¾ QR ã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ")) {
                return;
              }
            }
            saveCurrentProfile(data);
            fillDisplay(data);
            regenerateQR(data);
            switchMode("view");
          });
        })();

        document.getElementById("btn-clear").addEventListener("click", () => {
          const ok = confirm("ç¾åœ¨ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
          if (!ok) return;
          
          const emptyData = {
            lastName: "",
            firstName: "",
            phone: "",
            email: "",
            org: "",
            title: "",
            url: "",
            photo: ""
          };
          
          saveCurrentProfile(emptyData);
          fillDisplay(emptyData);
          fillForm(emptyData);
          regenerateQR(emptyData);
          setSyncStatus("empty");
        });

        document.getElementById("btn-preview-vcard").addEventListener("click", () => {
          const data = loadCurrentProfile() || readForm();
          previewVCard(data);
        });

        document.getElementById("btn-export-vcard").addEventListener("click", () => {
          const data = loadCurrentProfile();
          if (!data || (!data.lastName && !data.firstName)) {
            alert("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹é€£çµ¡å…ˆæƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«åå‰ã‚’å…¥åŠ›ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
            return;
          }
          exportVCard(data);
        });

        document.getElementById("btn-share-vcard").addEventListener("click", async () => {
          const data = loadCurrentProfile();
          if (!data || (!data.lastName && !data.firstName)) {
            alert("å…±æœ‰ã™ã‚‹é€£çµ¡å…ˆæƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«åå‰ã‚’å…¥åŠ›ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
            return;
          }
          await shareVCard(data);
        });

        document.getElementById("btn-download-qr").addEventListener("click", () => {
          const data = loadCurrentProfile();
          if (!data || (!data.lastName && !data.firstName)) {
            alert("QRã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜ã™ã‚‹å‰ã«ã€é€£çµ¡å…ˆæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
            return;
          }
          downloadQRCode(data);
        });

        // Photo upload handler
        document.getElementById("photoUpload").addEventListener("change", function(e) {
          const file = e.target.files[0];
          if (!file) return;

          // Validate file size (max 500KB)
          if (file.size > 500 * 1024) {
            alert("å†™çœŸã®ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚500KBä»¥ä¸‹ã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
            e.target.value = "";
            return;
          }

          // Validate file type
          if (!file.type.match(/^image\/(jpeg|png|webp)$/)) {
            alert("å¯¾å¿œã—ã¦ã„ã‚‹ç”»åƒå½¢å¼ã¯JPEGã€PNGã€WebPã§ã™ã€‚");
            e.target.value = "";
            return;
          }

          const reader = new FileReader();
          reader.onload = function(event) {
            const currentData = loadCurrentProfile() || readForm();
            currentData.photo = event.target.result;
            saveCurrentProfile(currentData);
            fillDisplay(currentData);
          };
          reader.onerror = function() {
            alert("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            e.target.value = "";
          };
          reader.readAsDataURL(file);
        });

        if ("serviceWorker" in navigator) {
          // sw.js ã®æŒ™å‹•ã‚’å¤‰æ›´ã—ãŸã®ã§ã€URLã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä»˜ã‘ã¦æ›´æ–°ã‚’ç¢ºå®ŸåŒ–ã™ã‚‹ã€‚
          navigator.serviceWorker.register("sw.js?v=3")
            .then(reg => {
              console.log("ServiceWorker registered", reg);
              try {
                reg.update();
              } catch (_) {
                // ignore
              }
              setupOfflineBadge();
            })
            .catch(err => {
              console.warn("ServiceWorker registration failed", err);
              setupOfflineBadge();
            });
        } else {
          console.log("ServiceWorker not supported");
          setupOfflineBadge();
        }
      }

      document.addEventListener("DOMContentLoaded", onDOMContentLoaded);
    })();
  </script>
</body>
</html>

